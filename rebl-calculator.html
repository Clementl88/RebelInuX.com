<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="RebelInuX Sustainable Reward Calculator - Calculate $REBL rewards using the new sustainable formula with Gamma Scale Factor" />
  <meta name="keywords" content="RebelInuX calculator, $REBL rewards, epoch calculator, sustainable formula, gamma scale factor" />
  <meta property="og:title" content="RebelInuX Sustainable Reward Calculator" />
  <meta property="og:image" content="images/Logo_REBL.svg" />
  <meta property="og:description" content="Calculate your $REBL rewards using the sustainable formula with Gamma Scale Factor (Î³) simulation" />
  <meta property="og:url" content="https://rebelinux.fun/rebl-calculator.html" />
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="RebelInuX">
  <meta name="twitter:title" content="RebelInuX Sustainable Reward Calculator">
  <meta name="twitter:description" content="Calculate your $REBL rewards using the sustainable formula with Gamma Scale Factor (Î³) simulation">
  <meta name="twitter:card" content="summary_large_image" />
  
  <!-- Favicons -->
  <link rel="icon" href="images/Logo_REBL.svg">
  <link rel="apple-touch-icon" href="images/Logo_REBL.svg">
  <title>RebelInuX Sustainable Reward Calculator</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>

  <!-- CSS Files -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/header-footer.css">
  <link rel="stylesheet" href="css/rebl-calculator.css">

  <!-- Enhanced Calculator Styles -->
  <style>
    /* Professional Color Scheme */
    :root {
      --rebel-primary: #d4a76a;
      --rebel-secondary: #ff3366;
      --rebel-accent: #00aaff;
      --rebel-success: #4CAF50;
      --rebel-warning: #FFC107;
      --rebel-danger: #FF5722;
      --rebel-dark: #0a0a0a;
      --rebel-darker: #050505;
      --rebel-light: #f8f9fa;
      --rebel-gray: #6c757d;
      --rebel-bg: #121212;
      --rebel-card: #1e1e1e;
      --rebel-border: #2a2a2a;
    }
    
    /* Professional Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    @keyframes slideInUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Professional Components */
    .pro-card {
      background: var(--rebel-card);
      border: 1px solid var(--rebel-border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .pro-card:hover {
      border-color: var(--rebel-primary);
      box-shadow: 0 8px 30px rgba(212, 167, 106, 0.2);
      transform: translateY(-2px);
    }
    
    .pro-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .pro-badge-success {
      background: rgba(76, 175, 80, 0.15);
      color: #4CAF50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .pro-badge-warning {
      background: rgba(255, 193, 7, 0.15);
      color: #FFC107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .pro-badge-danger {
      background: rgba(255, 51, 102, 0.15);
      color: #ff3366;
      border: 1px solid rgba(255, 51, 102, 0.3);
    }
    
    .pro-badge-info {
      background: rgba(0, 170, 255, 0.15);
      color: #00aaff;
      border: 1px solid rgba(0, 170, 255, 0.3);
    }
    
    /* Professional Inputs */
    .pro-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--rebel-border);
      border-radius: 8px;
      padding: 12px 16px;
      color: white;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .pro-input:focus {
      outline: none;
      border-color: var(--rebel-primary);
      box-shadow: 0 0 0 3px rgba(212, 167, 106, 0.1);
      background: rgba(255, 255, 255, 0.08);
    }
    
    .pro-input.success {
      border-color: var(--rebel-success);
      background: rgba(76, 175, 80, 0.05);
    }
    
    .pro-input.warning {
      border-color: var(--rebel-warning);
      background: rgba(255, 193, 7, 0.05);
    }
    
    .pro-input.error {
      border-color: var(--rebel-danger);
      background: rgba(255, 87, 34, 0.05);
    }
    
    /* Professional Buttons */
    .pro-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 0.5px;
    }
    
    .pro-btn-primary {
      background: linear-gradient(135deg, var(--rebel-primary), #c89550);
      color: white;
      box-shadow: 0 4px 12px rgba(212, 167, 106, 0.3);
    }
    
    .pro-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 167, 106, 0.4);
      background: linear-gradient(135deg, #d4a76a, #c89550);
    }
    
    .pro-btn-secondary {
      background: rgba(255, 51, 102, 0.1);
      color: var(--rebel-secondary);
      border: 1px solid rgba(255, 51, 102, 0.3);
    }
    
    .pro-btn-secondary:hover {
      background: rgba(255, 51, 102, 0.2);
      transform: translateY(-1px);
      border-color: var(--rebel-secondary);
    }
    
    .pro-btn-outline {
      background: transparent;
      color: var(--rebel-primary);
      border: 1px solid var(--rebel-primary);
    }
    
    .pro-btn-outline:hover {
      background: rgba(212, 167, 106, 0.1);
      transform: translateY(-1px);
    }
    
    /* Professional Table */
    .pro-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--rebel-card);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    .pro-table thead {
      background: linear-gradient(90deg, rgba(212, 167, 106, 0.2), rgba(255, 51, 102, 0.1));
    }
    
    .pro-table th {
      padding: 16px;
      text-align: left;
      color: var(--rebel-primary);
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid rgba(212, 167, 106, 0.3);
    }
    
    .pro-table td {
      padding: 16px;
      border-bottom: 1px solid var(--rebel-border);
      color: rgba(255, 255, 255, 0.9);
    }
    
    .pro-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .pro-table tbody tr:hover {
      background: rgba(212, 167, 106, 0.05);
    }
    
    /* Professional Metric Cards */
    .metric-card {
      background: var(--rebel-card);
      border: 1px solid var(--rebel-border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .metric-card:hover {
      border-color: var(--rebel-primary);
      transform: translateY(-3px);
    }
    
    .metric-label {
      font-size: 13px;
      color: var(--rebel-gray);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .metric-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--rebel-primary);
      line-height: 1;
      margin-bottom: 6px;
    }
    
    .metric-sub {
      font-size: 12px;
      color: var(--rebel-gray);
      font-weight: 500;
    }
    
    .metric-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-top: 6px;
      font-weight: 600;
    }
    
    .metric-change.positive {
      background: rgba(76, 175, 80, 0.15);
      color: #4CAF50;
    }
    
    .metric-change.negative {
      background: rgba(255, 51, 102, 0.15);
      color: #ff3366;
    }
    
    /* Professional Progress Bars */
    .pro-progress {
      height: 8px;
      background: var(--rebel-border);
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }
    
    .pro-progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .pro-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.2) 50%, 
        transparent 100%);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Professional Tabs */
    .pro-tabs {
      display: flex;
      gap: 2px;
      background: var(--rebel-border);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 24px;
    }
    
    .pro-tab {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      color: var(--rebel-gray);
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .pro-tab.active {
      background: var(--rebel-card);
      color: var(--rebel-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .pro-tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }
    
    /* Professional Tooltips */
    .pro-tooltip {
      position: relative;
      display: inline-block;
    }
    
    .pro-tooltip .tooltip-content {
      visibility: hidden;
      width: 280px;
      background: var(--rebel-dark);
      color: white;
      text-align: left;
      border-radius: 8px;
      padding: 16px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      border: 1px solid var(--rebel-border);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      font-size: 13px;
      line-height: 1.5;
      backdrop-filter: blur(10px);
    }
    
    .pro-tooltip .tooltip-content::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 6px;
      border-style: solid;
      border-color: var(--rebel-border) transparent transparent transparent;
    }
    
    .pro-tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }
    
    /* Professional Alert */
    .pro-alert {
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      border-left: 4px solid;
      animation: slideInUp 0.3s ease;
    }
    
    .pro-alert-success {
      background: rgba(76, 175, 80, 0.1);
      border-left-color: #4CAF50;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .pro-alert-warning {
      background: rgba(255, 193, 7, 0.1);
      border-left-color: #FFC107;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .pro-alert-danger {
      background: rgba(255, 51, 102, 0.1);
      border-left-color: #ff3366;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .pro-alert-info {
      background: rgba(0, 170, 255, 0.1);
      border-left-color: #00aaff;
      color: rgba(255, 255, 255, 0.9);
    }
    
    /* Professional Slider */
    .pro-slider-container {
      margin: 24px 0;
    }
    
    .pro-slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .pro-slider-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--rebel-primary);
      min-width: 100px;
      text-align: right;
    }
    
    .pro-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: linear-gradient(90deg, var(--rebel-secondary), var(--rebel-primary));
      border-radius: 3px;
      outline: none;
    }
    
    .pro-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--rebel-primary);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }
    
    .pro-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(212, 167, 106, 0.4);
    }
    
    /* Professional Chart Container */
    .pro-chart-container {
      background: var(--rebel-card);
      border: 1px solid var(--rebel-border);
      border-radius: 12px;
      padding: 24px;
      margin: 32px 0;
      position: relative;
      min-height: 400px;
    }
    
    /* Loading States */
    .pro-loading {
      position: relative;
      pointer-events: none;
    }
    
    .pro-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      border: 3px solid rgba(212, 167, 106, 0.3);
      border-top: 3px solid var(--rebel-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Professional Formula Display */
    .pro-formula {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--rebel-border);
      border-radius: 8px;
      padding: 20px;
      margin: 24px 0;
      font-family: 'Source Code Pro', monospace;
    }
    
    .pro-formula-main {
      font-size: 24px;
      font-weight: 700;
      color: var(--rebel-primary);
      text-align: center;
      margin-bottom: 16px;
    }
    
    .pro-formula-sub {
      font-size: 18px;
      color: var(--rebel-secondary);
      text-align: center;
      margin-bottom: 12px;
    }
    
    .pro-formula-explanation {
      font-size: 14px;
      color: var(--rebel-gray);
      text-align: center;
      line-height: 1.6;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .pro-card {
        padding: 16px;
      }
      
      .metric-value {
        font-size: 24px;
      }
      
      .pro-formula-main {
        font-size: 20px;
      }
      
      .pro-formula-sub {
        font-size: 16px;
      }
      
      .pro-table {
        display: block;
        overflow-x: auto;
      }
    }
    
    @media (max-width: 480px) {
      .pro-btn {
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .metric-value {
        font-size: 20px;
      }
      
      .pro-formula-main {
        font-size: 18px;
      }
      
      .pro-tabs {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Animation -->
  <div class="loader" id="loader">
    <div class="loader-spinner"></div>
  </div>
  
  <!-- Back to Top Button -->
  <div class="back-to-top" id="backToTop">
    <i class="fas fa-arrow-up"></i>
  </div>
  
  <!-- Header will be inserted here by JavaScript -->
  <div id="header-container"></div>
  
  <main>
    <!-- Hero Section -->
    <section class="page-hero page-hero--calculator">
      <div class="container">
        <h1><i class="fas fa-calculator"></i> SUSTAINABLE REWARD CALCULATOR</h1>
        <p class="text-lead">Calculate your $REBL rewards using the professional-grade sustainable formula with Gamma Scale Factor (Î³) simulation</p>
        <div class="hero-buttons">
          <a href="#rebl-calculator" class="pro-btn pro-btn-primary">
            <i class="fas fa-rocket"></i> Start Calculating
          </a>
          <a href="#calculator-faq" class="pro-btn pro-btn-secondary">
            <i class="fas fa-question-circle"></i> FAQ & Help
          </a>
          <a href="epoch-rewards.html" class="pro-btn pro-btn-outline">
            <i class="fas fa-gift"></i> View Epoch Rewards
          </a>
        </div>
      </div>
    </section>

    <!-- Formula Banner -->
    <section id="formula-announcement">
      <div class="container">
        <div class="pro-card">
          <div class="pro-formula">
            <div class="pro-formula-main">Rewardáµ¢ = (WSáµ¢ / âˆ‘WS) Ã— 3,200,000 Ã— Î³</div>
            <div class="pro-formula-sub">Î³ = MAX(0.4, MIN(1, P/(0.5 Ã— CS), CS/âˆ‘WS))</div>
            <div class="pro-formula-explanation">
              <span class="pro-badge pro-badge-success"><i class="fas fa-check-circle"></i> Governance Approved</span>
              <span class="pro-badge pro-badge-info"><i class="fas fa-bolt"></i> Effective Epoch 15</span>
              <span class="pro-badge pro-badge-warning"><i class="fas fa-shield-alt"></i> Treasury Protected</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Calculator -->
    <section id="rebl-calculator">
      <div class="container">
        <!-- Quick Navigation -->
        <div class="pro-tabs">
          <button class="pro-tab active" onclick="switchTab('calculator')">
            <i class="fas fa-calculator"></i> Calculator
          </button>
          <button class="pro-tab" onclick="switchTab('simulator')">
            <i class="fas fa-chart-line"></i> Simulator
          </button>
          <button class="pro-tab" onclick="switchTab('analysis')">
            <i class="fas fa-chart-bar"></i> Analysis
          </button>
          <button class="pro-tab" onclick="switchTab('formula')">
            <i class="fas fa-code"></i> Formula
          </button>
        </div>
        
        <!-- Tab Contents -->
        <div id="tab-contents">
          <!-- Calculator Tab -->
          <div id="tab-calculator" class="tab-content active">
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div class="metric-card">
                <div class="metric-label">Circulating Supply</div>
                <div class="metric-value">499.2M</div>
                <div class="metric-sub">Total $rebelinux tokens</div>
              </div>
              
              <div class="metric-card">
                <div class="metric-label">Weekly Pool</div>
                <div class="metric-value">3.2M</div>
                <div class="metric-sub">$REBL distribution</div>
              </div>
              
              <div class="metric-card">
                <div class="metric-label">Gamma Scale</div>
                <div id="gammaMetric" class="metric-value">0.40</div>
                <div class="metric-sub">Sustainability factor</div>
              </div>
              
              <div class="metric-card">
                <div class="metric-label">Your Position</div>
                <div id="positionMetric" class="metric-value">0</div>
                <div class="metric-sub">Weighted shares</div>
              </div>
            </div>
            
            <!-- Token Batches Section -->
            <div class="pro-card mb-8">
              <div class="flex justify-between items-center mb-6">
                <h3><i class="fas fa-layer-group"></i> Token Batches</h3>
                <div class="flex gap-2">
                  <button onclick="loadExampleCase('starter')" class="pro-badge pro-badge-info">
                    <i class="fas fa-user-graduate"></i> Starter
                  </button>
                  <button onclick="loadExampleCase('investor')" class="pro-badge pro-badge-warning">
                    <i class="fas fa-chart-line"></i> Investor
                  </button>
                  <button onclick="loadExampleCase('whale')" class="pro-badge pro-badge-danger">
                    <i class="fas fa-whale"></i> Whale
                  </button>
                </div>
              </div>
              
              <div class="flex gap-3 mb-6">
                <button onclick="addTokenBatch()" class="pro-btn pro-btn-primary">
                  <i class="fas fa-plus"></i> Add Batch
                </button>
                <button onclick="clearTokenBatches()" class="pro-btn pro-btn-secondary">
                  <i class="fas fa-trash"></i> Clear All
                </button>
                <button onclick="optimizeAgeBonus()" class="pro-btn pro-btn-outline">
                  <i class="fas fa-magic"></i> Optimize
                </button>
              </div>
              
              <div class="overflow-x-auto">
                <table class="pro-table">
                  <thead>
                    <tr>
                      <th>Amount</th>
                      <th>Age (Epochs)</th>
                      <th>Weight Factor</th>
                      <th>Weighted Share</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="token-batches-table">
                    <!-- Rows will be added here -->
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="5" class="text-center py-4">
                        <button onclick="addTokenBatch()" class="pro-btn pro-btn-outline">
                          <i class="fas fa-plus-circle"></i> Add Your First Token Batch
                        </button>
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <div class="mt-6 p-4 bg-gray-900 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                  <div class="text-sm text-gray-400">
                    <i class="fas fa-calculator mr-2"></i> Total Weighted Share Calculation
                  </div>
                  <div id="totalWSInfo" class="text-sm font-medium">0 WS</div>
                </div>
                <div class="pro-progress">
                  <div id="ageBonusProgress" class="pro-progress-bar" style="width: 0%; background: linear-gradient(90deg, #ff3366, #d4a76a);"></div>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                  Age bonus: +<span id="ageBonusPercent">0</span>% | Max potential: 240%
                </div>
              </div>
            </div>
            
            <!-- Participation Settings -->
            <div class="pro-card mb-8">
              <h3 class="mb-6"><i class="fas fa-sliders-h"></i> Participation Settings</h3>
              
              <div class="mb-6">
                <label class="flex items-center gap-3 cursor-pointer select-none">
                  <div class="relative">
                    <input type="checkbox" id="autoUpdateToggle" class="sr-only" checked>
                    <div class="toggle-bg bg-gray-700 border-2 border-gray-600 h-6 w-11 rounded-full"></div>
                    <div class="toggle-dot absolute left-1 top-1 bg-white h-4 w-4 rounded-full transition"></div>
                  </div>
                  <span class="text-sm font-medium">Auto-estimate participation based on your holdings</span>
                </label>
                <p class="text-xs text-gray-500 mt-2 ml-9">
                  <i class="fas fa-info-circle"></i> Smart estimation of community participation based on your token distribution
                </p>
              </div>
              
              <div class="space-y-8">
                <!-- Participating Tokens -->
                <div class="pro-slider-container">
                  <div class="pro-slider-label">
                    <div>
                      <span class="font-semibold">Participating Tokens (P)</span>
                      <span class="pro-tooltip ml-2">
                        <i class="fas fa-question-circle text-gray-500"></i>
                        <div class="tooltip-content">
                          Total tokens actively participating in this epoch. This includes your tokens plus estimated participation from other holders.
                          <div class="mt-2 text-primary">
                            <strong>Formula:</strong> P = Your tokens + Community tokens
                          </div>
                        </div>
                      </span>
                    </div>
                    <div id="participatingValue" class="pro-slider-value">100M</div>
                  </div>
                  <input type="range" id="participatingSlider" class="pro-slider" min="1000000" max="500000000" step="1000000" value="100000000">
                  <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>1M tokens</span>
                    <span id="participationPercent">20%</span>
                    <span>500M tokens</span>
                  </div>
                </div>
                
                <!-- Total Weighted Shares -->
                <div class="pro-slider-container">
                  <div class="pro-slider-label">
                    <div>
                      <span class="font-semibold">Total Weighted Shares (âˆ‘WS)</span>
                      <span class="pro-tooltip ml-2">
                        <i class="fas fa-question-circle text-gray-500"></i>
                        <div class="tooltip-content">
                          Total weighted shares including age bonuses from all participants. Weighted shares = Tokens Ã— (1 + 0.07 Ã— min(Age, 20))
                          <div class="mt-2 text-primary">
                            <strong>Range:</strong> Typically 1.0x to 2.4x participating tokens
                          </div>
                        </div>
                      </span>
                    </div>
                    <div id="totalWSValue" class="pro-slider-value">100M</div>
                  </div>
                  <input type="range" id="totalWSSlider" class="pro-slider" min="1000000" max="500000000" step="1000000" value="100000000">
                  <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>Raw tokens</span>
                    <span id="wsMultiplier">1.00x</span>
                    <span>Max age bonus</span>
                  </div>
                </div>
              </div>
              
              <!-- Gamma Scale Visualization -->
              <div class="mt-8 pt-8 border-t border-gray-800">
                <h4 class="mb-4"><i class="fas fa-scale-balanced"></i> Gamma Scale Factor (Î³)</h4>
                <div class="mb-4">
                  <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium">Current Gamma: <span id="gammaValue" class="text-primary font-bold">0.40</span></span>
                    <span class="text-sm text-gray-500">Target: <span id="targetGamma">1.00</span></span>
                  </div>
                  <div class="relative h-4 bg-gray-800 rounded-full overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500"></div>
                    <div id="gammaMarker" class="absolute top-0 w-1 h-full bg-white shadow-lg" style="left: 40%;"></div>
                  </div>
                  <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>Floor: 40%</span>
                    <span>Target: 50% CS</span>
                    <span>Max: 100%</span>
                  </div>
                </div>
                
                <!-- Gamma Components -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                  <div class="text-center p-3 bg-gray-900 rounded-lg">
                    <div class="text-xs text-gray-500 mb-1">P/(0.5Ã—CS)</div>
                    <div id="participationTerm" class="text-lg font-bold">0.40</div>
                  </div>
                  <div class="text-center p-3 bg-gray-900 rounded-lg">
                    <div class="text-xs text-gray-500 mb-1">CS/âˆ‘WS</div>
                    <div id="inflationCap" class="text-lg font-bold">1.00</div>
                  </div>
                  <div class="text-center p-3 bg-gray-900 rounded-lg">
                    <div class="text-xs text-gray-500 mb-1">MIN(1, ...)</div>
                    <div id="minTerm" class="text-lg font-bold">0.40</div>
                  </div>
                  <div class="text-center p-3 bg-gray-900 rounded-lg">
                    <div class="text-xs text-gray-500 mb-1">Î³ = MAX(0.4, ...)</div>
                    <div id="maxTerm" class="text-lg font-bold text-primary">0.40</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Calculate Button -->
            <div class="text-center mb-8">
              <button onclick="calculateRewards()" id="calculateBtn" class="pro-btn pro-btn-primary px-12 py-4 text-lg">
                <i class="fas fa-bolt"></i> CALCULATE SUSTAINABLE REWARDS
              </button>
              <p class="text-sm text-gray-500 mt-3">
                <i class="fas fa-sync-alt"></i> Auto-recalculates when inputs change
              </p>
            </div>
            
            <!-- Results Display -->
            <div id="reward-result" class="pro-card">
              <div class="text-center py-12">
                <i class="fas fa-calculator text-4xl text-gray-700 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Ready to Calculate</h3>
                <p class="text-gray-500">Add your token batches and adjust participation settings to see your sustainable $REBL rewards</p>
              </div>
            </div>
          </div>
          
          <!-- Simulator Tab -->
          <div id="tab-simulator" class="tab-content">
            <div class="pro-card">
              <h3 class="mb-6"><i class="fas fa-chart-line"></i> Gamma Scale Simulator</h3>
              <p class="text-gray-500 mb-8">Explore how the Gamma Scale Factor (Î³) adjusts rewards based on different participation scenarios</p>
              
              <div class="space-y-8">
                <!-- Simulation Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div class="pro-slider-container">
                    <div class="pro-slider-label">
                      <div>
                        <span class="font-semibold">What-if: Participating Tokens</span>
                      </div>
                      <div id="simParticipatingValue" class="pro-slider-value">100M</div>
                    </div>
                    <input type="range" id="simParticipatingSlider" class="pro-slider" min="1000000" max="500000000" step="1000000" value="100000000">
                    <div class="text-xs text-gray-500 mt-2">
                      Range: 1M to 500M tokens
                    </div>
                  </div>
                  
                  <div class="pro-slider-container">
                    <div class="pro-slider-label">
                      <div>
                        <span class="font-semibold">What-if: Age Bonus Efficiency</span>
                      </div>
                      <div id="simAgeBonusValue" class="pro-slider-value">100%</div>
                    </div>
                    <input type="range" id="simAgeBonusSlider" class="pro-slider" min="0" max="240" step="1" value="100">
                    <div class="text-xs text-gray-500 mt-2">
                      Range: 0% to 240% bonus
                    </div>
                  </div>
                </div>
                
                <!-- Simulation Results -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div class="metric-card">
                    <div class="metric-label">Gamma Scale Factor</div>
                    <div id="simGammaValue" class="metric-value">0.40</div>
                    <div class="metric-sub">Sustainability adjustment</div>
                  </div>
                  
                  <div class="metric-card">
                    <div class="metric-label">Effective Distribution</div>
                    <div id="simDistributionValue" class="metric-value">1.28M</div>
                    <div class="metric-sub">$REBL weekly</div>
                  </div>
                  
                  <div class="metric-card">
                    <div class="metric-label">Reward Efficiency</div>
                    <div id="simEfficiencyValue" class="metric-value">40%</div>
                    <div class="metric-sub">of maximum</div>
                  </div>
                </div>
                
                <!-- Simulation Chart -->
                <div class="pro-chart-container">
                  <canvas id="simulationChart"></canvas>
                </div>
                
                <!-- Preset Scenarios -->
                <div class="mt-8">
                  <h4 class="mb-4"><i class="fas fa-scroll"></i> Scenario Presets</h4>
                  <div class="flex flex-wrap gap-3">
                    <button onclick="loadScenario('current')" class="pro-btn pro-btn-secondary">
                      <i class="fas fa-sync"></i> Current State
                    </button>
                    <button onclick="loadScenario('optimal')" class="pro-btn pro-btn-primary">
                      <i class="fas fa-bullseye"></i> 50% Participation
                    </button>
                    <button onclick="loadScenario('maximum')" class="pro-btn pro-btn-outline">
                      <i class="fas fa-rocket"></i> Maximum Gamma
                    </button>
                    <button onclick="loadScenario('minimum')" class="pro-btn pro-btn-outline">
                      <i class="fas fa-shield-alt"></i> Floor Protection
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Analysis Tab -->
          <div id="tab-analysis" class="tab-content">
            <div class="pro-card">
              <h3 class="mb-6"><i class="fas fa-chart-bar"></i> Reward Analysis</h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Breakdown Chart -->
                <div>
                  <h4 class="mb-4">Reward Distribution</h4>
                  <div class="pro-chart-container">
                    <canvas id="analysisChart"></canvas>
                  </div>
                </div>
                
                <!-- Efficiency Metrics -->
                <div>
                  <h4 class="mb-4">Efficiency Metrics</h4>
                  <div class="space-y-4">
                    <div class="p-4 bg-gray-900 rounded-lg">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">Age Bonus Efficiency</span>
                        <span id="ageEfficiencyValue" class="text-lg font-bold text-primary">0%</span>
                      </div>
                      <div class="pro-progress">
                        <div id="ageEfficiencyBar" class="pro-progress-bar" style="width: 0%; background: linear-gradient(90deg, #ff3366, #d4a76a);"></div>
                      </div>
                      <div class="text-xs text-gray-500 mt-2">
                        Current vs Maximum (240%)
                      </div>
                    </div>
                    
                    <div class="p-4 bg-gray-900 rounded-lg">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">Gamma Efficiency</span>
                        <span id="gammaEfficiencyValue" class="text-lg font-bold text-primary">40%</span>
                      </div>
                      <div class="pro-progress">
                        <div id="gammaEfficiencyBar" class="pro-progress-bar" style="width: 40%; background: linear-gradient(90deg, #ff3366, #00aaff);"></div>
                      </div>
                      <div class="text-xs text-gray-500 mt-2">
                        Current vs Target (100%)
                      </div>
                    </div>
                    
                    <div class="p-4 bg-gray-900 rounded-lg">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">Participation Rate</span>
                        <span id="participationRateValue" class="text-lg font-bold text-primary">20%</span>
                      </div>
                      <div class="pro-progress">
                        <div id="participationRateBar" class="pro-progress-bar" style="width: 20%; background: linear-gradient(90deg, #ff3366, #4CAF50);"></div>
                      </div>
                      <div class="text-xs text-gray-500 mt-2">
                        Current vs Target (50% of CS)
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Optimization Tips -->
              <div class="mt-8 pt-8 border-t border-gray-800">
                <h4 class="mb-4"><i class="fas fa-lightbulb"></i> Optimization Opportunities</h4>
                <div id="optimizationTips" class="space-y-4">
                  <!-- Tips will be generated here -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Formula Tab -->
          <div id="tab-formula" class="tab-content">
            <div class="pro-card">
              <h3 class="mb-6"><i class="fas fa-code"></i> Formula Breakdown</h3>
              
              <div class="pro-formula mb-8">
                <div class="pro-formula-main">Rewardáµ¢ = (WSáµ¢ / âˆ‘WS) Ã— 3,200,000 Ã— Î³</div>
                <div class="pro-formula-sub">Î³ = MAX(0.4, MIN(1, P/(0.5 Ã— CS), CS/âˆ‘WS))</div>
              </div>
              
              <div class="space-y-6">
                <div class="p-4 bg-gray-900 rounded-lg">
                  <h4 class="text-primary font-semibold mb-3">WSáµ¢ (Your Weighted Share)</h4>
                  <p class="text-gray-300 mb-2">WSáµ¢ = Î£[Token Amount Ã— (1 + 0.07 Ã— min(Age, 20))]</p>
                  <div class="text-sm text-gray-500">
                    Each batch gets 7% weight boost per epoch, capping at 20 epochs (maximum 2.4x multiplier)
                  </div>
                </div>
                
                <div class="p-4 bg-gray-900 rounded-lg">
                  <h4 class="text-primary font-semibold mb-3">âˆ‘WS (Total Active Weighted Shares)</h4>
                  <p class="text-gray-300 mb-2">âˆ‘WS = Î£[All participants' weighted shares]</p>
                  <div class="text-sm text-gray-500">
                    Sum of all participants' WSáµ¢. Always â‰¥ total participating tokens (P)
                  </div>
                </div>
                
                <div class="p-4 bg-gray-900 rounded-lg">
                  <h4 class="text-primary font-semibold mb-3">P (Total Participating Tokens)</h4>
                  <p class="text-gray-300 mb-2">Raw token amount actively participating in the epoch</p>
                  <div class="text-sm text-gray-500">
                    Does not include age bonuses. Simply the sum of all tokens being staked
                  </div>
                </div>
                
                <div class="p-4 bg-gray-900 rounded-lg">
                  <h4 class="text-primary font-semibold mb-3">Î³ (Gamma Scale Factor)</h4>
                  <p class="text-gray-300 mb-2">Î³ = MAX(0.4, MIN(1, P/(0.5 Ã— CS), CS/âˆ‘WS))</p>
                  <div class="text-sm text-gray-500 space-y-2">
                    <div class="flex items-center gap-2">
                      <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                      <span><strong>P/(0.5 Ã— CS):</strong> Scales from 0 to 2. Reaches 1.0 at 50% participation</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                      <span><strong>CS/âˆ‘WS:</strong> Limits age bonus inflation. Prevents excessive rewards</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>MAX(0.4, ...):</strong> Floor protection. Minimum 40% rewards always active</span>
                    </div>
                  </div>
                </div>
                
                <div class="p-4 bg-gray-900 rounded-lg">
                  <h4 class="text-primary font-semibold mb-3">Practical Example</h4>
                  <div class="text-sm text-gray-500 space-y-2">
                    <p>If you have 1,000,000 tokens with average age of 10 epochs:</p>
                    <p class="font-mono">WSáµ¢ = 1,000,000 Ã— (1 + 0.07 Ã— 10) = 1,700,000</p>
                    <p>If total WS = 100,000,000 and Î³ = 0.8:</p>
                    <p class="font-mono">Reward = (1,700,000 / 100,000,000) Ã— 3,200,000 Ã— 0.8 = 43,520 $REBL</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section id="calculator-faq" class="mt-16">
      <div class="container">
        <h2 class="text-center mb-8"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="pro-card">
            <h4 class="text-primary mb-3"><i class="fas fa-calculator"></i> How accurate is this calculator?</h4>
            <p class="text-gray-300">This calculator uses the exact formula from the smart contract. The only estimate is community participation, which you can adjust manually for different scenarios.</p>
          </div>
          
          <div class="pro-card">
            <h4 class="text-primary mb-3"><i class="fas fa-chart-line"></i> How is Gamma calculated?</h4>
            <p class="text-gray-300">Î³ = MAX(0.4, MIN(1, P/(0.5Ã—CS), CS/âˆ‘WS)). It scales from 40% to 100% based on participation and age bonus inflation.</p>
          </div>
          
          <div class="pro-card">
            <h4 class="text-primary mb-3"><i class="fas fa-clock"></i> What's the maximum age bonus?</h4>
            <p class="text-gray-300">7% per epoch, maximum 20 epochs = 140% bonus. Total multiplier: 2.4x (1 + 1.4).</p>
          </div>
          
          <div class="pro-card">
            <h4 class="text-primary mb-3"><i class="fas fa-users"></i> How does participation affect rewards?</h4>
            <p class="text-gray-300">Higher participation increases Gamma (up to 100%), unlocking more of the weekly 3.2M $REBL pool for distribution.</p>
          </div>
          
          <div class="pro-card">
            <h4 class="text-primary mb-3"><i class="fas fa-shield-alt"></i> What is the 40% floor?</h4>
            <p class="text-gray-300">Minimum 40% of rewards are always distributed, even with low participation. This protects active participants.</p>
          </div>
          
          <div class="pro-card">
            <h4 class="text-primary mb-3"><i class="fas fa-sync"></i> When should I recalculate?</h4>
            <p class="text-gray-300">When you add/remove tokens, after each epoch (age increases), or if you notice significant participation changes.</p>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Footer will be inserted here by JavaScript -->
  <div id="footer-container"></div>
  
  <!-- JavaScript Includes -->
  <script src="js/includes.js"></script>
  <script src="js/common.js"></script>
  
  <!-- Professional Calculator JavaScript -->
  <script>
    // ========== GLOBAL VARIABLES & CONSTANTS ==========
    const CS = 499242047.00; // Circulating Supply (fixed)
    const WERP = 3200000.00; // Weekly Epoch Reward Pool (fixed)
    const K = 0.07; // Age bonus per epoch
    const MAX_AGE = 20; // Maximum age for bonus
    const GAMMA_FLOOR = 0.4; // Minimum gamma value
    const TARGET_PARTICIPATION = 0.5; // 50% of CS for full gamma
    
    // Professional state management
    let calculatorState = {
        autoUpdateParticipation: true,
        totalUserTokens: 0,
        totalUserWS: 0,
        currentParticipatingTokens: 100000000,
        currentTotalWS: 100000000,
        isCalculating: false,
        charts: {},
        lastCalculation: null
    };
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸš€ Initializing Professional REBL Calculator...');
        
        // Initialize UI
        initializeUI();
        
        // Add first token batch
        setTimeout(() => {
            addTokenBatch();
            updateAllDisplays();
            setupCharts();
        }, 500);
        
        // Show welcome message
        setTimeout(() => {
            showProfessionalToast('Welcome to the Professional REBL Calculator! Start by adding your token batches.', 'info');
        }, 1000);
    });
    
    function initializeUI() {
        // Setup event listeners
        setupEventListeners();
        
        // Initialize sliders
        initializeSliders();
        
        // Initialize tooltips
        initializeTooltips();
        
        // Set up tab switching
        setupTabs();
    }
    
    // ========== TOKEN BATCH MANAGEMENT ==========
    function addTokenBatch(amount = '', age = '') {
        const tbody = document.getElementById('token-batches-table');
        if (!tbody) return;
        
        const rowId = 'batch-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const row = document.createElement('tr');
        row.id = rowId;
        row.innerHTML = `
            <td>
                <input type="number" 
                       class="pro-input batch-amount" 
                       value="${amount}" 
                       placeholder="Enter amount"
                       min="0" 
                       step="1000"
                       data-batch="${rowId}">
            </td>
            <td>
                <input type="number" 
                       class="pro-input batch-age" 
                       value="${age}" 
                       placeholder="Age"
                       min="0" 
                       max="${MAX_AGE}" 
                       step="1"
                       data-batch="${rowId}">
            </td>
            <td class="text-center font-mono">
                <span class="batch-factor text-primary font-bold">1.00</span>
                <div class="text-xs text-gray-500">Multiplier</div>
            </td>
            <td class="text-center">
                <span class="batch-ws font-bold" style="color: #ff3366;">0</span>
                <div class="text-xs text-gray-500">Weighted</div>
            </td>
            <td class="text-center">
                <button onclick="removeTokenBatch('${rowId}')" 
                        class="pro-btn pro-btn-secondary text-sm px-3 py-1">
                    <i class="fas fa-times"></i>
                </button>
                <button onclick="duplicateBatch('${rowId}')" 
                        class="pro-btn pro-btn-outline text-sm px-3 py-1 ml-2">
                    <i class="fas fa-copy"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Add animation
        row.style.animation = 'slideInUp 0.3s ease';
        setTimeout(() => row.style.animation = '', 300);
        
        // Setup input listeners
        const amountInput = row.querySelector('.batch-amount');
        const ageInput = row.querySelector('.batch-age');
        
        amountInput.addEventListener('input', debounce(() => updateBatchCalculations(rowId), 300));
        ageInput.addEventListener('input', debounce(() => updateBatchCalculations(rowId), 300));
        
        // If values provided, calculate immediately
        if (amount || age) {
            setTimeout(() => updateBatchCalculations(rowId), 50);
        }
    }
    
    function removeTokenBatch(rowId) {
        const row = document.getElementById(rowId);
        if (!row) return;
        
        // Animation
        row.style.transform = 'translateX(-100%)';
        row.style.opacity = '0';
        row.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
            row.remove();
            updateUserTotals();
            calculateRewards();
            
            // Add empty row if all removed
            const tbody = document.getElementById('token-batches-table');
            if (tbody && tbody.children.length === 0) {
                addTokenBatch();
            }
        }, 300);
    }
    
    function duplicateBatch(rowId) {
        const row = document.getElementById(rowId);
        if (!row) return;
        
        const amount = row.querySelector('.batch-amount').value;
        const age = row.querySelector('.batch-age').value;
        
        addTokenBatch(amount, age);
    }
    
    function clearTokenBatches() {
        const tbody = document.getElementById('token-batches-table');
        if (!tbody || tbody.children.length === 0) return;
        
        if (!confirm('Are you sure you want to clear all token batches?')) return;
        
        // Animate removal
        const rows = Array.from(tbody.children);
        rows.forEach((row, index) => {
            setTimeout(() => {
                row.style.transform = 'translateX(100%)';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }, index * 50);
        });
        
        // Add empty row after clearing
        setTimeout(() => {
            addTokenBatch();
            calculatorState.totalUserTokens = 0;
            calculatorState.totalUserWS = 0;
            updateAllDisplays();
            
            showProfessionalToast('All token batches cleared', 'info');
        }, rows.length * 50 + 300);
    }
    
    function updateBatchCalculations(rowId) {
        const row = document.getElementById(rowId);
        if (!row) return;
        
        const amountInput = row.querySelector('.batch-amount');
        const ageInput = row.querySelector('.batch-age');
        const factorSpan = row.querySelector('.batch-factor');
        const wsSpan = row.querySelector('.batch-ws');
        
        let amount = parseFloat(amountInput.value) || 0;
        let age = parseInt(ageInput.value) || 0;
        
        // Validate and sanitize
        if (amount < 0) amount = 0;
        if (age < 0) age = 0;
        if (age > MAX_AGE) age = MAX_AGE;
        
        amountInput.value = amount;
        ageInput.value = age;
        
        // Calculate weight factor
        const weightFactor = 1 + (K * Math.min(age, MAX_AGE));
        
        // Calculate weighted share
        const weightedShare = amount * weightFactor;
        
        // Update display
        factorSpan.textContent = weightFactor.toFixed(2);
        factorSpan.style.color = weightFactor > 1 ? 'var(--rebel-primary)' : '#ffffff';
        
        wsSpan.textContent = formatNumber(weightedShare, true);
        wsSpan.style.color = weightedShare > 0 ? '#ff3366' : '#ffffff';
        
        // Add visual feedback
        if (amount > 0) {
            amountInput.classList.remove('error', 'warning');
            amountInput.classList.add('success');
        } else {
            amountInput.classList.remove('success');
        }
        
        // Update totals
        updateUserTotals();
        
        // Debounce reward calculation
        debounceCalculation();
    }
    
    function updateUserTotals() {
        const rows = document.querySelectorAll('#token-batches-table tr[id^="batch-"]');
        let totalTokens = 0;
        let totalWS = 0;
        let totalAge = 0;
        let batchCount = 0;
        
        rows.forEach(row => {
            const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
            const ws = parseFloat(row.querySelector('.batch-ws').textContent.replace(/,/g, '')) || 0;
            const age = parseInt(row.querySelector('.batch-age').value) || 0;
            
            totalTokens += amount;
            totalWS += ws;
            if (amount > 0) {
                totalAge += age;
                batchCount++;
            }
        });
        
        calculatorState.totalUserTokens = totalTokens;
        calculatorState.totalUserWS = totalWS;
        
        // Update displays
        updateMetricDisplays();
        updateProgressBars();
        
        // Auto-update participation if enabled
        if (calculatorState.autoUpdateParticipation) {
            updateParticipationEstimation();
        }
    }
    
    // ========== PARTICIPATION CALCULATIONS ==========
    function updateParticipationEstimation() {
        const userTokens = calculatorState.totalUserTokens;
        const userWS = calculatorState.totalUserWS;
        
        if (userTokens <= 0) {
            // Default values for no tokens
            calculatorState.currentParticipatingTokens = 100000000;
            calculatorState.currentTotalWS = 120000000;
        } else {
            // Smart estimation based on user's holdings
            const userShareOfCS = userTokens / CS;
            let communityMultiplier;
            
            // Determine community multiplier based on user's share
            if (userShareOfCS >= 0.01) { // 1%+ holder
                communityMultiplier = 3;
            } else if (userShareOfCS >= 0.001) { // 0.1%+ holder
                communityMultiplier = 5;
            } else { // Small holder
                communityMultiplier = 10;
            }
            
            // Calculate participating tokens
            const estimatedCommunityTokens = Math.min(
                CS - userTokens,
                userTokens * communityMultiplier
            );
            
            calculatorState.currentParticipatingTokens = Math.min(
                CS,
                Math.max(userTokens * 2, userTokens + estimatedCommunityTokens, 10000000)
            );
            
            // Calculate total WS based on user's age bonus efficiency
            const userAgeEfficiency = userTokens > 0 ? (userWS / userTokens) : 1;
            const communityAgeEfficiency = userAgeEfficiency * 0.85; // Assume community has 85% of user's efficiency
            
            calculatorState.currentTotalWS = Math.min(
                CS * 2.4, // Absolute maximum
                Math.max(
                    userWS * 1.5,
                    userWS + (estimatedCommunityTokens * communityAgeEfficiency),
                    calculatorState.currentParticipatingTokens * 1.1
                )
            );
        }
        
        // Update UI
        updateParticipationUI();
    }
    
    function calculateGammaScale(P, totalWS) {
        // Validate inputs
        if (P <= 0 || totalWS <= 0 || isNaN(P) || isNaN(totalWS)) {
            return {
                gamma: GAMMA_FLOOR,
                participationTerm: 0,
                inflationCap: Infinity,
                minTerm: GAMMA_FLOOR,
                status: 'invalid'
            };
        }
        
        // Term 1: P/(0.5 Ã— CS) - Participation Scaling
        const participationTerm = P / (0.5 * CS);
        
        // Term 2: CS/âˆ‘WS - Age Inflation Cap
        const inflationCap = totalWS > 0 ? CS / totalWS : Infinity;
        
        // MIN(1, participationTerm, inflationCap)
        const minTerm = Math.min(1, participationTerm, inflationCap);
        
        // MAX(0.4, minTerm)
        const gamma = Math.max(GAMMA_FLOOR, minTerm);
        
        // Determine status
        let status = 'low';
        if (gamma >= 1) status = 'max';
        else if (gamma >= 0.8) status = 'high';
        else if (gamma >= 0.6) status = 'medium';
        
        return {
            gamma,
            participationTerm,
            inflationCap,
            minTerm,
            status,
            components: {
                P,
                CS,
                totalWS,
                target50Percent: 0.5 * CS,
                participationRatio: P / CS,
                wsMultiplier: totalWS / P
            }
        };
    }
    
    function getGammaStatus(gamma, P, totalWS) {
        const target = 0.5 * CS;
        const participationRatio = P / CS;
        const wsMultiplier = totalWS / P;
        
        if (gamma >= 1) {
            return {
                level: 'maximum',
                title: 'Maximum Gamma Achieved',
                message: 'Perfect participation! 100% of weekly pool distributed.',
                color: '#4CAF50',
                icon: 'fas fa-trophy',
                recommendation: 'Maintain current participation levels.'
            };
        } else if (gamma >= 0.8) {
            const needed = Math.ceil(target - P);
            return {
                level: 'high',
                title: 'High Gamma Level',
                message: `Excellent participation at ${Math.round(gamma * 100)}% efficiency.`,
                color: '#8BC34A',
                icon: 'fas fa-chart-line',
                recommendation: needed > 0 ? `Need ${formatNumber(needed)} more tokens for maximum gamma.` : 'Almost at maximum!'
            };
        } else if (gamma >= 0.6) {
            const needed = Math.ceil(target - P);
            return {
                level: 'medium',
                title: 'Moderate Gamma Level',
                message: `Good participation at ${Math.round(gamma * 100)}% efficiency.`,
                color: '#FFC107',
                icon: 'fas fa-chart-bar',
                recommendation: `Need ${formatNumber(needed)} more tokens to reach maximum gamma.`
            };
        } else if (gamma > GAMMA_FLOOR) {
            const currentPool = WERP * gamma;
            const maxPool = WERP * 1.0;
            const lost = maxPool - currentPool;
            return {
                level: 'low',
                title: 'Low Gamma Level',
                message: `Only ${Math.round(gamma * 100)}% of rewards active.`,
                color: '#FF9800',
                icon: 'fas fa-exclamation-triangle',
                recommendation: `${formatNumber(lost)} $REBL lost weekly. Increase participation!`
            };
        } else {
            return {
                level: 'floor',
                title: 'Minimum Gamma (Floor)',
                message: 'Minimum 40% rewards active due to floor protection.',
                color: '#FF5722',
                icon: 'fas fa-shield-alt',
                recommendation: 'Significantly increase participation to unlock more rewards.'
            };
        }
    }
    
    // ========== REWARD CALCULATIONS ==========
    function calculateRewards() {
        if (calculatorState.isCalculating) return;
        
        calculatorState.isCalculating = true;
        const startTime = Date.now();
        
        // Show loading state
        const calculateBtn = document.getElementById('calculateBtn');
        if (calculateBtn) {
            calculateBtn.classList.add('pro-loading');
            calculateBtn.disabled = true;
        }
        
        // Get user data
        const rows = document.querySelectorAll('#token-batches-table tr[id^="batch-"]');
        let userWS = 0;
        let totalAmount = 0;
        const batchData = [];
        
        rows.forEach(row => {
            const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
            const ws = parseFloat(row.querySelector('.batch-ws').textContent.replace(/,/g, '')) || 0;
            
            userWS += ws;
            totalAmount += amount;
            
            if (amount > 0) {
                const age = parseInt(row.querySelector('.batch-age').value) || 0;
                batchData.push({
                    amount,
                    age,
                    ws,
                    factor: 1 + (K * Math.min(age, MAX_AGE))
                });
            }
        });
        
        // Get participation data
        const participatingTokens = calculatorState.currentParticipatingTokens;
        const totalWS = calculatorState.currentTotalWS;
        
        // Validate totalWS
        if (totalWS < userWS) {
            calculatorState.currentTotalWS = Math.max(userWS * 1.1, userWS + 1000000);
            updateParticipationUI();
            showProfessionalToast('Adjusted Total WS to match your weighted shares', 'warning');
        }
        
        // Calculate gamma
        const gammaData = calculateGammaScale(participatingTokens, totalWS);
        const gamma = gammaData.gamma;
        const gammaStatus = getGammaStatus(gamma, participatingTokens, totalWS);
        
        // Calculate rewards
        const userShare = totalWS > 0 ? (userWS / totalWS) : 0;
        const userReward = userShare * WERP * gamma;
        const effectivePool = WERP * gamma;
        
        // Calculate additional metrics
        const wsMultiplier = participatingTokens > 0 ? (totalWS / participatingTokens) : 1;
        const ageBonusEfficiency = ((wsMultiplier - 1) * 100).toFixed(1);
        const participationPercent = ((participatingTokens / CS) * 100).toFixed(1);
        const returnPercent = totalAmount > 0 ? ((userReward / totalAmount) * 100).toFixed(4) : '0.0000';
        
        // Calculate projections
        const dailyReward = userReward / 7;
        const monthlyReward = userReward * 4.33;
        const annualReward = userReward * 52;
        
        // Store calculation result
        calculatorState.lastCalculation = {
            userWS,
            totalWS,
            participatingTokens,
            gamma,
            userShare,
            userReward,
            effectivePool,
            wsMultiplier,
            returnPercent,
            gammaStatus,
            batchData,
            timestamp: Date.now()
        };
        
        // Update results display
        updateResultsDisplay({
            userWS,
            totalWS,
            participatingTokens,
            gamma,
            userShare,
            userReward,
            effectivePool,
            wsMultiplier,
            returnPercent,
            gammaStatus,
            dailyReward,
            monthlyReward,
            annualReward,
            participationPercent,
            ageBonusEfficiency
        });
        
        // Update charts
        updateCharts(batchData, gammaData);
        
        // Update analysis
        updateAnalysis({
            userWS,
            totalWS,
            participatingTokens,
            gamma,
            wsMultiplier,
            participationPercent,
            ageBonusEfficiency
        });
        
        // Remove loading state
        setTimeout(() => {
            calculatorState.isCalculating = false;
            if (calculateBtn) {
                calculateBtn.classList.remove('pro-loading');
                calculateBtn.disabled = false;
            }
            
            const duration = Date.now() - startTime;
            console.log(`âœ… Calculation completed in ${duration}ms`);
            
            showProfessionalToast('Rewards calculated successfully!', 'success');
        }, 800);
    }
    
    // ========== UI UPDATES ==========
    function updateMetricDisplays() {
        // Update position metric
        const positionMetric = document.getElementById('positionMetric');
        if (positionMetric) {
            positionMetric.textContent = formatNumber(calculatorState.totalUserWS, true);
            positionMetric.style.color = calculatorState.totalUserWS > 0 ? 'var(--rebel-primary)' : '#ffffff';
        }
        
        // Update total WS info
        const totalWSInfo = document.getElementById('totalWSInfo');
        if (totalWSInfo) {
            const avgBonus = calculatorState.totalUserTokens > 0 ? 
                (calculatorState.totalUserWS / calculatorState.totalUserTokens).toFixed(2) : '1.00';
            totalWSInfo.textContent = `${formatNumber(calculatorState.totalUserWS, true)} WS (${avgBonus}x)`;
        }
    }
    
    function updateProgressBars() {
        const ageBonusProgress = document.getElementById('ageBonusProgress');
        const ageBonusPercent = document.getElementById('ageBonusPercent');
        
        if (ageBonusProgress && ageBonusPercent) {
            const avgBonus = calculatorState.totalUserTokens > 0 ? 
                (calculatorState.totalUserWS / calculatorState.totalUserTokens) : 1;
            const bonusPercent = Math.min(140, ((avgBonus - 1) / 1.4) * 100);
            
            ageBonusProgress.style.width = `${bonusPercent}%`;
            ageBonusPercent.textContent = Math.round(bonusPercent * 1.4);
        }
    }
    
    function updateParticipationUI() {
        // Update sliders
        const participatingSlider = document.getElementById('participatingSlider');
        const totalWSSlider = document.getElementById('totalWSSlider');
        
        if (participatingSlider) {
            participatingSlider.value = calculatorState.currentParticipatingTokens;
        }
        
        if (totalWSSlider) {
            totalWSSlider.value = calculatorState.currentTotalWS;
        }
        
        // Update display values
        updateParticipationDisplays();
        
        // Calculate and update gamma
        updateGammaDisplay();
    }
    
    function updateParticipationDisplays() {
        // Participating tokens
        const participatingValue = document.getElementById('participatingValue');
        const participationPercent = document.getElementById('participationPercent');
        
        if (participatingValue) {
            participatingValue.textContent = formatNumber(calculatorState.currentParticipatingTokens);
        }
        
        if (participationPercent) {
            const percent = ((calculatorState.currentParticipatingTokens / CS) * 100).toFixed(1);
            participationPercent.textContent = `${percent}%`;
        }
        
        // Total WS
        const totalWSValue = document.getElementById('totalWSValue');
        const wsMultiplier = document.getElementById('wsMultiplier');
        
        if (totalWSValue) {
            totalWSValue.textContent = formatNumber(calculatorState.currentTotalWS);
        }
        
        if (wsMultiplier) {
            const multiplier = (calculatorState.currentTotalWS / calculatorState.currentParticipatingTokens).toFixed(2);
            wsMultiplier.textContent = `${multiplier}x`;
        }
    }
    
    function updateGammaDisplay() {
        const gammaData = calculateGammaScale(
            calculatorState.currentParticipatingTokens,
            calculatorState.currentTotalWS
        );
        
        const gamma = gammaData.gamma;
        const gammaStatus = getGammaStatus(gamma, calculatorState.currentParticipatingTokens, calculatorState.currentTotalWS);
        
        // Update metric
        const gammaMetric = document.getElementById('gammaMetric');
        if (gammaMetric) {
            gammaMetric.textContent = gamma.toFixed(2);
            gammaMetric.style.color = gammaStatus.color;
        }
        
        // Update value display
        const gammaValue = document.getElementById('gammaValue');
        if (gammaValue) {
            gammaValue.textContent = gamma.toFixed(2);
            gammaValue.style.color = gammaStatus.color;
        }
        
        // Update marker position
        const gammaMarker = document.getElementById('gammaMarker');
        if (gammaMarker) {
            const position = GAMMA_FLOOR * 100 + (gamma - GAMMA_FLOOR) * (100 / (1 - GAMMA_FLOOR));
            gammaMarker.style.left = `${Math.min(100, Math.max(GAMMA_FLOOR * 100, position))}%`;
            gammaMarker.style.backgroundColor = gammaStatus.color;
        }
        
        // Update component values
        document.getElementById('participationTerm').textContent = gammaData.participationTerm.toFixed(2);
        document.getElementById('inflationCap').textContent = gammaData.inflationCap.toFixed(2);
        document.getElementById('minTerm').textContent = gammaData.minTerm.toFixed(2);
        document.getElementById('maxTerm').textContent = gamma.toFixed(2);
        document.getElementById('maxTerm').style.color = gammaStatus.color;
        
        // Update target gamma
        const targetGamma = document.getElementById('targetGamma');
        if (targetGamma) {
            targetGamma.textContent = '1.00';
            targetGamma.style.color = gamma >= 1 ? '#4CAF50' : '#ffffff';
        }
    }
    
    function updateResultsDisplay(data) {
        const resultContainer = document.getElementById('reward-result');
        if (!resultContainer) return;
        
        resultContainer.innerHTML = `
            <div class="space-y-6">
                <!-- Gamma Status Banner -->
                <div class="pro-alert pro-alert-${data.gammaStatus.level === 'maximum' ? 'success' : 
                                                   data.gammaStatus.level === 'high' ? 'info' : 
                                                   data.gammaStatus.level === 'medium' ? 'warning' : 'danger'}">
                    <i class="${data.gammaStatus.icon} text-xl"></i>
                    <div class="flex-1">
                        <div class="font-bold text-lg mb-1">${data.gammaStatus.title}</div>
                        <div class="text-sm mb-2">${data.gammaStatus.message}</div>
                        <div class="text-xs opacity-80">${data.gammaStatus.recommendation}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-black" style="color: ${data.gammaStatus.color};">${data.gamma.toFixed(2)}</div>
                        <div class="text-xs opacity-80">Gamma</div>
                    </div>
                </div>
                
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="metric-card">
                        <div class="metric-label">Your Share</div>
                        <div class="metric-value" style="color: var(--rebel-primary);">${(data.userShare * 100).toFixed(4)}%</div>
                        <div class="metric-sub">of weighted pool</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">WS Multiplier</div>
                        <div class="metric-value" style="color: ${data.wsMultiplier >= 2.0 ? '#4CAF50' : data.wsMultiplier >= 1.5 ? '#FFC107' : '#ffffff'}">
                            ${data.wsMultiplier.toFixed(2)}x
                        </div>
                        <div class="metric-sub">${data.ageBonusEfficiency}% efficiency</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Effective Pool</div>
                        <div class="metric-value" style="color: #ff3366;">${formatNumber(data.effectivePool, false)}</div>
                        <div class="metric-sub">$REBL weekly</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Participation</div>
                        <div class="metric-value" style="color: #00aaff;">${data.participationPercent}%</div>
                        <div class="metric-sub">of circulating supply</div>
                    </div>
                </div>
                
                <!-- Main Reward -->
                <div class="text-center p-8 bg-gradient-to-r from-gray-900 to-black rounded-xl border border-gray-800">
                    <div class="text-sm text-gray-500 mb-2">YOUR WEEKLY SUSTAINABLE REWARD</div>
                    <div class="text-5xl md:text-6xl font-black mb-2" style="color: #ff3366; text-shadow: 0 0 20px rgba(255, 51, 102, 0.3);">
                        ${formatNumber(data.userReward, true)}
                    </div>
                    <div class="text-lg font-semibold text-gray-300 mb-4">$REBL</div>
                    <div class="text-sm text-gray-500">
                        = ${formatNumber(data.userWS, true)} WS Ã— ${data.gamma.toFixed(2)}Î³
                        <br>
                        <span class="text-xs">Weekly return: ${data.returnPercent}%</span>
                    </div>
                </div>
                
                <!-- Projections -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-6 bg-gray-900 rounded-lg">
                        <div class="text-sm text-gray-500 mb-2">DAILY ESTIMATE</div>
                        <div class="text-2xl font-bold text-primary">${formatNumber(data.dailyReward, true)}</div>
                        <div class="text-xs text-gray-500 mt-1">$REBL per day</div>
                    </div>
                    
                    <div class="text-center p-6 bg-gray-900 rounded-lg">
                        <div class="text-sm text-gray-500 mb-2">MONTHLY ESTIMATE*</div>
                        <div class="text-2xl font-bold text-primary">${formatNumber(data.monthlyReward, true)}</div>
                        <div class="text-xs text-gray-500 mt-1">$REBL per month</div>
                    </div>
                    
                    <div class="text-center p-6 bg-gray-900 rounded-lg">
                        <div class="text-sm text-gray-500 mb-2">ANNUAL ESTIMATE*</div>
                        <div class="text-2xl font-bold text-primary">${formatNumber(data.annualReward, true)}</div>
                        <div class="text-xs text-gray-500 mt-1">$REBL per year</div>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-600">
                    *Projections assume same conditions continue. 4.33 weeks/month, 52 weeks/year.
                </div>
                
                <!-- Formula Breakdown -->
                <div class="p-4 bg-black rounded-lg border border-gray-800 font-mono text-sm">
                    <div class="text-gray-500 mb-2">Calculation Breakdown:</div>
                    <div class="space-y-1">
                        <div>Reward = (${formatNumber(data.userWS, true)} / ${formatNumber(data.totalWS)}) Ã— ${formatNumber(WERP)} Ã— ${data.gamma.toFixed(2)}</div>
                        <div>      = ${(data.userShare * 100).toFixed(4)}% Ã— ${formatNumber(WERP)} Ã— ${data.gamma.toFixed(2)}</div>
                        <div>      = ${formatNumber(data.userShare * WERP, true)} Ã— ${data.gamma.toFixed(2)}</div>
                        <div class="pt-2 text-primary font-bold">      = ${formatNumber(data.userReward, true)} $REBL weekly</div>
                    </div>
                </div>
            </div>
        `;
        
        resultContainer.classList.add('pro-card');
    }
    
    // ========== CHART FUNCTIONS ==========
    function setupCharts() {
        // Initialize simulation chart
        const simCtx = document.getElementById('simulationChart');
        if (simCtx) {
            calculatorState.charts.simulation = new Chart(simCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Gamma Scale (Î³)',
                            data: [],
                            borderColor: 'var(--rebel-primary)',
                            backgroundColor: 'rgba(212, 167, 106, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Effective Pool',
                            data: [],
                            borderColor: '#ff3366',
                            backgroundColor: 'rgba(255, 51, 102, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: 'var(--rebel-primary)',
                            bodyColor: 'white',
                            borderColor: 'var(--rebel-primary)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize analysis chart
        const analysisCtx = document.getElementById('analysisChart');
        if (analysisCtx) {
            calculatorState.charts.analysis = new Chart(analysisCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Your Share', 'Community Share'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['var(--rebel-primary)', '#ff3366'],
                        borderWidth: 2,
                        borderColor: 'var(--rebel-card)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'white',
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: 'var(--rebel-primary)',
                            bodyColor: 'white'
                        }
                    },
                    cutout: '60%'
                }
            });
        }
    }
    
    function updateCharts(batchData, gammaData) {
        // Update analysis chart
        if (calculatorState.charts.analysis) {
            const userShare = calculatorState.lastCalculation.userShare * 100;
            const communityShare = 100 - userShare;
            
            calculatorState.charts.analysis.data.datasets[0].data = [userShare, communityShare];
            calculatorState.charts.analysis.update();
        }
    }
    
    function updateAnalysis(data) {
        // Update efficiency metrics
        const ageEfficiencyValue = document.getElementById('ageEfficiencyValue');
        const ageEfficiencyBar = document.getElementById('ageEfficiencyBar');
        const gammaEfficiencyValue = document.getElementById('gammaEfficiencyValue');
        const gammaEfficiencyBar = document.getElementById('gammaEfficiencyBar');
        const participationRateValue = document.getElementById('participationRateValue');
        const participationRateBar = document.getElementById('participationRateBar');
        
        if (ageEfficiencyValue && ageEfficiencyBar) {
            const efficiency = Math.min(100, (data.wsMultiplier - 1) / 1.4 * 100);
            ageEfficiencyValue.textContent = `${efficiency.toFixed(1)}%`;
            ageEfficiencyBar.style.width = `${efficiency}%`;
        }
        
        if (gammaEfficiencyValue && gammaEfficiencyBar) {
            const efficiency = data.gamma * 100;
            gammaEfficiencyValue.textContent = `${efficiency.toFixed(1)}%`;
            gammaEfficiencyBar.style.width = `${efficiency}%`;
        }
        
        if (participationRateValue && participationRateBar) {
            const rate = parseFloat(data.participationPercent);
            participationRateValue.textContent = `${rate}%`;
            participationRateBar.style.width = `${rate}%`;
        }
        
        // Generate optimization tips
        generateOptimizationTips(data);
    }
    
    function generateOptimizationTips(data) {
        const tipsContainer = document.getElementById('optimizationTips');
        if (!tipsContainer) return;
        
        const tips = [];
        
        // Age bonus tip
        if (data.wsMultiplier < 1.5) {
            tips.push({
                icon: 'fas fa-clock',
                color: 'text-yellow-500',
                title: 'Increase Age Bonus',
                message: `Your age bonus efficiency is ${((data.wsMultiplier - 1) * 100).toFixed(1)}%. Consider holding longer to reach maximum 140% bonus.`,
                action: 'Each additional epoch increases your WS by 7%'
            });
        }
        
        // Participation tip
        if (data.gamma < 0.8) {
            const needed = Math.ceil((0.5 * CS) - data.participatingTokens);
            tips.push({
                icon: 'fas fa-users',
                color: 'text-blue-500',
                title: 'Increase Participation',
                message: `Gamma is at ${(data.gamma * 100).toFixed(1)}%. Higher participation unlocks more rewards.`,
                action: `Need ${formatNumber(needed)} more tokens for full gamma`
            });
        }
        
        // Efficiency tip
        if (data.wsMultiplier > 2.0) {
            tips.push({
                icon: 'fas fa-star',
                color: 'text-green-500',
                title: 'Excellent Efficiency',
                message: 'Your age bonus efficiency is optimal! You\'re getting maximum benefits from long-term holding.',
                action: 'Maintain your current holding strategy'
            });
        }
        
        // Display tips
        tipsContainer.innerHTML = tips.map(tip => `
            <div class="flex items-start gap-4 p-4 bg-gray-900 rounded-lg">
                <i class="${tip.icon} ${tip.color} text-xl mt-1"></i>
                <div class="flex-1">
                    <div class="font-bold mb-1">${tip.title}</div>
                    <div class="text-sm text-gray-300 mb-2">${tip.message}</div>
                    <div class="text-xs text-gray-500">${tip.action}</div>
                </div>
            </div>
        `).join('');
    }
    
    // ========== EXAMPLE CASES ==========
    function loadExampleCase(type) {
        clearTokenBatches();
        
        setTimeout(() => {
            let batches = [];
            
            switch(type) {
                case 'starter':
                    batches = [
                        { amount: '50000', age: '3' },
                        { amount: '100000', age: '8' },
                        { amount: '25000', age: '1' }
                    ];
                    break;
                    
                case 'investor':
                    batches = [
                        { amount: '500000', age: '5' },
                        { amount: '1000000', age: '10' },
                        { amount: '750000', age: '15' },
                        { amount: '250000', age: '2' }
                    ];
                    break;
                    
                case 'whale':
                    batches = [
                        { amount: '2000000', age: '8' },
                        { amount: '3000000', age: '12' },
                        { amount: '5000000', age: '18' },
                        { amount: '1000000', age: '20' },
                        { amount: '500000', age: '6' }
                    ];
                    break;
            }
            
            // Add batches
            batches.forEach(batch => {
                addTokenBatch(batch.amount, batch.age);
            });
            
            // Enable auto-update
            calculatorState.autoUpdateParticipation = true;
            document.getElementById('autoUpdateToggle').checked = true;
            
            // Calculate
            setTimeout(() => calculateRewards(), 1000);
            
            showProfessionalToast(`${type.charAt(0).toUpperCase() + type.slice(1)} example loaded`, 'success');
        }, 500);
    }
    
    // ========== UTILITY FUNCTIONS ==========
    function formatNumber(num, showDecimals = false) {
        if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return '0';
        
        // Very small numbers
        if (num > 0 && num < 0.001) return '<0.001';
        
        // Large numbers with suffixes
        const absNum = Math.abs(num);
        if (absNum >= 1e9) {
            return (num / 1e9).toFixed(showDecimals ? 2 : 1) + 'B';
        } else if (absNum >= 1e6) {
            return (num / 1e6).toFixed(showDecimals ? 2 : 1) + 'M';
        } else if (absNum >= 1e3) {
            return (num / 1e3).toFixed(showDecimals ? 2 : 1) + 'K';
        }
        
        return num.toLocaleString('en-US', {
            minimumFractionDigits: showDecimals ? 2 : 0,
            maximumFractionDigits: showDecimals ? 2 : 0
        });
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function debounceCalculation() {
        clearTimeout(window.calculationDebounce);
        window.calculationDebounce = setTimeout(() => {
            if (!calculatorState.isCalculating) {
                calculateRewards();
            }
        }, 500);
    }
    
    function showProfessionalToast(message, type = 'info') {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.pro-toast');
        existingToasts.forEach(toast => toast.remove());
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = `pro-toast fixed bottom-6 right-6 z-50 flex items-center gap-3 px-4 py-3 rounded-lg shadow-xl border transform transition-all duration-300 translate-y-0 opacity-100`;
        
        // Set style based on type
        const styles = {
            success: 'bg-green-900/90 border-green-700 text-green-100',
            warning: 'bg-yellow-900/90 border-yellow-700 text-yellow-100',
            error: 'bg-red-900/90 border-red-700 text-red-100',
            info: 'bg-blue-900/90 border-blue-700 text-blue-100'
        };
        
        const icons = {
            success: 'fas fa-check-circle',
            warning: 'fas fa-exclamation-triangle',
            error: 'fas fa-times-circle',
            info: 'fas fa-info-circle'
        };
        
        toast.className += ' ' + styles[type];
        toast.innerHTML = `
            <i class="${icons[type]} text-xl"></i>
            <span class="font-medium">${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
        }, 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // ========== SETUP FUNCTIONS ==========
    function setupEventListeners() {
        // Slider listeners
        const participatingSlider = document.getElementById('participatingSlider');
        const totalWSSlider = document.getElementById('totalWSSlider');
        
        if (participatingSlider) {
            participatingSlider.addEventListener('input', function() {
                calculatorState.currentParticipatingTokens = parseInt(this.value);
                updateParticipationDisplays();
                updateGammaDisplay();
                debounceCalculation();
            });
        }
        
        if (totalWSSlider) {
            totalWSSlider.addEventListener('input', function() {
                calculatorState.currentTotalWS = parseInt(this.value);
                updateParticipationDisplays();
                updateGammaDisplay();
                debounceCalculation();
            });
        }
        
        // Auto-update toggle
        const autoUpdateToggle = document.getElementById('autoUpdateToggle');
        if (autoUpdateToggle) {
            autoUpdateToggle.addEventListener('change', function() {
                calculatorState.autoUpdateParticipation = this.checked;
                if (this.checked) {
                    updateParticipationEstimation();
                }
            });
        }
    }
    
    function initializeSliders() {
        // Set initial values
        updateParticipationUI();
    }
    
    function initializeTooltips() {
        // Tooltips are initialized via CSS hover
    }
    
    function setupTabs() {
        const tabs = document.querySelectorAll('.pro-tab');
        const contents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const target = this.textContent.trim().toLowerCase();
                switchTab(target);
            });
        });
    }
    
    function switchTab(tabName) {
        // Update tabs
        document.querySelectorAll('.pro-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Activate selected tab
        let targetTab, targetContent;
        
        switch(tabName) {
            case 'calculator':
                targetTab = document.querySelector('.pro-tab:nth-child(1)');
                targetContent = document.getElementById('tab-calculator');
                break;
            case 'simulator':
                targetTab = document.querySelector('.pro-tab:nth-child(2)');
                targetContent = document.getElementById('tab-simulator');
                break;
            case 'analysis':
                targetTab = document.querySelector('.pro-tab:nth-child(3)');
                targetContent = document.getElementById('tab-analysis');
                break;
            case 'formula':
                targetTab = document.querySelector('.pro-tab:nth-child(4)');
                targetContent = document.getElementById('tab-formula');
                break;
        }
        
        if (targetTab) targetTab.classList.add('active');
        if (targetContent) targetContent.classList.add('active');
    }
    
    function updateAllDisplays() {
        updateMetricDisplays();
        updateProgressBars();
        updateParticipationUI();
    }
    
    // ========== PUBLIC API ==========
    window.addTokenBatch = addTokenBatch;
    window.removeTokenBatch = removeTokenBatch;
    window.clearTokenBatches = clearTokenBatches;
    window.duplicateBatch = duplicateBatch;
    window.calculateRewards = calculateRewards;
    window.loadExampleCase = loadExampleCase;
    window.switchTab = switchTab;
    window.optimizeAgeBonus = function() {
        const rows = document.querySelectorAll('#token-batches-table tr[id^="batch-"]');
        rows.forEach(row => {
            const ageInput = row.querySelector('.batch-age');
            if (ageInput) {
                ageInput.value = MAX_AGE;
                const rowId = row.id;
                updateBatchCalculations(rowId);
            }
        });
        showProfessionalToast('Age bonus optimized to maximum', 'success');
    };
  </script>
</body>
</html>
