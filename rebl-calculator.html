<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RebelInuX Network Effects Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* === GLOBAL STYLES === */
        :root {
            --gold: #d4a76a;
            --red: #ff3366;
            --blue: #00aaff;
            --green: #4CAF50;
            --dark-bg: #0a0a0f;
            --card-bg: rgba(18, 18, 28, 0.95);
            --text-light: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.6);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark-bg);
            color: white;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, rgba(212, 167, 106, 0.1), rgba(255, 51, 102, 0.1));
            padding: 60px 0;
            text-align: center;
            border-bottom: 3px solid var(--gold);
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 50%, rgba(212, 167, 106, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 70% 20%, rgba(255, 51, 102, 0.05) 0%, transparent 50%);
        }
        
        .header h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--gold);
            text-shadow: 0 2px 10px rgba(212, 167, 106, 0.3);
            position: relative;
        }
        
        .header h1 i {
            margin-right: 15px;
        }
        
        .header p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto 30px;
            color: var(--text-light);
        }
        
        .key-insight {
            background: rgba(255, 51, 102, 0.15);
            border: 2px solid var(--red);
            border-radius: 12px;
            padding: 20px;
            max-width: 900px;
            margin: 30px auto;
            font-size: 1.1rem;
            font-weight: 600;
            position: relative;
        }
        
        .key-insight i {
            color: var(--red);
            margin-right: 10px;
        }
        
        /* === NAVIGATION === */
        .quick-nav {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        
        .nav-btn {
            background: rgba(0, 170, 255, 0.1);
            color: var(--blue);
            border: 2px solid var(--blue);
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: rgba(0, 170, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* === SECTION STYLES === */
        .section {
            background: var(--card-bg);
            border: 1px solid rgba(212, 167, 106, 0.2);
            border-radius: 16px;
            padding: 35px;
            margin: 35px 0;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: var(--gold);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        h2 {
            color: var(--gold);
            font-size: 2.2rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h3 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        /* === TOKEN BATCHES === */
        .batch-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: rgba(212, 167, 106, 0.1);
            color: var(--gold);
            border: 2px solid var(--gold);
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(212, 167, 106, 0.2);
            transform: translateY(-2px);
        }
        
        .control-btn.danger {
            background: rgba(255, 51, 102, 0.1);
            color: var(--red);
            border-color: var(--red);
        }
        
        .batch-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
        }
        
        .batch-table th {
            background: rgba(212, 167, 106, 0.2);
            color: var(--gold);
            font-weight: 700;
            padding: 18px;
            text-align: left;
            border-bottom: 3px solid var(--gold);
        }
        
        .batch-table td {
            padding: 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .batch-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(212, 167, 106, 0.3);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .batch-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 167, 106, 0.2);
        }
        
        .remove-btn {
            background: var(--red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-btn:hover {
            transform: scale(1.1);
            opacity: 0.9;
        }
        
        /* === STATS DISPLAY === */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 200px;
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--gold);
        }
        
        .stat-value.red {
            color: var(--red);
        }
        
        .stat-value.green {
            color: var(--green);
        }
        
        /* === SLIDER SECTION === */
        .slider-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 167, 106, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .slider-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: var(--gold);
            font-size: 1.1rem;
        }
        
        .slider-value-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .value-input {
            width: 160px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--gold);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            text-align: right;
        }
        
        .value-display {
            font-weight: 900;
            color: var(--red);
            font-size: 1.4rem;
            min-width: 120px;
            text-align: right;
        }
        
        .slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, var(--red), var(--gold));
            border-radius: 5px;
            margin: 20px 0;
            cursor: pointer;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
            border: 4px solid white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(212, 167, 106, 0.8);
        }
        
        .slider-stats {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* === GAMMA DISPLAY === */
        .gamma-container {
            text-align: center;
            margin: 40px 0;
        }
        
        .gamma-value {
            font-size: 3rem;
            font-weight: 900;
            color: var(--red);
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(255, 51, 102, 0.4);
        }
        
        .gamma-scale {
            position: relative;
            height: 35px;
            background: linear-gradient(90deg, var(--red), var(--gold), var(--green));
            border-radius: 18px;
            margin: 25px 0;
            overflow: hidden;
            border: 3px solid rgba(0, 0, 0, 0.3);
        }
        
        .gamma-marker {
            position: absolute;
            top: -8px;
            width: 8px;
            height: 50px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.9);
            transform: translateX(-50%);
            z-index: 10;
            transition: left 0.5s ease;
        }
        
        .gamma-labels {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: var(--text-muted);
            margin-top: 10px;
        }
        
        /* === NETWORK EFFECTS === */
        .network-effects {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--blue);
            border-radius: 16px;
            padding: 30px;
            margin: 40px 0;
        }
        
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        
        .effect-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            border-left: 5px solid;
        }
        
        .effect-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }
        
        .effect-card.positive {
            border-left-color: var(--green);
        }
        
        .effect-card.neutral {
            border-left-color: var(--gold);
        }
        
        .effect-card.negative {
            border-left-color: var(--red);
        }
        
        .effect-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .effect-icon {
            font-size: 1.8rem;
        }
        
        .effect-title {
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .effect-metric {
            font-size: 2.2rem;
            font-weight: 900;
            margin: 15px 0;
        }
        
        .effect-metric.positive {
            color: var(--green);
        }
        
        .effect-metric.negative {
            color: var(--red);
        }
        
        .effect-description {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        /* === SCENARIO BUTTONS === */
        .scenario-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        /* === RESULTS === */
        .results-container {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(212, 167, 106, 0.15));
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            margin: 50px 0;
            animation: fadeIn 0.8s ease;
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .main-reward {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--red);
            text-align: center;
            margin: 25px 0;
            text-shadow: 0 0 25px rgba(255, 51, 102, 0.5);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 35px 0;
        }
        
        .result-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            transform: translateY(-5px);
            background: rgba(0, 0, 0, 0.4);
        }
        
        .result-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--gold);
        }
        
        /* === PROJECTIONS === */
        .projections {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .projections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        /* === CALCULATE BUTTON === */
        .calculate-btn {
            background: linear-gradient(135deg, var(--red), var(--gold));
            color: white;
            border: none;
            padding: 22px 50px;
            border-radius: 60px;
            font-size: 1.3rem;
            font-weight: 900;
            cursor: pointer;
            display: block;
            margin: 50px auto;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        
        .calculate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s ease;
        }
        
        .calculate-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        .calculate-btn:hover::before {
            left: 100%;
        }
        
        .calculate-btn:active {
            transform: translateY(-2px);
        }
        
        .calculate-btn.loading {
            opacity: 0.8;
            cursor: not-allowed;
        }
        
        .calculate-btn.loading::after {
            content: '';
            position: absolute;
            right: 30px;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* === CHART === */
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 167, 106, 0.2);
            border-radius: 20px;
            padding: 35px;
            margin: 50px 0;
            min-height: 450px;
            position: relative;
        }
        
        .chart-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.2rem;
        }
        
        .chart-placeholder i {
            font-size: 5rem;
            margin-bottom: 25px;
            opacity: 0.3;
        }
        
        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 18px 30px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 450px;
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        .toast.success {
            border-color: var(--green);
            color: var(--green);
        }
        
        .toast.info {
            border-color: var(--blue);
            color: var(--blue);
        }
        
        .toast.warning {
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .toast.error {
            border-color: var(--red);
            color: var(--red);
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .quick-nav {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-btn, .control-btn {
                width: 100%;
                justify-content: center;
            }
            
            .slider-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .slider-value-display {
                width: 100%;
                justify-content: space-between;
            }
            
            .effects-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .main-reward {
                font-size: 2.5rem;
            }
            
            .calculate-btn {
                width: 100%;
                padding: 20px;
            }
            
            .batch-table {
                display: block;
                overflow-x: auto;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 40px 0;
            }
            
            .section {
                padding: 25px;
            }
            
            .stat-item {
                min-width: 100%;
            }
            
            .gamma-value {
                font-size: 2.2rem;
            }
            
            .results-container {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-project-diagram"></i> NETWORK EFFECTS CALCULATOR</h1>
            <p>Discover how OTHER PEOPLE'S $rebelinux holdings directly impact YOUR $REBL rewards</p>
            
            <div class="key-insight">
                <i class="fas fa-lightbulb"></i>
                <strong>KEY INSIGHT:</strong> Your rewards depend on BOTH your tokens AND community participation. 
                When others buy more, Gamma Scale (γ) increases, boosting EVERYONE'S rewards!
            </div>
            
            <div class="quick-nav">
                <button class="nav-btn" onclick="scrollToSection('your-tokens')">
                    <i class="fas fa-coins"></i> Your Tokens
                </button>
                <button class="nav-btn" onclick="scrollToSection('community')">
                    <i class="fas fa-users"></i> Community
                </button>
                <button class="nav-btn" onclick="scrollToSection('network-effects')">
                    <i class="fas fa-project-diagram"></i> Network Effects
                </button>
                <button class="nav-btn" onclick="calculateAll()">
                    <i class="fas fa-calculator"></i> Calculate Now
                </button>
            </div>
        </div>
    </header>

    <!-- Main Calculator -->
    <main class="container">
        <!-- Your Tokens Section -->
        <section id="your-tokens" class="section">
            <h2><i class="fas fa-wallet"></i> Your Token Holdings</h2>
            <p>Add each batch of $rebelinux you own with its age (epochs held, max 20).</p>
            
            <div class="batch-controls">
                <button class="control-btn" onclick="addTokenBatch()">
                    <i class="fas fa-plus"></i> Add Batch
                </button>
                <button class="control-btn" onclick="loadExample('starter')">
                    <i class="fas fa-user-graduate"></i> Starter (100K)
                </button>
                <button class="control-btn" onclick="loadExample('investor')">
                    <i class="fas fa-chart-line"></i> Investor (1M)
                </button>
                <button class="control-btn" onclick="loadExample('whale')">
                    <i class="fas fa-whale"></i> Whale (5M)
                </button>
                <button class="control-btn danger" onclick="clearAllBatches()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
            
            <table class="batch-table">
                <thead>
                    <tr>
                        <th>Amount ($rebelinux)</th>
                        <th>Age (Epochs)</th>
                        <th>Weight Factor</th>
                        <th>Weighted Share</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="batch-table-body">
                    <!-- Token batches will be added here -->
                </tbody>
            </table>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-label">Your Total Tokens</div>
                    <div id="total-tokens" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Your Weighted Share</div>
                    <div id="total-ws" class="stat-value red">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Average Age Bonus</div>
                    <div id="avg-bonus" class="stat-value green">1.00x</div>
                </div>
            </div>
        </section>

        <!-- Community Participation -->
        <section id="community" class="section">
            <h2><i class="fas fa-users"></i> Community Participation</h2>
            <p>Adjust these sliders to simulate different community participation levels.</p>
            
            <!-- Total Participating Tokens -->
            <div class="slider-container">
                <div class="slider-header">
                    <div class="slider-label">
                        <i class="fas fa-layer-group"></i>
                        Total Participating Tokens (P)
                    </div>
                    <div class="slider-value-display">
                        <input type="number" id="p-input" class="value-input" 
                               value="100000000" min="1000000" max="500000000" step="1000000">
                        <span id="p-display" class="value-display">100M</span>
                    </div>
                </div>
                <input type="range" id="p-slider" class="slider" 
                       min="1000000" max="500000000" step="1000000" value="100000000">
                <div class="slider-stats">
                    <span>Your share: <span id="your-share" style="color: var(--gold); font-weight: bold;">0%</span></span>
                    <span>Target for full γ: <span style="color: var(--green);">249.6M</span></span>
                    <span>% of CS: <span id="cs-percentage">20.0%</span></span>
                </div>
            </div>
            
            <!-- Total Weighted Shares -->
            <div class="slider-container">
                <div class="slider-header">
                    <div class="slider-label">
                        <i class="fas fa-calculator"></i>
                        Total Weighted Shares (∑WS)
                    </div>
                    <div class="slider-value-display">
                        <input type="number" id="ws-input" class="value-input" 
                               value="100000000" min="1000000" max="500000000" step="1000000">
                        <span id="ws-display" class="value-display">100M</span>
                    </div>
                </div>
                <input type="range" id="ws-slider" class="slider" 
                       min="1000000" max="500000000" step="1000000" value="100000000">
                <div class="slider-stats">
                    <span>Your WS share: <span id="your-ws-share" style="color: var(--gold); font-weight: bold;">0%</span></span>
                    <span>WS Multiplier: <span id="ws-multiplier" style="color: var(--green); font-weight: bold;">1.00x</span></span>
                    <span>(Typical: 1.2x-2.4x)</span>
                </div>
            </div>
            
            <!-- Gamma Display -->
            <div class="gamma-container">
                <h3><i class="fas fa-sliders-h"></i> Gamma Scale Factor (γ)</h3>
                <div class="gamma-value">γ = <span id="gamma-value">0.40</span></div>
                <div class="gamma-scale">
                    <div id="gamma-marker" class="gamma-marker" style="left: 40%;"></div>
                </div>
                <div class="gamma-labels">
                    <span>40% (Floor)</span>
                    <span>50% Participation</span>
                    <span>100% (Max)</span>
                </div>
                <p style="margin-top: 20px; color: var(--text-muted);">
                    γ adjusts based on TOTAL participation. Higher participation = Higher γ = Better rewards for everyone!
                </p>
            </div>
        </section>

        <!-- Network Effects -->
        <section id="network-effects" class="section">
            <h2><i class="fas fa-project-diagram"></i> Network Effects Analysis</h2>
            <p>See how changes in community participation affect YOUR rewards:</p>
            
            <div class="network-effects">
                <div id="effects-grid" class="effects-grid">
                    <!-- Network effects will be calculated here -->
                </div>
                
                <div style="margin-top: 30px;">
                    <h3><i class="fas fa-flask"></i> Quick Scenarios</h3>
                    <div class="scenario-buttons">
                        <button class="control-btn" onclick="runScenario('you-double')">
                            <i class="fas fa-user-plus"></i> You Double
                        </button>
                        <button class="control-btn" onclick="runScenario('others-double')">
                            <i class="fas fa-users"></i> Others Double
                        </button>
                        <button class="control-btn" onclick="runScenario('all-double')">
                            <i class="fas fa-globe"></i> Everyone Doubles
                        </button>
                        <button class="control-btn" style="background: rgba(76, 175, 80, 0.1); color: var(--green); border-color: var(--green);" 
                                onclick="runScenario('optimal')">
                            <i class="fas fa-star"></i> Optimal (50% CS)
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Calculate Button -->
        <button id="calculate-btn" class="calculate-btn" onclick="calculateAll()">
            <i class="fas fa-calculator"></i> CALCULATE YOUR REWARDS
        </button>

        <!-- Results Section -->
        <section id="results" class="results-container">
            <div style="text-align: center;">
                <h2><i class="fas fa-trophy"></i> Your Weekly Reward</h2>
                <div class="main-reward" id="weekly-reward">0 $REBL</div>
                <p style="color: var(--text-muted); margin-bottom: 30px;">
                    Based on current community participation levels
                </p>
            </div>
            
            <div class="results-grid">
                <div class="result-item">
                    <div class="result-label">Your Weighted Share</div>
                    <div class="result-value" id="result-ws">0</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Pool Share</div>
                    <div class="result-value" id="result-share">0%</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Gamma Scale (γ)</div>
                    <div class="result-value" id="result-gamma">0.40</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Effective Pool</div>
                    <div class="result-value" id="result-pool">1.28M $REBL</div>
                </div>
            </div>
            
            <div class="projections">
                <h3 style="text-align: center; margin-bottom: 25px;">
                    <i class="fas fa-calendar-alt"></i> Projections
                </h3>
                <div class="projections-grid">
                    <div class="result-item">
                        <div class="result-label">Monthly (approx.)</div>
                        <div class="result-value" id="monthly-proj">0 $REBL</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Annual (approx.)</div>
                        <div class="result-value" id="annual-proj">0 $REBL</div>
                    </div>
                </div>
                <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-top: 15px;">
                    Assumes consistent participation levels
                </p>
            </div>
        </section>

        <!-- Chart Section -->
        <section class="chart-container">
            <canvas id="reward-chart"></canvas>
            <div id="chart-placeholder" class="chart-placeholder">
                <i class="fas fa-chart-pie"></i>
                <p>Your reward distribution will appear here after calculation</p>
            </div>
        </section>
    </main>

    <script>
        // ============================================
        // GLOBAL CONSTANTS & STATE
        // ============================================
        const CS = 499242047;      // Circulating Supply
        const WERP = 3200000;      // Weekly Epoch Reward Pool
        const AGE_BONUS = 0.07;    // 7% per epoch
        const MAX_AGE = 20;        // Maximum age for bonus
        
        let rewardChart = null;
        let calculatorState = {
            totalUserTokens: 0,
            totalUserWS: 0,
            participatingTokens: 100000000,
            totalWS: 120000000,
            currentGamma: 0.4,
            baseReward: 0,
            isCalculating: false,
            calculationTimeout: null
        };
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Add initial batch
            addTokenBatch('100000', '5');
            
            // Setup event listeners
            setupEventListeners();
            
            // Update initial displays
            updateBatchCalculations();
            updateSliderDisplays();
            updateGammaDisplay();
            
            // Show welcome message
            setTimeout(() => {
                showToast('Welcome! Add your tokens and see how community participation affects your rewards.', 'info');
            }, 1000);
        });
        
        function setupEventListeners() {
            // Participating tokens input
            const pInput = document.getElementById('p-input');
            const pSlider = document.getElementById('p-slider');
            
            pInput.addEventListener('input', function() {
                let value = parseInt(this.value) || 0;
                value = Math.max(1000000, Math.min(500000000, value));
                this.value = value;
                pSlider.value = value;
                calculatorState.participatingTokens = value;
                updateSliderDisplays();
                scheduleCalculation();
            });
            
            pSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                pInput.value = value;
                calculatorState.participatingTokens = value;
                updateSliderDisplays();
                scheduleCalculation();
            });
            
            // Total WS input
            const wsInput = document.getElementById('ws-input');
            const wsSlider = document.getElementById('ws-slider');
            
            wsInput.addEventListener('input', function() {
                let value = parseInt(this.value) || 0;
                value = Math.max(1000000, Math.min(500000000, value));
                this.value = value;
                wsSlider.value = value;
                calculatorState.totalWS = value;
                updateSliderDisplays();
                scheduleCalculation();
            });
            
            wsSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                wsInput.value = value;
                calculatorState.totalWS = value;
                updateSliderDisplays();
                scheduleCalculation();
            });
            
            // Input validation for batch inputs
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('batch-input')) {
                    const batchId = e.target.dataset.batchId;
                    if (batchId) updateBatch(batchId);
                }
            });
        }
        
        // ============================================
        // TOKEN BATCH FUNCTIONS
        // ============================================
        function addTokenBatch(amount = '', age = '') {
            const tableBody = document.getElementById('batch-table-body');
            const batchId = 'batch-' + Date.now();
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="number" class="batch-input" data-batch-id="${batchId}" 
                           value="${amount}" placeholder="e.g., 100000" min="0" step="1000">
                </td>
                <td>
                    <input type="number" class="batch-input" data-batch-id="${batchId}" 
                           value="${age}" placeholder="0-20" min="0" max="20" step="1">
                </td>
                <td class="batch-factor" style="text-align: center; font-weight: bold; color: var(--gold);">1.00</td>
                <td class="batch-ws" style="text-align: center; font-weight: bold; color: var(--red);">0</td>
                <td style="text-align: center;">
                    <button class="remove-btn" onclick="removeBatch('${batchId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Animate in
            row.style.opacity = '0';
            row.style.transform = 'translateY(20px)';
            setTimeout(() => {
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '1';
                row.style.transform = 'translateY(0)';
            }, 10);
            
            // Update calculations if values were provided
            if (amount || age) {
                setTimeout(() => updateBatch(batchId), 50);
            }
        }
        
        function removeBatch(batchId) {
            const row = document.querySelector(`tr input[data-batch-id="${batchId}"]`)?.closest('tr');
            if (!row) return;
            
            row.style.transform = 'translateX(-100%)';
            row.style.opacity = '0';
            
            setTimeout(() => {
                row.remove();
                updateBatchCalculations();
                scheduleCalculation();
            }, 300);
        }
        
        function updateBatch(batchId) {
            const row = document.querySelector(`tr input[data-batch-id="${batchId}"]`)?.closest('tr');
            if (!row) return;
            
            const amountInput = row.querySelector('input[data-batch-id]:nth-child(1)');
            const ageInput = row.querySelector('input[data-batch-id]:nth-child(2)');
            
            let amount = parseFloat(amountInput.value) || 0;
            let age = parseFloat(ageInput.value) || 0;
            
            // Validate inputs
            if (amount < 0) amount = 0;
            if (age < 0) age = 0;
            if (age > MAX_AGE) {
                age = MAX_AGE;
                ageInput.value = MAX_AGE;
            }
            
            // Update displays
            amountInput.value = amount;
            ageInput.value = age;
            
            // Calculate weight factor and weighted share
            const weightFactor = 1 + (AGE_BONUS * Math.min(age, MAX_AGE));
            const weightedShare = amount * weightFactor;
            
            const factorCell = row.querySelector('.batch-factor');
            const wsCell = row.querySelector('.batch-ws');
            
            factorCell.textContent = weightFactor.toFixed(2);
            factorCell.style.color = weightFactor > 1 ? 'var(--gold)' : 'white';
            
            wsCell.textContent = formatNumber(weightedShare, true);
            wsCell.style.color = 'var(--red)';
            
            // Update totals
            updateBatchCalculations();
        }
        
        function updateBatchCalculations() {
            const rows = document.querySelectorAll('#batch-table-body tr');
            let totalTokens = 0;
            let totalWS = 0;
            
            rows.forEach(row => {
                const amount = parseFloat(row.querySelector('input[data-batch-id]:nth-child(1)').value) || 0;
                const wsText = row.querySelector('.batch-ws').textContent;
                const ws = parseFloat(wsText.replace(/,/g, '')) || 0;
                
                totalTokens += amount;
                totalWS += ws;
            });
            
            calculatorState.totalUserTokens = totalTokens;
            calculatorState.totalUserWS = totalWS;
            
            // Update displays
            document.getElementById('total-tokens').textContent = formatNumber(totalTokens);
            document.getElementById('total-ws').textContent = formatNumber(totalWS, true);
            
            // Calculate average bonus
            const avgBonus = totalTokens > 0 ? (totalWS / totalTokens).toFixed(2) : '1.00';
            const avgBonusElement = document.getElementById('avg-bonus');
            avgBonusElement.textContent = `${avgBonus}x`;
            
            // Color code average bonus
            if (avgBonus >= 2.0) {
                avgBonusElement.style.color = 'var(--green)';
            } else if (avgBonus >= 1.5) {
                avgBonusElement.style.color = 'var(--gold)';
            } else if (avgBonus > 1.0) {
                avgBonusElement.style.color = '#ff9800';
            } else {
                avgBonusElement.style.color = 'white';
            }
            
            // Update slider displays
            updateSliderDisplays();
        }
        
        // ============================================
        // SLIDER & GAMMA FUNCTIONS
        // ============================================
        function updateSliderDisplays() {
            const { participatingTokens, totalWS, totalUserTokens, totalUserWS } = calculatorState;
            
            // Update value displays
            document.getElementById('p-display').textContent = formatNumber(participatingTokens);
            document.getElementById('ws-display').textContent = formatNumber(totalWS);
            
            // Calculate statistics
            const userShare = participatingTokens > 0 ? (totalUserTokens / participatingTokens * 100).toFixed(2) : '0.00';
            const userWSShare = totalWS > 0 ? (totalUserWS / totalWS * 100).toFixed(2) : '0.00';
            const csPercentage = (participatingTokens / CS * 100).toFixed(1);
            const wsMultiplier = participatingTokens > 0 ? (totalWS / participatingTokens).toFixed(2) : '1.00';
            
            // Update statistics displays
            document.getElementById('your-share').textContent = `${userShare}%`;
            document.getElementById('your-ws-share').textContent = `${userWSShare}%`;
            document.getElementById('cs-percentage').textContent = `${csPercentage}%`;
            
            const multiplierElement = document.getElementById('ws-multiplier');
            multiplierElement.textContent = `${wsMultiplier}x`;
            
            // Color code multiplier
            if (wsMultiplier >= 2.0) {
                multiplierElement.style.color = 'var(--green)';
            } else if (wsMultiplier >= 1.5) {
                multiplierElement.style.color = 'var(--gold)';
            } else {
                multiplierElement.style.color = 'white';
            }
            
            // Update gamma
            updateGammaDisplay();
        }
        
        function updateGammaDisplay() {
            const { participatingTokens, totalWS } = calculatorState;
            
            // Calculate gamma: γ = MAX(0.4, MIN(1, P/(0.5×CS), CS/∑WS))
            const participationTerm = participatingTokens / (0.5 * CS);
            const inflationCap = CS / totalWS;
            const minTerm = Math.min(1, participationTerm, inflationCap);
            const gamma = Math.max(0.4, minTerm);
            
            calculatorState.currentGamma = gamma;
            
            // Update gamma value display
            const gammaValueElement = document.getElementById('gamma-value');
            gammaValueElement.textContent = gamma.toFixed(2);
            
            // Color code gamma value
            if (gamma >= 1.0) {
                gammaValueElement.style.color = 'var(--green)';
            } else if (gamma >= 0.8) {
                gammaValueElement.style.color = '#ffff00';
            } else if (gamma >= 0.6) {
                gammaValueElement.style.color = 'var(--gold)';
            } else if (gamma >= 0.4) {
                gammaValueElement.style.color = '#ff9900';
            } else {
                gammaValueElement.style.color = 'var(--red)';
            }
            
            // Update gamma marker position
            const marker = document.getElementById('gamma-marker');
            const position = 40 + (gamma - 0.4) * (100 / 0.6);
            marker.style.left = `${Math.min(100, Math.max(0, position))}%`;
            
            return gamma;
        }
        
        // ============================================
        // MAIN CALCULATION FUNCTION
        // ============================================
        function calculateAll() {
            if (calculatorState.isCalculating) return;
            
            calculatorState.isCalculating = true;
            const calculateBtn = document.getElementById('calculate-btn');
            calculateBtn.classList.add('loading');
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CALCULATING...';
            
            // Clear any pending calculation
            if (calculatorState.calculationTimeout) {
                clearTimeout(calculatorState.calculationTimeout);
            }
            
            calculatorState.calculationTimeout = setTimeout(() => {
                try {
                    const { totalUserWS, totalWS, currentGamma } = calculatorState;
                    
                    // Validate we have data
                    if (totalUserWS === 0 || totalWS === 0) {
                        showToast('Please add your token batches first', 'warning');
                        resetCalculateButton();
                        return;
                    }
                    
                    // Calculate user's share and reward
                    const userShare = totalWS > 0 ? totalUserWS / totalWS : 0;
                    const userReward = userShare * WERP * currentGamma;
                    const effectivePool = WERP * currentGamma;
                    
                    // Store base reward (without gamma) for comparison
                    calculatorState.baseReward = userShare * WERP;
                    
                    // Update results display
                    updateResultsDisplay(userReward, userShare, currentGamma, effectivePool);
                    
                    // Calculate and display network effects
                    calculateNetworkEffects(userReward);
                    
                    // Update chart
                    updateChart();
                    
                    // Show results section with animation
                    const resultsContainer = document.getElementById('results');
                    resultsContainer.style.display = 'block';
                    resultsContainer.style.animation = 'fadeIn 0.8s ease';
                    
                    // Scroll to results
                    setTimeout(() => {
                        resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                    
                    showToast('Rewards calculated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Calculation error:', error);
                    showToast('Error calculating rewards. Please check your inputs.', 'error');
                } finally {
                    resetCalculateButton();
                }
            }, 800);
        }
        
        function updateResultsDisplay(userReward, userShare, gamma, effectivePool) {
            // Main reward display
            document.getElementById('weekly-reward').textContent = `${formatNumber(userReward, true)} $REBL`;
            
            // Details
            document.getElementById('result-ws').textContent = formatNumber(calculatorState.totalUserWS, true);
            document.getElementById('result-share').textContent = (userShare * 100).toFixed(4) + '%';
            document.getElementById('result-gamma').textContent = gamma.toFixed(2);
            document.getElementById('result-pool').textContent = `${formatNumber(effectivePool)} $REBL`;
            
            // Projections
            document.getElementById('monthly-proj').textContent = `${formatNumber(userReward * 4.33, true)} $REBL`;
            document.getElementById('annual-proj').textContent = `${formatNumber(userReward * 52, true)} $REBL`;
        }
        
        // ============================================
        // NETWORK EFFECTS CALCULATION
        // ============================================
        function calculateNetworkEffects(currentReward) {
            const { totalUserTokens, totalUserWS, participatingTokens, totalWS } = calculatorState;
            
            if (currentReward === 0) {
                document.getElementById('effects-grid').innerHTML = `
                    <div class="effect-card">
                        <div class="effect-header">
                            <i class="fas fa-info-circle effect-icon"></i>
                            <div class="effect-title">No Data Yet</div>
                        </div>
                        <div class="effect-description">
                            Add your tokens and calculate rewards to see network effects.
                        </div>
                    </div>
                `;
                return;
            }
            
            // Calculate different scenarios
            const scenarios = [
                {
                    title: 'You Double Tokens',
                    icon: 'fa-user-plus',
                    description: 'If YOU double your tokens but community participation stays the same',
                    calculate: () => {
                        const newUserTokens = totalUserTokens * 2;
                        const newUserWS = totalUserWS * 2;
                        const newTotalWS = totalWS + totalUserWS; // Add only user's increase
                        return calculateScenarioReward(newUserTokens, newUserWS, participatingTokens, newTotalWS);
                    }
                },
                {
                    title: 'Others Double Tokens',
                    icon: 'fa-users',
                    description: 'If OTHERS double their tokens but you stay the same',
                    calculate: () => {
                        const newParticipating = Math.min(CS, participatingTokens * 2);
                        const newTotalWS = Math.min(CS * 2.4, totalWS * 2);
                        return calculateScenarioReward(totalUserTokens, totalUserWS, newParticipating, newTotalWS);
                    }
                },
                {
                    title: 'Everyone Doubles',
                    icon: 'fa-globe',
                    description: 'If EVERYONE doubles their tokens proportionally',
                    calculate: () => {
                        const newUserTokens = totalUserTokens * 2;
                        const newUserWS = totalUserWS * 2;
                        const newParticipating = Math.min(CS, participatingTokens * 2);
                        const newTotalWS = Math.min(CS * 2.4, totalWS * 2);
                        return calculateScenarioReward(newUserTokens, newUserWS, newParticipating, newTotalWS);
                    }
                },
                {
                    title: 'Optimal Participation',
                    icon: 'fa-star',
                    description: 'If participation reaches 50% of circulating supply',
                    calculate: () => {
                        const optimalTokens = 0.5 * CS;
                        const optimalWS = optimalTokens * 1.6; // Average 60% age bonus
                        return calculateScenarioReward(totalUserTokens, totalUserWS, optimalTokens, optimalWS);
                    }
                }
            ];
            
            // Build effects grid
            let effectsHTML = '';
            
            scenarios.forEach(scenario => {
                const result = scenario.calculate();
                const percentageChange = ((result.reward / currentReward - 1) * 100).toFixed(1);
                
                // Determine card type based on change
                let cardType = 'neutral';
                if (percentageChange > 5) cardType = 'positive';
                else if (percentageChange < -5) cardType = 'negative';
                
                effectsHTML += `
                    <div class="effect-card ${cardType}">
                        <div class="effect-header">
                            <i class="fas ${scenario.icon} effect-icon"></i>
                            <div class="effect-title">${scenario.title}</div>
                        </div>
                        <div class="effect-metric ${percentageChange >= 0 ? 'positive' : 'negative'}">
                            ${percentageChange > 0 ? '+' : ''}${percentageChange}%
                        </div>
                        <div class="effect-description">
                            ${scenario.description}<br><br>
                            <strong>New Reward:</strong> ${formatNumber(result.reward, true)} $REBL<br>
                            <strong>New Gamma:</strong> ${result.gamma.toFixed(2)}<br>
                            ${getScenarioInsight(percentageChange, scenario.title)}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('effects-grid').innerHTML = effectsHTML;
        }
        
        function calculateScenarioReward(userTokens, userWS, participatingTokens, totalWS) {
            // Calculate gamma for scenario
            const participationTerm = participatingTokens / (0.5 * CS);
            const inflationCap = CS / totalWS;
            const minTerm = Math.min(1, participationTerm, inflationCap);
            const gamma = Math.max(0.4, minTerm);
            
            // Calculate reward
            const userShare = totalWS > 0 ? userWS / totalWS : 0;
            const reward = userShare * WERP * gamma;
            
            return {
                reward: reward,
                gamma: gamma,
                userShare: userShare
            };
        }
        
        function getScenarioInsight(percentageChange, scenarioTitle) {
            if (scenarioTitle === 'Others Double Tokens' && percentageChange > 0) {
                return '<em>Key insight: Others growing helps YOU more than you growing alone!</em>';
            } else if (scenarioTitle === 'Optimal Participation' && percentageChange > 0) {
                return '<em>Collective growth unlocks maximum rewards for everyone</em>';
            } else if (scenarioTitle === 'Everyone Doubles' && Math.abs(percentageChange) < 5) {
                return '<em>Proportional growth maintains your relative position</em>';
            }
            return '';
        }
        
        // ============================================
        // SCENARIO RUNNERS
        // ============================================
        function runScenario(scenario) {
            const { participatingTokens, totalWS } = calculatorState;
            
            let newParticipating, newTotalWS;
            
            switch(scenario) {
                case 'you-double':
                    showToast('See "You Double Tokens" in Network Effects analysis', 'info');
                    break;
                    
                case 'others-double':
                    newParticipating = Math.min(500000000, participatingTokens * 2);
                    newTotalWS = Math.min(500000000, totalWS * 2);
                    updateSliders(newParticipating, newTotalWS);
                    showToast('Simulating: Community participation doubles', 'info');
                    break;
                    
                case 'all-double':
                    newParticipating = Math.min(500000000, participatingTokens * 2);
                    newTotalWS = Math.min(500000000, totalWS * 2);
                    updateSliders(newParticipating, newTotalWS);
                    showToast('Simulating: Everyone doubles their holdings', 'info');
                    break;
                    
                case 'optimal':
                    newParticipating = 250000000; // 50% of CS
                    newTotalWS = 375000000; // 1.5x multiplier
                    updateSliders(newParticipating, newTotalWS);
                    showToast('Simulating: Optimal 50% community participation', 'info');
                    break;
            }
        }
        
        function updateSliders(newParticipating, newTotalWS) {
            document.getElementById('p-input').value = newParticipating;
            document.getElementById('p-slider').value = newParticipating;
            document.getElementById('ws-input').value = newTotalWS;
            document.getElementById('ws-slider').value = newTotalWS;
            
            calculatorState.participatingTokens = newParticipating;
            calculatorState.totalWS = newTotalWS;
            
            updateSliderDisplays();
            scheduleCalculation();
        }
        
        // ============================================
        // EXAMPLE LOADERS
        // ============================================
        function loadExample(type) {
            clearAllBatches();
            
            setTimeout(() => {
                let batches = [];
                let newParticipating, newTotalWS;
                
                switch(type) {
                    case 'starter':
                        batches = [
                            { amount: '50000', age: '3' },
                            { amount: '25000', age: '8' },
                            { amount: '25000', age: '1' }
                        ];
                        newParticipating = 50000000;
                        newTotalWS = 65000000;
                        break;
                        
                    case 'investor':
                        batches = [
                            { amount: '500000', age: '5' },
                            { amount: '300000', age: '10' },
                            { amount: '200000', age: '15' }
                        ];
                        newParticipating = 150000000;
                        newTotalWS = 210000000;
                        break;
                        
                    case 'whale':
                        batches = [
                            { amount: '2000000', age: '8' },
                            { amount: '2000000', age: '12' },
                            { amount: '1000000', age: '18' }
                        ];
                        newParticipating = 300000000;
                        newTotalWS = 450000000;
                        break;
                }
                
                // Add batches
                batches.forEach(batch => {
                    addTokenBatch(batch.amount, batch.age);
                });
                
                // Update community participation
                updateSliders(newParticipating, newTotalWS);
                
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} example loaded`, 'success');
                
                // Calculate after delay
                setTimeout(() => {
                    calculateAll();
                    scrollToSection('network-effects');
                }, 800);
            }, 300);
        }
        
        function clearAllBatches() {
            const tableBody = document.getElementById('batch-table-body');
            tableBody.innerHTML = '';
            addTokenBatch();
            updateBatchCalculations();
        }
        
        // ============================================
        // CHART FUNCTIONS
        // ============================================
        function updateChart() {
            const ctx = document.getElementById('reward-chart');
            if (!ctx) return;
            
            const placeholder = document.getElementById('chart-placeholder');
            if (placeholder) placeholder.style.display = 'none';
            ctx.style.display = 'block';
            
            // Destroy existing chart
            if (rewardChart) {
                rewardChart.destroy();
            }
            
            // Get batch data
            const rows = document.querySelectorAll('#batch-table-body tr');
            const batchData = [];
            const labels = [];
            const colors = [
                'rgba(255, 51, 102, 0.8)',
                'rgba(212, 167, 106, 0.8)',
                'rgba(0, 170, 255, 0.8)',
                'rgba(156, 39, 176, 0.8)',
                'rgba(76, 175, 80, 0.8)',
                'rgba(255, 152, 0, 0.8)',
                'rgba(33, 150, 243, 0.8)',
                'rgba(233, 30, 99, 0.8)'
            ];
            
            rows.forEach((row, index) => {
                const amount = parseFloat(row.querySelector('input[data-batch-id]:nth-child(1)').value) || 0;
                if (amount > 0) {
                    const wsText = row.querySelector('.batch-ws').textContent;
                    const ws = parseFloat(wsText.replace(/,/g, '')) || 0;
                    batchData.push(ws);
                    labels.push(`Batch ${index + 1}`);
                }
            });
            
            if (batchData.length === 0) {
                if (placeholder) placeholder.style.display = 'flex';
                ctx.style.display = 'none';
                return;
            }
            
            // Create chart
            rewardChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: batchData,
                        backgroundColor: colors.slice(0, batchData.length),
                        borderColor: 'rgba(0, 0, 0, 0.3)',
                        borderWidth: 2,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'white',
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: 'var(--gold)',
                            bodyColor: 'white',
                            borderColor: 'var(--gold)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const total = calculatorState.totalUserWS;
                                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${formatNumber(context.raw, true)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1000
                    },
                    cutout: '60%'
                }
            });
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatNumber(num, showDecimals = false) {
            if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return '0';
            
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(showDecimals ? 2 : 1) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(showDecimals ? 2 : 1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(showDecimals ? 2 : 1) + 'K';
            }
            
            return num.toLocaleString(undefined, {
                minimumFractionDigits: showDecimals ? 2 : 0,
                maximumFractionDigits: showDecimals ? 2 : 0
            });
        }
        
        function scheduleCalculation() {
            if (calculatorState.calculationTimeout) {
                clearTimeout(calculatorState.calculationTimeout);
            }
            
            calculatorState.calculationTimeout = setTimeout(() => {
                calculateAll();
            }, 1500);
        }
        
        function resetCalculateButton() {
            const calculateBtn = document.getElementById('calculate-btn');
            calculateBtn.classList.remove('loading');
            calculateBtn.innerHTML = '<i class="fas fa-calculator"></i> CALCULATE YOUR REWARDS';
            calculatorState.isCalculating = false;
        }
        
        function showToast(message, type = 'info') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon;
            switch(type) {
                case 'success': icon = 'check-circle'; break;
                case 'warning': icon = 'exclamation-triangle'; break;
                case 'error': icon = 'times-circle'; break;
                default: icon = 'info-circle';
            }
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%) scale(0.8)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Make functions globally available
        window.addTokenBatch = addTokenBatch;
        window.removeBatch = removeBatch;
        window.clearAllBatches = clearAllBatches;
        window.loadExample = loadExample;
        window.runScenario = runScenario;
        window.calculateAll = calculateAll;
        window.scrollToSection = scrollToSection;
    </script>
</body>
</html>
