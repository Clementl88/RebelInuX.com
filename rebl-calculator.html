<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="RebelInuX Sustainable Reward Calculator - Calculate $REBL rewards using the new sustainable formula with Gamma Scale Factor" />
  <meta name="keywords" content="RebelInuX calculator, $REBL rewards, epoch calculator, sustainable formula, gamma scale factor" />
  <meta property="og:title" content="RebelInuX Sustainable Reward Calculator" />
  <meta property="og:image" content="images/Logo_REBL.svg" />
  <meta property="og:description" content="Calculate your $REBL rewards using the sustainable formula with Gamma Scale Factor (γ) simulation" />
  <meta property="og:url" content="https://rebelinux.fun/rebl-calculator.html" />
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="RebelInuX">
  <meta name="twitter:title" content="RebelInuX Sustainable Reward Calculator">
  <meta name="twitter:description" content="Calculate your $REBL rewards using the sustainable formula with Gamma Scale Factor (γ) simulation">
  <meta name="twitter:card" content="summary_large_image" />
  
  <!-- Favicons -->
  <link rel="icon" href="images/Logo_REBL.svg">
  <link rel="apple-touch-icon" href="images/Logo_REBL.svg">
  <title>RebelInuX Sustainable Reward Calculator</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>

  <!-- CSS Files -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/header-footer.css">
  <link rel="stylesheet" href="css/rebl-calculator.css">

  <!-- Enhanced Calculator Styles -->
  <style>
    /* Toast notifications */
    .calculator-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      animation: toastIn 0.3s ease;
      backdrop-filter: blur(10px);
      max-width: 350px;
    }
    
    .calculator-toast-success {
      background: rgba(76, 175, 80, 0.9);
      color: white;
      border: 1px solid rgba(76, 175, 80, 0.5);
    }
    
    .calculator-toast-info {
      background: rgba(33, 150, 243, 0.9);
      color: white;
      border: 1px solid rgba(33, 150, 243, 0.5);
    }
    
    .calculator-toast-warning {
      background: rgba(255, 193, 7, 0.9);
      color: black;
      border: 1px solid rgba(255, 193, 7, 0.5);
    }
    
    .calculator-toast-error {
      background: rgba(255, 51, 102, 0.9);
      color: white;
      border: 1px solid rgba(255, 51, 102, 0.5);
    }
    
    .toast-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    @keyframes toastIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes toastOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Gamma display enhancements */
    .gamma-display-enhanced {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .gamma-calculated {
      color: #ff9900;
      font-size: 0.9rem;
    }
    
    .gamma-effective {
      color: #4CAF50;
      font-size: 1.1rem;
    }
    
    .gamma-floor-indicator {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(255, 51, 102, 0.2);
      border: 1px solid var(--rebel-red);
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--rebel-red);
      margin-left: 8px;
    }
    
    /* Real data comparison */
    .real-data-comparison {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(212, 167, 106, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .real-data-header {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--rebel-gold);
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .real-data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      font-size: 0.9rem;
    }
    
    .real-data-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .real-data-label {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .real-data-value {
      color: var(--rebel-gold);
      font-weight: 600;
    }
    
    /* Improved WS calculation info */
    .ws-calculation-details {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(212, 167, 106, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.85rem;
    }
    
    .ws-formula {
      font-family: 'Courier New', monospace;
      color: var(--rebel-gold);
      margin: 5px 0;
    }
    
    /* Enhanced results panel */
    .results-enhanced {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(212, 167, 106, 0.15));
      border: 2px solid var(--rebel-gold);
      border-radius: 10px;
      padding: 20px;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(212, 167, 106, 0.3);
    }
    
    .results-title {
      color: var(--rebel-gold);
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .results-accuracy {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .gamma-display-enhanced {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      
      .real-data-grid {
        grid-template-columns: 1fr;
      }
      
      .results-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Animation -->
  <div class="loader" id="loader">
    <div class="loader-spinner"></div>
  </div>
  
  <!-- Back to Top Button -->
  <div class="back-to-top" id="backToTop">
    <i class="fas fa-arrow-up"></i>
  </div>
  
  <!-- Header will be inserted here by JavaScript -->
  <div id="header-container"></div>
  
  <main>
    <!-- Hero Section -->
    <section class="page-hero page-hero--calculator">
      <div class="container">
        <h1>SUSTAINABLE REWARD CALCULATOR</h1>
        <p class="text-lead">Calculate your $REBL rewards using the new sustainable formula with Gamma Scale Factor (γ) simulation. Plan your strategy based on participation levels!</p>
        <div class="hero-buttons">
          <a href="#rebl-calculator" class="cta-button">
            <i class="fas fa-calculator"></i> Start Calculating
          </a>
          <a href="#calculator-faq" class="cta-button gold">
            <i class="fas fa-question-circle"></i> FAQ & Help
          </a>
          <a href="epoch-rewards.html" class="cta-button">
            <i class="fas fa-gift"></i> View Epoch Rewards
          </a>
        </div>
      </div>
    </section>

    <!-- Formula Announcement -->
    <section id="formula-announcement">
      <div class="container">
        <div class="announcement-banner calculator-announcement">
          <h3><i class="fas fa-bullhorn"></i> NEW SUSTAINABLE FORMULA (Effective Epoch 15)</h3>
          <div class="formula-display">
            <div class="formula-equation">
              Rewardᵢ = (WSᵢ / ∑WS) × 3,200,000 × MAX(0.4, γ)
            </div>
            <div class="formula-component">
              γ = MIN(1, P/(0.5 × CS), CS/∑WS)
            </div>
          </div>
          <p><strong>Based on Actual Epoch Data:</strong> 40% minimum rewards guaranteed, scales up with participation.</p>
        </div>
      </div>
    </section>

    <!-- Main Calculator -->
    <section id="rebl-calculator">
      <div class="container">
        <h2><i class="fas fa-calculator"></i> Sustainable Reward Calculator</h2>
        
        <!-- Real Data Comparison -->
        <div class="real-data-comparison">
          <div class="real-data-header">
            <i class="fas fa-database"></i> Based on Previous Epoch Data
          </div>
          <div class="real-data-grid">
            <div class="real-data-item">
              <span class="real-data-label">Total Participants:</span>
              <span class="real-data-value">6</span>
            </div>
            <div class="real-data-item">
              <span class="real-data-label">Total Tokens (P):</span>
              <span class="real-data-value">42.16M</span>
            </div>
            <div class="real-data-item">
              <span class="real-data-label">Total WS (∑WS):</span>
              <span class="real-data-value">49.66M</span>
            </div>
            <div class="real-data-item">
              <span class="real-data-label">Calculated γ:</span>
              <span class="real-data-value">0.169</span>
            </div>
            <div class="real-data-item">
              <span class="real-data-label">Effective γ (40% floor):</span>
              <span class="real-data-value">0.400</span>
            </div>
            <div class="real-data-item">
              <span class="real-data-label">Actual Distribution:</span>
              <span class="real-data-value">1,280,000 $REBL</span>
            </div>
          </div>
        </div>
        
        <!-- Your Token Batches -->
        <div class="calculator-section token-batches-section">
          <div class="section-header">
            <h3><i class="fas fa-layer-group"></i> Your Token Batches</h3>
            <div class="example-buttons">
              <button onclick="loadExampleCase('starter')" class="example-btn">
                <i class="fas fa-user-graduate"></i> Starter
              </button>
              <button onclick="loadExampleCase('investor')" class="example-btn">
                <i class="fas fa-chart-line"></i> Investor
              </button>
              <button onclick="loadExampleCase('whale')" class="example-btn">
                <i class="fas fa-whale"></i> Whale
              </button>
            </div>
          </div>
          
          <div class="table-actions">
            <button onclick="addTokenBatch()" class="table-action-btn">
              <i class="fas fa-plus"></i> Add Batch
            </button>
            <button onclick="clearTokenBatches()" class="table-action-btn" style="background: rgba(255, 51, 102, 0.1); color: var(--rebel-red); border-color: var(--rebel-red);">
              <i class="fas fa-trash"></i> Clear All
            </button>
          </div>
          
          <div class="table-container">
            <table id="token-batches-table">
              <thead>
                <tr>
                  <th>$rebelinux Amount</th>
                  <th>Age (Epochs)</th>
                  <th>Weight Factor</th>
                  <th>WSᵢ (Weighted Share)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
          
          <div class="ws-calculation-details">
            <div><strong>WSᵢ Calculation:</strong> Token Amount × (1 + 0.07 × min(Age, 20))</div>
            <div class="ws-formula">Example: 1,000,000 tokens × (1 + 0.07 × 5 epochs) = 1,350,000 WS</div>
            <div>Your total tokens: <span id="userTokenSum" style="color: var(--rebel-gold); font-weight: 600;">0</span> | Your total WS: <span id="userWSSum" style="color: var(--rebel-red); font-weight: 600;">0</span></div>
          </div>
        </div>

        <!-- Participation Settings -->
        <div class="calculator-section participation-settings">
          <h3><i class="fas fa-users"></i> Participation Settings</h3>
          
          <div class="slider-group">
            <div class="slider-container">
              <div class="slider-info">
                <div class="slider-info-label">
                  <span>Total Participating Tokens (P):</span>
                  <i class="fas fa-question-circle slider-info-help" title="Total tokens participating in this epoch. Based on previous epoch: 42.16M"></i>
                </div>
                <div class="slider-info-value">
                  <input type="number" id="participatingTokensInput" class="value-input" 
                         value="42156824" min="1000000" max="500000000" step="100000">
                  <span id="participatingTokensValue" class="slider-value">42.2M</span>
                </div>
              </div>
              <input type="range" id="participatingTokens" min="1000000" max="500000000" step="100000" value="42156824" oninput="updateParticipation()" class="slider">
              <div class="input-hint">
                Previous epoch: 42.16M (8.4% of CS) | Target for 100% γ: 249.62M (50% of CS)
              </div>
            </div>
            
            <div class="slider-container">
              <div class="slider-info">
                <div class="slider-info-label">
                  <span>Total Weighted Shares (∑WS):</span>
                  <i class="fas fa-question-circle slider-info-help" title="Total weighted shares including age bonuses. Based on previous epoch: 49.66M"></i>
                </div>
                <div class="slider-info-value">
                  <input type="number" id="totalWSInput" class="value-input" 
                         value="49655085" min="1000000" max="500000000" step="100000">
                  <span id="totalWSValue" class="slider-value">49.7M</span>
                </div>
              </div>
              <input type="range" id="totalWS" min="1000000" max="500000000" step="100000" value="49655085" oninput="updateParticipation()" class="slider">
              <div class="input-hint">
                Previous epoch: 49.66M | WS Multiplier: <span id="wsMultiplierCurrent">1.18x</span> | Your share: <span id="yourWSShare">0%</span>
              </div>
            </div>
          </div>
          
          <!-- Gamma Calculation Details -->
          <div class="gamma-calculation-details">
            <h4><i class="fas fa-calculator"></i> Gamma Scale Factor (γ) Calculation</h4>
            <div class="gamma-components-enhanced">
              <div class="gamma-component-enhanced">
                <div class="component-label">P/(0.5×CS) =</div>
                <div id="participationTerm" class="component-value">0.169</div>
                <div class="component-explanation">Participation Scaling</div>
              </div>
              <div class="gamma-component-enhanced">
                <div class="component-label">CS/∑WS =</div>
                <div id="inflationCap" class="component-value">10.054</div>
                <div class="component-explanation">Age Inflation Cap</div>
              </div>
              <div class="gamma-component-enhanced">
                <div class="component-label">MIN(1, ...) =</div>
                <div id="minTerm" class="component-value">0.169</div>
                <div class="component-explanation">Minimum of terms</div>
              </div>
              <div class="gamma-component-enhanced">
                <div class="component-label">MAX(0.4, ...) =</div>
                <div id="maxTerm" class="component-value">0.400</div>
                <div class="component-explanation">Final Gamma Scale</div>
              </div>
            </div>
            
            <div class="gamma-display-enhanced">
              <div>
                <span style="color: rgba(255, 255, 255, 0.7);">Calculated γ:</span>
                <span id="gammaCalculated" class="gamma-calculated">0.169</span>
              </div>
              <div style="color: rgba(255, 255, 255, 0.7);">→</div>
              <div>
                <span style="color: rgba(255, 255, 255, 0.7);">Effective γ:</span>
                <span id="gammaEffective" class="gamma-effective">0.400</span>
                <span id="gammaFloorIndicator" class="gamma-floor-indicator">40% Floor Applied</span>
              </div>
            </div>
            
            <div class="gamma-info-panel low" id="gammaInfoPanel">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <i class="fas fa-info-circle"></i>
                <strong>40% Minimum Rewards (Effective γ = 0.400)</strong>
              </div>
              <p style="margin: 0; font-size: 12px;">
                Even with calculated γ of 0.169, rewards are guaranteed at 40% minimum (1,280,000 $REBL total).
                Increase participating tokens to unlock higher rewards.
              </p>
            </div>
          </div>
          
          <!-- Quick Presets -->
          <div style="margin-top: 20px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
              <button onclick="setParticipationPreset('previous')" class="quick-action-btn">
                <i class="fas fa-history"></i> Previous Epoch
              </button>
              <button onclick="setParticipationPreset('low')" class="quick-action-btn">
                <i class="fas fa-arrow-down"></i> Low Participation
              </button>
              <button onclick="setParticipationPreset('medium')" class="quick-action-btn">
                <i class="fas fa-arrows-alt-h"></i> Medium Participation
              </button>
              <button onclick="setParticipationPreset('optimal')" class="quick-action-btn" style="background: rgba(76, 175, 80, 0.1); color: #4CAF50; border-color: #4CAF50;">
                <i class="fas fa-star"></i> Optimal (50% CS)
              </button>
            </div>
          </div>
        </div>

        <!-- Calculate Button -->
        <div class="calculate-action">
          <button onclick="calculateRewards()" class="calculate-btn" id="calculateButton">
            <i class="fas fa-calculator"></i> CALCULATE SUSTAINABLE REWARDS
          </button>
          <div class="input-hint" style="text-align: center; margin-top: 10px;">
            <i class="fas fa-bolt"></i> Based on actual epoch data with 40% minimum rewards guarantee
          </div>
        </div>

        <!-- Results Display -->
        <div id="reward-result" class="reward-result results-enhanced">
          <div style="text-align: center;">
            <i class="fas fa-calculator" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>Enter your token batches to calculate your sustainable $REBL rewards!</p>
            <p style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem;">
              Try loading an example or adding your own token batches.
            </p>
          </div>
        </div>

        <!-- Chart Container -->
        <div class="chart-container">
          <canvas id="rewardChart"></canvas>
          <div id="chartPlaceholder" class="chart-placeholder">
            <i class="fas fa-chart-pie"></i>
            <p>Your sustainable reward distribution will appear here</p>
          </div>
        </div>

        <!-- Formula Display -->
        <div class="calculator-section formula-display-section">
          <h3><i class="fas fa-calculator"></i> Sustainable Reward Formula</h3>
          <div class="formula-container">
            <div class="formula-main">
              Rewardᵢ = (WSᵢ / ∑WS) × 3,200,000 × MAX(0.4, γ)
            </div>
            <div class="formula-component">
              γ = MIN(1, P/(0.5 × CS), CS/∑WS)
            </div>
          </div>
          <div class="formula-explanation">
            <div class="explanation-item">
              <strong>Key Insight from Epoch Data:</strong> Even with calculated γ = 0.169, effective γ = 0.400 due to 40% minimum guarantee.
              <div class="input-hint">This protects rewards during low participation periods</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- JavaScript Includes -->
    <script src="js/includes.js"></script>
    <script src="js/common.js"></script>
    
    <!-- Enhanced Calculator JavaScript -->
    <script>
      // rebl-calculator.js - Improved Calculations Based on Actual Epoch Data

      // Global variables from actual epoch data
      let rewardChart = null;
      const CS = 499242047.00; // Circulating Supply
      const WERP = 3200000.00; // Weekly Epoch Reward Pool
      const K = 0.07; // Age bonus per epoch
      const MAX_AGE = 20; // Maximum age for bonus
      const GAMMA_FLOOR = 0.4; // 40% minimum guarantee

      // Previous epoch data for reference
      const PREVIOUS_EPOCH = {
        participatingTokens: 42156824.46,
        totalWS: 49655085.01,
        calculatedGamma: 0.168883309,
        effectiveGamma: 0.4,
        totalReward: 1280000,
        participants: 6
      };

      // State management
      let calculatorState = {
          totalUserTokens: 0,
          totalUserWS: 0,
          currentParticipatingTokens: PREVIOUS_EPOCH.participatingTokens,
          currentTotalWS: PREVIOUS_EPOCH.totalWS,
          isCalculating: false,
          useRealisticWS: true // Auto-calculate WS based on realistic assumptions
      };

      // Initialize calculator on page load
      document.addEventListener('DOMContentLoaded', function() {
          console.log('Initializing Improved REBL Calculator with Real Epoch Data...');
          
          // Initialize with one empty row
          setTimeout(function() {
              addTokenBatch();
          }, 100);
          
          // Initialize with previous epoch data
          initializeWithPreviousEpoch();
          
          // Setup event listeners
          setupEventListeners();
          
          // Show welcome message
          setTimeout(() => {
              showToast('Calculator initialized with previous epoch data. Add your token batches to start!', 'info');
          }, 1500);
      });

      // ========== SETUP FUNCTIONS ==========
      function setupEventListeners() {
          // Direct input listeners
          const participatingInput = document.getElementById('participatingTokensInput');
          const totalWSInput = document.getElementById('totalWSInput');
          const participatingSlider = document.getElementById('participatingTokens');
          const totalWSSlider = document.getElementById('totalWS');
          
          if (participatingInput && participatingSlider) {
              participatingInput.addEventListener('input', function() {
                  let value = parseInt(this.value) || 0;
                  value = Math.max(1000000, Math.min(500000000, value));
                  this.value = value;
                  participatingSlider.value = value;
                  calculatorState.currentParticipatingTokens = value;
                  updateTotalWSFromParticipating();
                  updateGammaCalculation();
                  calculateRewards();
              });
              
              participatingSlider.addEventListener('input', function() {
                  const value = parseInt(this.value);
                  participatingInput.value = value;
                  calculatorState.currentParticipatingTokens = value;
                  updateTotalWSFromParticipating();
                  updateGammaCalculation();
                  calculateRewards();
              });
          }
          
          if (totalWSInput && totalWSSlider) {
              totalWSInput.addEventListener('input', function() {
                  let value = parseInt(this.value) || 0;
                  value = Math.max(1000000, Math.min(500000000, value));
                  this.value = value;
                  totalWSSlider.value = value;
                  calculatorState.currentTotalWS = value;
                  updateGammaCalculation();
                  calculateRewards();
              });
              
              totalWSSlider.addEventListener('input', function() {
                  const value = parseInt(this.value);
                  totalWSInput.value = value;
                  calculatorState.currentTotalWS = value;
                  updateGammaCalculation();
                  calculateRewards();
              });
          }
      }

      function initializeWithPreviousEpoch() {
          // Set initial values based on previous epoch
          document.getElementById('participatingTokensInput').value = Math.round(PREVIOUS_EPOCH.participatingTokens);
          document.getElementById('participatingTokens').value = Math.round(PREVIOUS_EPOCH.participatingTokens);
          document.getElementById('totalWSInput').value = Math.round(PREVIOUS_EPOCH.totalWS);
          document.getElementById('totalWS').value = Math.round(PREVIOUS_EPOCH.totalWS);
          
          // Update displays
          updateParticipationDisplay();
          updateGammaCalculation();
      }

      // ========== IMPROVED WS CALCULATION ==========
      function updateTotalWSFromParticipating() {
          if (!calculatorState.useRealisticWS) return;
          
          const participatingTokens = calculatorState.currentParticipatingTokens;
          
          // Calculate realistic WS based on participation level
          // Higher participation = higher average age bonus
          let wsMultiplier;
          
          if (participatingTokens <= 50000000) { // Low participation
              wsMultiplier = 1.18; // Based on previous epoch: 49.66M/42.16M = 1.178
          } else if (participatingTokens <= 150000000) { // Medium participation
              wsMultiplier = 1.35; // Estimate: 35% age bonus
          } else if (participatingTokens <= 300000000) { // High participation
              wsMultiplier = 1.60; // Estimate: 60% age bonus
          } else { // Very high participation
              wsMultiplier = 1.80; // Estimate: 80% age bonus
          }
          
          const totalWS = Math.round(participatingTokens * wsMultiplier);
          calculatorState.currentTotalWS = totalWS;
          
          // Update UI
          document.getElementById('totalWSInput').value = totalWS;
          document.getElementById('totalWS').value = totalWS;
          
          // Update WS multiplier display
          const wsMultiplierCurrent = document.getElementById('wsMultiplierCurrent');
          if (wsMultiplierCurrent) {
              wsMultiplierCurrent.textContent = wsMultiplier.toFixed(2) + 'x';
          }
      }

      // ========== IMPROVED GAMMA CALCULATION ==========
      function calculateGammaScale(P, totalWS) {
          // Based on actual epoch data analysis
          // γ = MIN(1, P/(0.5 × CS), CS/∑WS)
          
          // Term 1: P/(0.5 × CS) - Participation Scaling
          const participationTerm = P / (0.5 * CS);
          
          // Term 2: CS/∑WS - Age Inflation Cap
          const inflationCap = CS / totalWS;
          
          // MIN(1, participationTerm, inflationCap)
          const calculatedGamma = Math.min(1, participationTerm, inflationCap);
          
          // Effective gamma with 40% floor
          const effectiveGamma = Math.max(GAMMA_FLOOR, calculatedGamma);
          
          return {
              calculatedGamma: calculatedGamma,
              effectiveGamma: effectiveGamma,
              participationTerm: participationTerm,
              inflationCap: inflationCap,
              isAtFloor: calculatedGamma < GAMMA_FLOOR,
              floorApplied: calculatedGamma < GAMMA_FLOOR
          };
      }

      function updateGammaCalculation() {
          const P = calculatorState.currentParticipatingTokens;
          const totalWS = calculatorState.currentTotalWS;
          
          const gammaData = calculateGammaScale(P, totalWS);
          
          // Update component displays
          document.getElementById('participationTerm').textContent = gammaData.participationTerm.toFixed(3);
          document.getElementById('inflationCap').textContent = gammaData.inflationCap.toFixed(3);
          document.getElementById('minTerm').textContent = gammaData.calculatedGamma.toFixed(3);
          document.getElementById('maxTerm').textContent = gammaData.effectiveGamma.toFixed(3);
          
          // Update gamma displays
          document.getElementById('gammaCalculated').textContent = gammaData.calculatedGamma.toFixed(3);
          document.getElementById('gammaEffective').textContent = gammaData.effectiveGamma.toFixed(3);
          
          // Update floor indicator
          const floorIndicator = document.getElementById('gammaFloorIndicator');
          if (floorIndicator) {
              floorIndicator.style.display = gammaData.floorApplied ? 'inline-block' : 'none';
              floorIndicator.textContent = gammaData.floorApplied ? '40% Floor Applied' : '';
          }
          
          // Update gamma info panel
          updateGammaInfoPanel(gammaData);
          
          // Update effective reward pool
          updateEffectiveRewardPool(gammaData.effectiveGamma);
      }

      function updateGammaInfoPanel(gammaData) {
          const gammaInfoPanel = document.getElementById('gammaInfoPanel');
          if (!gammaInfoPanel) return;
          
          let panelClass, panelTitle, panelText;
          
          if (gammaData.effectiveGamma >= 1) {
              panelClass = 'high';
              panelTitle = 'Maximum Rewards (γ = 1.00)';
              panelText = 'Gamma Scale is at maximum! 100% of weekly pool is distributed. Ideal participation level reached.';
          } else if (gammaData.effectiveGamma >= 0.8) {
              panelClass = 'high';
              panelTitle = 'High Participation (γ = ' + gammaData.effectiveGamma.toFixed(3) + ')';
              panelText = 'Excellent participation! Close to unlocking maximum rewards.';
          } else if (gammaData.effectiveGamma >= 0.6) {
              panelClass = 'medium';
              panelTitle = 'Good Participation (γ = ' + gammaData.effectiveGamma.toFixed(3) + ')';
              panelText = 'Good participation level. Rewards are scaling up.';
          } else if (gammaData.effectiveGamma > 0.4) {
              panelClass = 'low';
              panelTitle = 'Low Participation (γ = ' + gammaData.effectiveGamma.toFixed(3) + ')';
              panelText = 'Participation is below optimal. Increase participating tokens to unlock higher rewards.';
          } else {
              panelClass = 'low';
              panelTitle = '40% Minimum Rewards (Effective γ = 0.400)';
              panelText = 'Even with calculated γ of ' + gammaData.calculatedGamma.toFixed(3) + ', rewards are guaranteed at 40% minimum. Increase participating tokens to unlock higher rewards.';
          }
          
          gammaInfoPanel.className = `gamma-info-panel ${panelClass}`;
          gammaInfoPanel.innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                  <i class="fas fa-info-circle"></i>
                  <strong>${panelTitle}</strong>
              </div>
              <p style="margin: 0; font-size: 12px;">${panelText}</p>
          `;
      }

      function updateEffectiveRewardPool(gamma) {
          const effectivePool = WERP * gamma;
          // You can display this somewhere if needed
          return effectivePool;
      }

      // ========== TOKEN BATCH FUNCTIONS ==========
      function addTokenBatch(amount = '', age = '') {
          const table = document.querySelector('#token-batches-table tbody');
          if (!table) return;
          
          const row = document.createElement('tr');
          row.innerHTML = `
              <td>
                  <input type="number" class="batch-amount" value="${amount}" placeholder="Amount" 
                         oninput="updateRowCalculations(this)" min="0" step="1000">
              </td>
              <td>
                  <input type="number" class="batch-age" value="${age}" placeholder="Age" 
                         oninput="updateRowCalculations(this)" min="0" max="20" step="1">
              </td>
              <td class="batch-factor" style="color: var(--rebel-gold); font-weight: bold; text-align: center;">1.00</td>
              <td class="batch-ws" style="color: var(--rebel-red); font-weight: bold; text-align: center;">0</td>
              <td style="text-align: center;">
                  <button onclick="removeTokenBatch(this)" class="batch-btn" 
                          style="background: var(--rebel-red); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">
                      <i class="fas fa-times"></i>
                  </button>
              </td>
          `;
          table.appendChild(row);
          
          if (amount || age) {
              setTimeout(() => updateRowCalculations(row.querySelector('.batch-amount')), 10);
          }
          
          // Add animation
          row.style.opacity = '0';
          row.style.transform = 'translateY(10px)';
          setTimeout(() => {
              row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              row.style.opacity = '1';
              row.style.transform = 'translateY(0)';
          }, 10);
          
          // Update totals
          updateUserTotals();
      }

      function removeTokenBatch(button) {
          const row = button.closest('tr');
          if (row) {
              row.style.transform = 'translateX(-100%)';
              row.style.opacity = '0';
              
              setTimeout(() => {
                  row.remove();
                  updateUserTotals();
                  calculateRewards();
                  
                  // Add empty row if all are removed
                  const table = document.querySelector('#token-batches-table tbody');
                  if (table && table.children.length === 0) {
                      addTokenBatch();
                  }
              }, 300);
          }
      }

      function clearTokenBatches() {
          const table = document.querySelector('#token-batches-table tbody');
          const rows = table.querySelectorAll('tr');
          
          if (rows.length === 0) return;
          
          if (!confirm('Are you sure you want to clear all token batches?')) {
              return;
          }
          
          // Animate removal
          rows.forEach((row, index) => {
              setTimeout(() => {
                  row.style.transform = 'translateX(100%)';
                  row.style.opacity = '0';
                  setTimeout(() => row.remove(), 300);
              }, index * 50);
          });
          
          // Add empty row after animation
          setTimeout(() => {
              addTokenBatch();
              calculatorState.totalUserTokens = 0;
              calculatorState.totalUserWS = 0;
              
              const resultElement = document.getElementById('reward-result');
              if (resultElement) {
                  resultElement.innerHTML = `
                      <div style="text-align: center;">
                          <i class="fas fa-calculator" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                          <p>Enter your token batches to calculate your sustainable $REBL rewards!</p>
                          <p style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem;">
                              Try loading an example or adding your own token batches.
                          </p>
                      </div>
                  `;
                  resultElement.className = 'reward-result results-enhanced';
              }
              hideChart();
              showToast('All token batches cleared', 'info');
          }, rows.length * 50 + 300);
      }

      function updateRowCalculations(input) {
          const row = input.closest('tr');
          if (!row) return;
          
          const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
          const age = parseFloat(row.querySelector('.batch-age').value) || 0;
          
          // Validate inputs
          if (amount < 0) {
              row.querySelector('.batch-amount').value = 0;
              return;
          }
          if (age < 0) {
              row.querySelector('.batch-age').value = 0;
              return;
          }
          if (age > 20) {
              row.querySelector('.batch-age').value = 20;
          }
          
          // Calculate weight factor: 1 + 0.07 × min(Age, 20)
          const weightFactor = 1 + (K * Math.min(age, MAX_AGE));
          
          // Calculate weighted share: Token Amount × Weight Factor
          const weightedShare = amount * weightFactor;
          
          // Update display
          const factorCell = row.querySelector('.batch-factor');
          const wsCell = row.querySelector('.batch-ws');
          
          if (factorCell) {
              factorCell.textContent = weightFactor.toFixed(2);
              factorCell.style.color = weightFactor > 1 ? 'var(--rebel-gold)' : '#ffffff';
              factorCell.style.fontWeight = weightFactor > 1 ? 'bold' : 'normal';
          }
          
          if (wsCell) {
              wsCell.textContent = formatNumber(weightedShare, true);
              wsCell.style.color = 'var(--rebel-red)';
              wsCell.style.fontWeight = 'bold';
          }
          
          // Update user totals
          updateUserTotals();
          
          // Calculate rewards with slight delay
          if (!calculatorState.isCalculating) {
              calculatorState.isCalculating = true;
              setTimeout(() => {
                  calculateRewards();
                  calculatorState.isCalculating = false;
              }, 300);
          }
      }

      function updateUserTotals() {
          const rows = document.querySelectorAll('#token-batches-table tbody tr');
          let totalTokens = 0;
          let totalWS = 0;
          
          rows.forEach(row => {
              const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
              const ws = parseFloat(row.querySelector('.batch-ws').textContent.replace(/,/g, '')) || 0;
              
              totalTokens += amount;
              totalWS += ws;
          });
          
          calculatorState.totalUserTokens = totalTokens;
          calculatorState.totalUserWS = totalWS;
          
          // Update display
          const userTokenSum = document.getElementById('userTokenSum');
          const userWSSum = document.getElementById('userWSSum');
          const yourWSShare = document.getElementById('yourWSShare');
          
          if (userTokenSum) userTokenSum.textContent = formatNumber(totalTokens);
          if (userWSSum) userWSSum.textContent = formatNumber(totalWS, true);
          
          // Update WS share
          if (yourWSShare && calculatorState.currentTotalWS > 0) {
              const share = (totalWS / calculatorState.currentTotalWS * 100).toFixed(2);
              yourWSShare.textContent = `${share}%`;
          }
      }

      // ========== PRESET FUNCTIONS ==========
      function setParticipationPreset(type) {
          let participating, totalWS;
          
          switch(type) {
              case 'previous':
                  participating = PREVIOUS_EPOCH.participatingTokens;
                  totalWS = PREVIOUS_EPOCH.totalWS;
                  break;
              case 'low':
                  participating = 50000000;
                  totalWS = participating * 1.18;
                  break;
              case 'medium':
                  participating = 150000000;
                  totalWS = participating * 1.35;
                  break;
              case 'optimal':
                  participating = 249621024; // 50% of CS
                  totalWS = participating * 1.5;
                  break;
              default:
                  return;
          }
          
          // Update values
          calculatorState.currentParticipatingTokens = participating;
          calculatorState.currentTotalWS = totalWS;
          
          // Update inputs and sliders
          document.getElementById('participatingTokensInput').value = Math.round(participating);
          document.getElementById('participatingTokens').value = Math.round(participating);
          document.getElementById('totalWSInput').value = Math.round(totalWS);
          document.getElementById('totalWS').value = Math.round(totalWS);
          
          // Update displays
          updateParticipationDisplay();
          updateGammaCalculation();
          calculateRewards();
          
          // Show toast
          showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} participation preset applied`, 'info');
      }

      function updateParticipationDisplay() {
          const participatingValue = document.getElementById('participatingTokensValue');
          const totalWSValue = document.getElementById('totalWSValue');
          
          if (participatingValue) {
              participatingValue.textContent = formatNumber(calculatorState.currentParticipatingTokens);
          }
          
          if (totalWSValue) {
              totalWSValue.textContent = formatNumber(calculatorState.currentTotalWS);
          }
      }

      // ========== IMPROVED REWARD CALCULATION ==========
      function calculateRewards() {
          // Prevent rapid calculations
          if (calculatorState.isCalculating) return;
          calculatorState.isCalculating = true;
          
          // Show loading state
          const calculateButton = document.getElementById('calculateButton');
          if (calculateButton) {
              calculateButton.classList.add('loading');
              calculateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CALCULATING...';
          }
          
          setTimeout(() => {
              const rows = document.querySelectorAll('#token-batches-table tbody tr');
              let userWS = 0;
              let totalAmount = 0;
              let batchCount = 0;
              
              const batchData = [];
              
              // Calculate user's WSᵢ
              rows.forEach(row => {
                  const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
                  const age = parseFloat(row.querySelector('.batch-age').value) || 0;
                  const ws = parseFloat(row.querySelector('.batch-ws').textContent.replace(/,/g, '')) || 0;
                  
                  userWS += ws;
                  totalAmount += amount;
                  
                  if (amount > 0) {
                      batchCount++;
                      batchData.push({
                          amount: amount,
                          age: age,
                          ws: ws
                      });
                  }
              });
              
              // Get participation data
              const participatingTokens = calculatorState.currentParticipatingTokens;
              const totalWS = calculatorState.currentTotalWS;
              
              // Calculate gamma scale
              const gammaData = calculateGammaScale(participatingTokens, totalWS);
              const effectiveGamma = gammaData.effectiveGamma;
              
              // Calculate user's share and reward
              const userShare = totalWS > 0 ? (userWS / totalWS) : 0;
              const userReward = userShare * WERP * effectiveGamma;
              const effectivePool = WERP * effectiveGamma;
              
              const resultElement = document.getElementById('reward-result');
              if (!resultElement) {
                  calculatorState.isCalculating = false;
                  return;
              }
              
              if (userWS <= 0 || batchData.length === 0 || totalAmount <= 0) {
                  resultElement.innerHTML = `
                      <div style="text-align: center;">
                          <i class="fas fa-calculator" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                          <p>Please enter valid token batches to calculate your sustainable $REBL rewards!</p>
                          <p style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem;">
                              Try loading an example or adding your own token batches.
                          </p>
                      </div>
                  `;
                  resultElement.className = 'reward-result results-enhanced';
                  hideChart();
                  
                  // Restore button
                  if (calculateButton) {
                      calculateButton.classList.remove('loading');
                      calculateButton.innerHTML = '<i class="fas fa-calculator"></i> CALCULATE SUSTAINABLE REWARDS';
                  }
                  
                  calculatorState.isCalculating = false;
                  return;
              }
              
              // Calculate percentages
              const poolPercentage = (userShare * 100).toFixed(4);
              const returnPercentage = ((userReward / totalAmount) * 100).toFixed(4);
              
              // Calculate projections
              const monthlyReward = userReward * 4.33;
              const annualReward = userReward * 52;
              
              // Calculate WS multiplier
              const wsMultiplier = totalWS / participatingTokens;
              
              // Format results with enhanced display
              const resultHTML = `
                  <div class="results-header">
                      <div class="results-title">Your Sustainable Reward Calculation</div>
                      <div class="results-accuracy">Based on Actual Epoch Data</div>
                  </div>
                  
                  <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                          <span style="color: rgba(255, 255, 255, 0.7);">Effective Gamma Scale:</span>
                          <span style="color: ${getGammaColor(effectiveGamma)}; font-weight: bold;">
                              γ = ${effectiveGamma.toFixed(3)} ${gammaData.floorApplied ? '(40% Floor)' : ''}
                          </span>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="color: rgba(255, 255, 255, 0.7);">Total Reward Pool:</span>
                          <span style="color: var(--rebel-red); font-weight: bold;">
                              ${formatNumber(effectivePool, false)} $REBL
                          </span>
                      </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                      <div style="background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 6px;">
                          <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Your Weighted Share</div>
                          <div style="color: var(--rebel-gold); font-weight: bold; font-size: 1.1rem;">
                              ${formatNumber(userWS, true)}
                          </div>
                      </div>
                      <div style="background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 6px;">
                          <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Pool Share</div>
                          <div style="color: var(--rebel-gold); font-weight: bold; font-size: 1.1rem;">
                              ${poolPercentage}%
                          </div>
                      </div>
                      <div style="background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 6px;">
                          <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Weekly Return</div>
                          <div style="color: var(--rebel-gold); font-weight: bold; font-size: 1.1rem;">
                              ${returnPercentage}%
                          </div>
                      </div>
                  </div>
                  
                  <div style="text-align: center; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, rgba(212, 167, 106, 0.1), rgba(255, 51, 102, 0.1)); border-radius: 8px;">
                      <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px;">Your Sustainable Weekly Reward</div>
                      <div style="color: var(--rebel-red); font-weight: 800; font-size: 2rem; text-shadow: 0 0 10px rgba(255, 51, 102, 0.3);">
                          ${formatNumber(userReward, true)} $REBL
                      </div>
                      <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.5); margin-top: 5px;">
                          Based on ${formatNumber(participatingTokens)} participating tokens
                      </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                      <div style="text-align: center; background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 6px;">
                          <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Monthly Estimate*</div>
                          <div style="color: var(--rebel-gold); font-weight: bold; font-size: 1.2rem;">
                              ${formatNumber(monthlyReward, true)} $REBL
                          </div>
                      </div>
                      <div style="text-align: center; background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 6px;">
                          <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Annual Estimate*</div>
                          <div style="color: var(--rebel-gold); font-weight: bold; font-size: 1.2rem;">
                              ${formatNumber(annualReward, true)} $REBL
                          </div>
                      </div>
                  </div>
                  <div style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); margin-top: 8px; text-align: center;">
                      *Estimates assume consistent participation levels
                  </div>
              `;
              
              resultElement.innerHTML = resultHTML;
              resultElement.className = 'reward-result results-enhanced';
              
              // Update chart
              updateChart(batchData, userWS);
              
              // Restore button
              if (calculateButton) {
                  calculateButton.classList.remove('loading');
                  calculateButton.innerHTML = '<i class="fas fa-calculator"></i> CALCULATE SUSTAINABLE REWARDS';
              }
              
              calculatorState.isCalculating = false;
              
              // Show success toast
              showToast('Rewards calculated based on actual epoch data!', 'success');
          }, 800);
      }

      // ========== HELPER FUNCTIONS ==========
      function formatNumber(num, showDecimals = false) {
          if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return '0';
          
          // For very small numbers
          if (num < 0.001 && num > 0) {
              return '<0.001';
          }
          
          // Format large numbers
          if (num >= 1000000000) {
              return (num / 1000000000).toFixed(showDecimals ? 2 : 1) + 'B';
          } else if (num >= 1000000) {
              return (num / 1000000).toFixed(showDecimals ? 2 : 1) + 'M';
          } else if (num >= 1000) {
              return (num / 1000).toFixed(showDecimals ? 2 : 1) + 'K';
          }
          
          const options = {
              minimumFractionDigits: showDecimals ? 2 : 0,
              maximumFractionDigits: showDecimals ? 2 : 0
          };
          
          return num.toLocaleString(undefined, options);
      }

      function getGammaColor(gamma) {
          if (gamma >= 1) return '#00ff00';
          if (gamma >= 0.8) return '#ffff00';
          if (gamma >= 0.6) return '#ffcc00';
          if (gamma >= 0.4) return '#ff9900';
          return '#ff3366';
      }

      function showToast(message, type = 'info') {
          // Remove existing toasts
          const existingToasts = document.querySelectorAll('.calculator-toast');
          existingToasts.forEach(toast => toast.remove());
          
          // Create toast
          const toast = document.createElement('div');
          toast.className = `calculator-toast calculator-toast-${type}`;
          toast.innerHTML = `
              <div class="toast-content">
                  <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
                  <span>${message}</span>
              </div>
          `;
          
          document.body.appendChild(toast);
          
          // Remove after 3 seconds
          setTimeout(() => {
              toast.style.animation = 'toastOut 0.3s ease';
              setTimeout(() => toast.remove(), 300);
          }, 3000);
      }

      // ========== CHART FUNCTIONS ==========
      function setupChartPlaceholder() {
          const chartPlaceholder = document.getElementById('chartPlaceholder');
          const canvas = document.getElementById('rewardChart');
          
          if (chartPlaceholder) chartPlaceholder.style.display = 'flex';
          if (canvas) canvas.style.display = 'none';
      }

      function hideChart() {
          const chartPlaceholder = document.getElementById('chartPlaceholder');
          const canvas = document.getElementById('rewardChart');
          
          if (chartPlaceholder) chartPlaceholder.style.display = 'flex';
          if (canvas) canvas.style.display = 'none';
          
          if (rewardChart) {
              rewardChart.destroy();
              rewardChart = null;
          }
      }

      function updateChart(batchData, totalUserWS) {
          const ctx = document.getElementById('rewardChart');
          if (!ctx) return;
          
          const chartPlaceholder = document.getElementById('chartPlaceholder');
          const canvas = document.getElementById('rewardChart');
          
          if (chartPlaceholder) chartPlaceholder.style.display = 'none';
          if (canvas) canvas.style.display = 'block';
          
          // Destroy existing chart
          if (rewardChart) rewardChart.destroy();
          
          // Prepare data
          const labels = batchData.map((batch, index) => `Batch ${index + 1}`);
          const weightedShares = batchData.map(batch => batch.ws);
          const percentages = weightedShares.map(ws => ((ws / totalUserWS) * 100).toFixed(1));
          
          // Create chart
          rewardChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: labels.map((label, i) => `${label} (${percentages[i]}%)`),
                  datasets: [{
                      data: weightedShares,
                      backgroundColor: [
                          'rgba(255, 51, 102, 0.8)',
                          'rgba(255, 204, 0, 0.8)',
                          'rgba(0, 170, 255, 0.8)',
                          'rgba(156, 39, 176, 0.8)',
                          'rgba(76, 175, 80, 0.8)'
                      ],
                      borderWidth: 2,
                      hoverOffset: 20
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'right' },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  const batch = batchData[context.dataIndex];
                                  return [
                                      `Amount: ${formatNumber(batch.amount)} $rebelinux`,
                                      `Age: ${batch.age} epochs`,
                                      `Weighted Share: ${formatNumber(batch.ws, true)}`,
                                      `Share: ${((batch.ws / totalUserWS) * 100).toFixed(1)}%`
                                  ];
                              }
                          }
                      }
                  }
              }
          });
      }

      // ========== EXAMPLE CASES ==========
      function loadExampleCase(type) {
          clearTokenBatches();
          
          setTimeout(() => {
              switch(type) {
                  case 'starter':
                      addTokenBatch('50000', '3');
                      addTokenBatch('100000', '8');
                      break;
                  case 'investor':
                      addTokenBatch('500000', '5');
                      addTokenBatch('1000000', '10');
                      addTokenBatch('750000', '15');
                      break;
                  case 'whale':
                      addTokenBatch('2000000', '8');
                      addTokenBatch('3000000', '12');
                      addTokenBatch('5000000', '18');
                      break;
              }
              
              showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} example loaded`, 'success');
          }, 500);
      }

      // ========== PUBLIC FUNCTIONS ==========
      window.addTokenBatch = addTokenBatch;
      window.removeTokenBatch = removeTokenBatch;
      window.clearTokenBatches = clearTokenBatches;
      window.updateRowCalculations = updateRowCalculations;
      window.updateParticipation = function() {
          const participatingSlider = document.getElementById('participatingTokens');
          const totalWSSlider = document.getElementById('totalWS');
          
          if (participatingSlider && totalWSSlider) {
              calculatorState.currentParticipatingTokens = parseInt(participatingSlider.value) || PREVIOUS_EPOCH.participatingTokens;
              calculatorState.currentTotalWS = parseInt(totalWSSlider.value) || PREVIOUS_EPOCH.totalWS;
              
              updateParticipationDisplay();
              updateGammaCalculation();
              calculateRewards();
          }
      };
      window.calculateRewards = calculateRewards;
      window.loadExampleCase = loadExampleCase;
      window.setParticipationPreset = setParticipationPreset;
    </script>
  </main>
  
  <!-- Footer will be inserted here by JavaScript -->
  <div id="footer-container"></div>
</body>
</html>
