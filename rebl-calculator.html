<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="RebelInuX Sustainable Reward Calculator - Calculate $REBL rewards using the new sustainable formula with Gamma Scale Factor" />
  <meta name="keywords" content="RebelInuX calculator, $REBL rewards, epoch calculator, sustainable formula, gamma scale factor" />
  <meta property="og:title" content="RebelInuX Sustainable Reward Calculator" />
  <meta property="og:image" content="images/Logo_REBL.svg" />
  <meta property="og:description" content="Calculate your $REBL rewards using the sustainable formula with Gamma Scale Factor (γ) simulation" />
  <meta property="og:url" content="https://rebelinux.fun/rebl-calculator.html" />
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="RebelInuX">
  <meta name="twitter:title" content="RebelInuX Sustainable Reward Calculator">
  <meta name="twitter:description" content="Calculate your $REBL rewards using the sustainable formula with Gamma Scale Factor (γ) simulation">
  <meta name="twitter:card" content="summary_large_image" />
  
  <!-- Favicons -->
  <link rel="icon" href="images/Logo_REBL.svg">
  <link rel="apple-touch-icon" href="images/Logo_REBL.svg">
  <title>RebelInuX Enhanced Reward Calculator</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>

  <!-- CSS Files -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/header-footer.css">
  <link rel="stylesheet" href="css/rebl-calculator.css">

  <!-- Enhanced Calculator Styles -->
  <style>
    /* Enhanced Styles for Improved Calculator */
    .enhanced-calculator {
      --rebel-gold: #d4a76a;
      --rebel-red: #ff3366;
      --rebel-blue: #00aaff;
      --rebel-green: #00ff00;
      --rebel-yellow: #ffcc00;
      --color-bg-dark: #0a0a0f;
      --color-bg-card: rgba(18, 18, 28, 0.95);
      --color-text-primary: #ffffff;
      --color-text-secondary: rgba(255, 255, 255, 0.8);
      --color-text-muted: rgba(255, 255, 255, 0.6);
      --color-success: #4CAF50;
      --color-warning: #FF9800;
      --color-error: #f44336;
      
      /* Animation speeds */
      --transition-fast: 150ms ease;
      --transition-normal: 300ms ease;
      --transition-slow: 500ms ease;
      
      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      
      /* Border radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;
      
      /* Shadows */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.6);
      
      /* Z-index layers */
      --z-base: 1;
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-modal: 1000;
      --z-popover: 1100;
      --z-tooltip: 1200;
      --z-toast: 1300;
    }
    
    /* Enhanced Input Styles */
    .enhanced-input {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(212, 167, 106, 0.3);
      border-radius: var(--radius-md);
      color: var(--color-text-primary);
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      font-weight: 500;
      padding: 12px 16px;
      transition: var(--transition-normal);
      width: 100%;
    }
    
    .enhanced-input:focus {
      outline: none;
      border-color: var(--rebel-gold);
      box-shadow: 0 0 0 3px rgba(212, 167, 106, 0.2);
      background: rgba(0, 0, 0, 0.4);
    }
    
    .enhanced-input:hover:not(:focus) {
      border-color: rgba(212, 167, 106, 0.5);
      background: rgba(0, 0, 0, 0.35);
    }
    
    .enhanced-input.error {
      border-color: var(--rebel-red);
      box-shadow: 0 0 0 3px rgba(255, 51, 102, 0.2);
    }
    
    .enhanced-input.success {
      border-color: var(--color-success);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    
    /* Enhanced Button Styles */
    .enhanced-btn {
      background: linear-gradient(135deg, var(--rebel-red), var(--rebel-gold));
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      font-weight: 700;
      padding: 12px 24px;
      cursor: pointer;
      transition: var(--transition-normal);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
    }
    
    .enhanced-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: var(--transition-slow);
    }
    
    .enhanced-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .enhanced-btn:hover::before {
      left: 100%;
    }
    
    .enhanced-btn:active {
      transform: translateY(0);
      transition: var(--transition-fast);
    }
    
    .enhanced-btn.secondary {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid var(--rebel-gold);
      color: var(--rebel-gold);
    }
    
    .enhanced-btn.secondary:hover {
      background: rgba(212, 167, 106, 0.1);
    }
    
    .enhanced-btn.small {
      padding: 8px 16px;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    
    /* Enhanced Card Styles */
    .enhanced-card {
      background: var(--color-bg-card);
      border: 1px solid rgba(212, 167, 106, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      transition: var(--transition-normal);
      backdrop-filter: blur(10px);
    }
    
    .enhanced-card:hover {
      border-color: var(--rebel-gold);
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }
    
    /* Enhanced Table Styles */
    .enhanced-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(0, 0, 0, 0.4);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .enhanced-table th {
      background: rgba(212, 167, 106, 0.2);
      color: var(--rebel-gold);
      font-weight: 700;
      text-align: left;
      padding: var(--spacing-md);
      border-bottom: 2px solid var(--rebel-gold);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
      white-space: nowrap;
    }
    
    .enhanced-table td {
      padding: var(--spacing-md);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      vertical-align: middle;
    }
    
    .enhanced-table tr:last-child td {
      border-bottom: none;
    }
    
    .enhanced-table tr:hover {
      background: rgba(212, 167, 106, 0.1);
    }
    
    /* Enhanced Results Display */
    .enhanced-results {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(212, 167, 106, 0.1));
      border: 2px solid var(--rebel-gold);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .result-summary {
      margin-bottom: var(--spacing-xl);
    }
    
    .main-reward {
      font-size: 3rem;
      font-weight: 900;
      color: var(--rebel-red);
      text-shadow: 0 0 20px rgba(255, 51, 102, 0.4);
      margin: var(--spacing-md) 0;
      text-align: center;
    }
    
    .breakdown-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
    }
    
    .breakdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }
    
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--radius-sm);
    }
    
    .breakdown-item .label {
      color: var(--color-text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .breakdown-item .value {
      font-weight: 700;
      color: var(--rebel-gold);
    }
    
    .breakdown-item .value.positive {
      color: var(--color-success);
    }
    
    .breakdown-item .value.negative {
      color: var(--rebel-red);
    }
    
    /* Enhanced Slider Styles */
    .enhanced-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: linear-gradient(90deg, var(--rebel-red), var(--rebel-gold));
      border-radius: 4px;
      outline: none;
      margin: var(--spacing-md) 0;
      cursor: pointer;
      position: relative;
    }
    
    .enhanced-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--rebel-gold);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      transition: var(--transition-normal);
    }
    
    .enhanced-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(212, 167, 106, 0.8);
    }
    
    .enhanced-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--rebel-gold);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      transition: var(--transition-normal);
    }
    
    .enhanced-slider::-moz-range-thumb:hover {
      transform: scale(1.1);
    }
    
    /* Enhanced Toggle Switch */
    .enhanced-toggle {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-md);
      cursor: pointer;
    }
    
    .enhanced-toggle input {
      display: none;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: rgba(255, 51, 102, 0.3);
      border-radius: 15px;
      transition: var(--transition-normal);
    }
    
    .toggle-switch::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: var(--rebel-red);
      border-radius: 50%;
      transition: var(--transition-normal);
    }
    
    .enhanced-toggle input:checked + .toggle-switch {
      background: rgba(76, 175, 80, 0.3);
    }
    
    .enhanced-toggle input:checked + .toggle-switch::before {
      transform: translateX(30px);
      background: var(--color-success);
    }
    
    .toggle-label {
      font-weight: 600;
      color: var(--color-text-primary);
    }
    
    /* Enhanced Progress Bars */
    .enhanced-progress {
      height: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: var(--spacing-sm) 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--rebel-red), var(--rebel-gold));
      border-radius: 4px;
      transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    /* Enhanced Toast Notifications */
    .enhanced-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      z-index: var(--z-toast);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 14px;
      font-weight: 600;
      animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      backdrop-filter: blur(10px);
      max-width: 400px;
      border: 1px solid;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%) scale(0.8); opacity: 0; }
      to { transform: translateX(0) scale(1); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0) scale(1); opacity: 1; }
      to { transform: translateX(100%) scale(0.8); opacity: 0; }
    }
    
    .enhanced-toast.success {
      background: rgba(76, 175, 80, 0.95);
      color: white;
      border-color: rgba(76, 175, 80, 0.5);
    }
    
    .enhanced-toast.info {
      background: rgba(33, 150, 243, 0.95);
      color: white;
      border-color: rgba(33, 150, 243, 0.5);
    }
    
    .enhanced-toast.warning {
      background: rgba(255, 193, 7, 0.95);
      color: var(--color-text-dark);
      border-color: rgba(255, 193, 7, 0.5);
    }
    
    .enhanced-toast.error {
      background: rgba(255, 51, 102, 0.95);
      color: white;
      border-color: rgba(255, 51, 102, 0.5);
    }
    
    /* Enhanced Tooltips */
    .enhanced-tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    
    .enhanced-tooltip .tooltip-content {
      visibility: hidden;
      width: 300px;
      background-color: rgba(0, 0, 0, 0.95);
      color: white;
      text-align: left;
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      position: absolute;
      z-index: var(--z-tooltip);
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.6;
      border: 1px solid var(--rebel-gold);
      box-shadow: var(--shadow-xl);
      backdrop-filter: blur(10px);
    }
    
    .enhanced-tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }
    
    /* Enhanced Loading States */
    .enhanced-loading {
      position: relative;
  </style>
</head>
<body>
  <!-- Loading Animation -->
  <div class="loader" id="loader">
    <div class="loader-spinner"></div>
  </div>
  
  <!-- Back to Top Button -->
  <div class="back-to-top" id="backToTop">
    <i class="fas fa-arrow-up"></i>
  </div>
  
  <!-- Header will be inserted here by JavaScript -->
  <div id="header-container"></div>
  
  <main>
    <!-- Hero Section -->
    <section class="page-hero page-hero--calculator">
      <div class="container">
        <h1>ENHANCED REWARD CALCULATOR</h1>
        <p class="text-lead">Calculate your $REBL rewards using the new sustainable formula with Gamma Scale Factor (γ) simulation. Plan your strategy based on participation levels!</p>
        <div class="hero-buttons">
          <a href="#rebl-calculator" class="cta-button">
            <i class="fas fa-calculator"></i> Start Calculating
          </a>
          <a href="#calculator-faq" class="cta-button gold">
            <i class="fas fa-question-circle"></i> FAQ & Help
          </a>
          <a href="epoch-rewards.html" class="cta-button">
            <i class="fas fa-gift"></i> View Epoch Rewards
          </a>
        </div>
      </div>
    </section>

    <!-- Enhanced Calculator -->
    <section id="rebl-calculator">
      <div class="container">
        <h2><i class="fas fa-calculator"></i> Enhanced Sustainable Reward Calculator</h2>
        
        <!-- Quick Navigation -->
        <div class="quick-actions">
          <button onclick="scrollToSection('token-batches')" class="quick-action-btn">
            <i class="fas fa-layer-group"></i> Token Batches
          </button>
          <button onclick="scrollToSection('participation')" class="quick-action-btn">
            <i class="fas fa-sliders-h"></i> Participation
          </button>
          <button onclick="scrollToSection('gamma-simulator')" class="quick-action-btn">
            <i class="fas fa-chart-line"></i> Gamma Simulator
          </button>
          <button onclick="calculateRewards()" class="quick-action-btn" style="background: var(--rebel-red); color: white;">
            <i class="fas fa-bolt"></i> Calculate Now
          </button>
        </div>
        
        <!-- Core Parameters -->
        <div class="calculator-parameters">
          <div class="parameter-grid">
            <div class="parameter-item">
              <div class="parameter-icon"><i class="fas fa-coins"></i></div>
              <div class="parameter-content">
                <div class="parameter-label">CS (Circulating Supply)</div>
                <div class="parameter-value">499,242,047</div>
                <div class="parameter-description">Total $rebelinux tokens</div>
              </div>
            </div>
            
            <div class="parameter-item">
              <div class="parameter-icon"><i class="fas fa-piggy-bank"></i></div>
              <div class="parameter-content">
                <div class="parameter-label">WERP (Weekly Pool)</div>
                <div class="parameter-value">3,200,000 $REBL</div>
                <div class="parameter-description">Fixed weekly distribution</div>
              </div>
            </div>
            
            <div class="parameter-item">
              <div class="parameter-icon"><i class="fas fa-sliders-h"></i></div>
              <div class="parameter-content">
                <div class="parameter-label">γ (Gamma Scale)</div>
                <div id="gammaValueDisplay" class="parameter-value">0.40</div>
                <div class="parameter-description">Sustainability factor</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Token Batches -->
        <div id="token-batches" class="calculator-section token-batches-section">
          <div class="section-header">
            <h3><i class="fas fa-layer-group"></i> Your Token Batches</h3>
            <div class="example-buttons">
              <button onclick="loadExampleCase('starter')" class="example-btn">
                <i class="fas fa-user-graduate"></i> Starter
              </button>
              <button onclick="loadExampleCase('investor')" class="example-btn">
                <i class="fas fa-chart-line"></i> Investor
              </button>
              <button onclick="loadExampleCase('whale')" class="example-btn">
                <i class="fas fa-whale"></i> Whale
              </button>
            </div>
          </div>
          
          <div class="table-actions">
            <button onclick="addTokenBatch()" class="table-action-btn">
              <i class="fas fa-plus"></i> Add Batch
            </button>
            <button onclick="addTokenBatch('1000000', '5')" class="table-action-btn">
              <i class="fas fa-bolt"></i> Quick Add 1M
            </button>
            <button onclick="addTokenBatch('500000', '10')" class="table-action-btn">
              <i class="fas fa-bolt"></i> Quick Add 500K
            </button>
            <button onclick="clearTokenBatches()" class="table-action-btn" style="background: rgba(255, 51, 102, 0.1); color: var(--rebel-red); border-color: var(--rebel-red);">
              <i class="fas fa-trash"></i> Clear All
            </button>
          </div>
          
          <div class="table-container">
            <table id="token-batches-table">
              <thead>
                <tr>
                  <th>$rebelinux Amount</th>
                  <th>Age (Epochs)</th>
                  <th>Weight Factor</th>
                  <th>WSᵢ (Weighted Share)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
          
          <div class="advanced-presets" style="margin-top: 20px;">
            <h4><i class="fas fa-magic"></i> Advanced Presets</h4>
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
              <button onclick="loadPreset('new-investor')" class="table-action-btn">
                <i class="fas fa-seedling"></i> New Investor
              </button>
              <button onclick="loadPreset('active-trader')" class="table-action-btn">
                <i class="fas fa-chart-line"></i> Active Trader
              </button>
              <button onclick="loadPreset('long-term-holder')" class="table-action-btn">
                <i class="fas fa-mountain"></i> Long-term Holder
              </button>
              <button onclick="loadPreset('portfolio-diversified')" class="table-action-btn">
                <i class="fas fa-balance-scale"></i> Diversified
              </button>
            </div>
          </div>
        </div>

        <!-- Participation Settings -->
        <div id="participation" class="calculator-section participation-settings">
          <h3><i class="fas fa-users"></i> Participation Settings</h3>
          
          <!-- Auto Update Toggle -->
          <div class="auto-update-toggle">
            <div class="enhanced-toggle">
              <input type="checkbox" id="autoUpdateToggle" checked>
              <div class="toggle-switch"></div>
              <div class="toggle-label">Auto-update participation based on your tokens</div>
            </div>
            <div class="toggle-help">
              <i class="fas fa-info-circle"></i> When enabled, participation estimates adjust automatically based on your token batches
            </div>
          </div>
          
          <!-- Smart WS Estimation -->
          <div class="smart-estimation">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4><i class="fas fa-brain"></i> Smart WS Estimation</h4>
              <button onclick="estimateTotalWS()" class="table-action-btn small">
                <i class="fas fa-calculator"></i> Re-estimate
              </button>
            </div>
            <div class="estimation-grid">
              <div class="estimation-item">
                <div class="estimation-label">Your Tokens</div>
                <div id="yourTokens" class="estimation-value">0</div>
              </div>
              <div class="estimation-item">
                <div class="estimation-label">Your WS</div>
                <div id="yourWS" class="estimation-value">0</div>
              </div>
              <div class="estimation-item">
                <div class="estimation-label">Avg. Bonus</div>
                <div id="avgBonus" class="estimation-value">1.00x</div>
              </div>
              <div class="estimation-item">
                <div class="estimation-label">Est. WS Multiplier</div>
                <div id="estimatedMultiplier" class="estimation-value">1.20x</div>
              </div>
            </div>
          </div>
          
          <!-- Sliders -->
          <div class="slider-group">
            <div class="slider-container">
              <div class="slider-info">
                <div class="slider-info-label">
                  <span>Total Participating Tokens (P):</span>
                  <div class="enhanced-tooltip">
                    <i class="fas fa-question-circle"></i>
                    <div class="tooltip-content">
                      Total tokens participating in this epoch. Includes your tokens plus estimated other participants.
                      <br><br>
                      <strong>Default:</strong> 10% of CS
                      <br>
                      <strong>Target:</strong> 50% of CS for full gamma
                    </div>
                  </div>
                </div>
                <div class="slider-info-value">
                  <input type="number" id="participatingTokensInput" class="value-input enhanced-input" 
                         value="100000000" min="1000000" max="500000000" step="1000000">
                  <span id="participatingTokensValue" class="slider-value">100M</span>
                </div>
              </div>
              <input type="range" id="participatingTokens" min="1000000" max="500000000" step="1000000" value="100000000" 
                     class="enhanced-slider" oninput="updateParticipation()">
              <div class="slider-stats">
                <span>Your share: <span id="yourTokenShare">0%</span></span>
                <span>Target (50% CS): <span id="targetParticipating">249.6M</span></span>
              </div>
            </div>
            
            <div class="slider-container">
              <div class="slider-info">
                <div class="slider-info-label">
                  <span>∑WS (Total Active Weighted Shares):</span>
                  <div class="enhanced-tooltip">
                    <i class="fas fa-question-circle"></i>
                    <div class="tooltip-content">
                      Total weighted shares including age bonuses. This is always ≥ total participating tokens.
                      <br><br>
                      <strong>Typical range:</strong> 1.2x to 2.4x participating tokens
                      <br>
                      <strong>Max possible:</strong> 2.4x (all tokens with max age bonus)
                    </div>
                  </div>
                </div>
                <div class="slider-info-value">
                  <input type="number" id="totalWSInput" class="value-input enhanced-input" 
                         value="100000000" min="1000000" max="500000000" step="1000000">
                  <span id="totalWSValue" class="slider-value">100M</span>
                </div>
              </div>
              <input type="range" id="totalWS" min="1000000" max="500000000" step="1000000" value="100000000" 
                     class="enhanced-slider" oninput="updateParticipation()">
              <div class="slider-stats">
                <span>Your WS share: <span id="yourWSShare">0%</span></span>
                <span>WS Multiplier: <span id="wsMultiplierCurrent">1.00x</span></span>
              </div>
            </div>
          </div>
          
          <!-- Quick Presets -->
          <div class="participation-presets">
            <h4><i class="fas fa-rocket"></i> Participation Scenarios</h4>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
              <button onclick="setParticipationPreset('low')" class="table-action-btn">
                <i class="fas fa-arrow-down"></i> Low (20% CS)
              </button>
              <button onclick="setParticipationPreset('medium')" class="table-action-btn">
                <i class="fas fa-arrows-alt-h"></i> Medium (35% CS)
              </button>
              <button onclick="setParticipationPreset('high')" class="table-action-btn">
                <i class="fas fa-arrow-up"></i> High (50% CS)
              </button>
              <button onclick="setParticipationPreset('optimal')" class="table-action-btn" style="background: rgba(76, 175, 80, 0.1); color: #4CAF50; border-color: #4CAF50;">
                <i class="fas fa-star"></i> Optimal (60% CS)
              </button>
            </div>
          </div>
          
          <!-- Gamma Visualization -->
          <div class="gamma-visualization enhanced-card" style="margin-top: 30px;">
            <h4><i class="fas fa-chart-line"></i> Gamma Scale Visualization</h4>
            <div style="text-align: center; margin: 20px 0;">
              <div class="gamma-value-display">
                γ = <span id="gammaValue">0.40</span>
              </div>
              <div class="gamma-scale">
                <div class="gamma-bar">
                  <div id="gammaMarker" class="gamma-marker"></div>
                </div>
              </div>
              <div class="gamma-labels">
                <span>40% (Floor)</span>
                <span>50% Participation</span>
                <span>100%</span>
              </div>
            </div>
            
            <div id="gammaInsight" class="gamma-insight">
              <i class="fas fa-info-circle"></i>
              <span>The Gamma Scale is at its minimum (40%). Increase participating tokens to unlock higher rewards.</span>
            </div>
          </div>
        </div>

        <!-- Calculate Button -->
        <div class="calculate-action">
          <button onclick="calculateRewards()" id="calculateButton" class="enhanced-btn">
            <i class="fas fa-calculator"></i> CALCULATE SUSTAINABLE REWARDS
          </button>
          <div class="input-hint" style="text-align: center; margin-top: 10px;">
            <i class="fas fa-bolt"></i> Click to calculate your weekly $REBL rewards based on current settings
          </div>
        </div>

        <!-- Results Display -->
        <div id="reward-result" class="enhanced-results" style="display: none;">
          <!-- Results will be populated here -->
        </div>

        <!-- Chart Container -->
        <div class="chart-container enhanced-card">
          <canvas id="rewardChart"></canvas>
          <div id="chartPlaceholder" class="chart-placeholder">
            <i class="fas fa-chart-pie"></i>
            <p>Your sustainable reward distribution will appear here</p>
          </div>
        </div>

        <!-- Gamma Simulator -->
        <div id="gamma-simulator" class="calculator-section gamma-simulator">
          <h3><i class="fas fa-chart-line"></i> Gamma Scale Simulator</h3>
          
          <div class="simulator-info enhanced-card">
            <p>
              <i class="fas fa-lightbulb"></i> See how the Gamma Scale Factor (γ) adjusts rewards based on community participation. 
              Move the sliders or enter values to see how reaching 50% participation unlocks higher rewards for everyone!
            </p>
          </div>
          
          <div class="slider-group">
            <div class="slider-container">
              <div class="slider-info">
                <div class="slider-info-label">
                  <span>Participating Tokens (P):</span>
                </div>
                <div class="slider-info-value">
                  <input type="number" id="whatIfParticipatingInput" class="value-input enhanced-input" 
                         value="100000000" min="1000000" max="500000000" step="1000000">
                  <span id="whatIfParticipatingValue" class="slider-value">100M</span>
                </div>
              </div>
              <input type="range" id="whatIfParticipating" min="1000000" max="500000000" step="1000000" value="100000000" 
                     class="enhanced-slider" oninput="updateWhatIfGamma()">
            </div>
            
            <div class="slider-container">
              <div class="slider-info">
                <div class="slider-info-label">
                  <span>Total Weighted Shares (∑WS):</span>
                </div>
                <div class="slider-info-value">
                  <input type="number" id="whatIfTotalWSInput" class="value-input enhanced-input" 
                         value="100000000" min="1000000" max="500000000" step="1000000">
                  <span id="whatIfTotalWSValue" class="slider-value">100M</span>
                </div>
              </div>
              <input type="range" id="whatIfTotalWS" min="1000000" max="500000000" step="1000000" value="100000000" 
                     class="enhanced-slider" oninput="updateWhatIfGamma()">
            </div>
          </div>
          
          <!-- Simulator Results -->
          <div class="simulator-results enhanced-card">
            <div class="result-grid">
              <div class="result-item">
                <div class="result-label">Gamma Scale Factor</div>
                <div id="gammaScaleResult" class="result-value">γ = 0.40</div>
              </div>
              <div class="result-item">
                <div class="result-label">Effective Distribution</div>
                <div id="effectiveDistribution" class="result-value">1,280,000 $REBL</div>
              </div>
              <div class="result-item">
                <div class="result-label">Reward Impact</div>
                <div id="rewardImpact" class="result-value">-60%</div>
              </div>
            </div>
          </div>
          
          <!-- Simulator Presets -->
          <div class="simulator-presets">
            <h4><i class="fas fa-flask"></i> Simulation Presets</h4>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
              <button onclick="setSimulatorPreset('current')" class="table-action-btn">
                <i class="fas fa-sync"></i> Current Settings
              </button>
              <button onclick="setSimulatorPreset('optimal')" class="table-action-btn" style="background: rgba(76, 175, 80, 0.1); color: #4CAF50; border-color: #4CAF50;">
                <i class="fas fa-bullseye"></i> 50% Participation
              </button>
              <button onclick="setSimulatorPreset('full')" class="table-action-btn" style="background: rgba(0, 255, 0, 0.1); color: #00ff00; border-color: #00ff00;">
                <i class="fas fa-rocket"></i> Full Gamma
              </button>
              <button onclick="setSimulatorPreset('worst')" class="table-action-btn" style="background: rgba(255, 51, 102, 0.1); color: var(--rebel-red); border-color: var(--rebel-red);">
                <i class="fas fa-exclamation-triangle"></i> Worst Case
              </button>
            </div>
          </div>
        </div>

        <!-- Formula Display -->
        <div class="calculator-section formula-display-section enhanced-card">
          <h3><i class="fas fa-calculator"></i> Sustainable Reward Formula</h3>
          <div class="formula-container">
            <div class="formula-main">
              Rewardᵢ = (WSᵢ / ∑WS) × 3,200,000 × γ
            </div>
            <div class="formula-component">
              γ = MAX(0.4, MIN(1, P/(0.5 × CS), CS/∑WS))
            </div>
          </div>
          <div class="formula-explanation">
            <div class="explanation-item">
              <strong>WSᵢ:</strong> Your Weighted Share = Σ[Token Batch × (1 + 0.07 × min(Age, 20))]
              <div class="input-hint">Each batch gets 7% weight boost per epoch (max 20 epochs)</div>
            </div>
            <div class="explanation-item">
              <strong>∑WS:</strong> Total Active Weighted Shares from all participants
              <div class="input-hint">Sum of all participants' weighted shares = Σ[Token Amount × (1 + 0.07 × min(Age, 20))]</div>
            </div>
            <div class="explanation-item">
              <strong>P:</strong> Total participating tokens in the epoch
              <div class="input-hint">Raw token amount (not weighted)</div>
            </div>
            <div class="explanation-item">
              <strong>CS:</strong> Circulating Supply (499,242,047)
              <div class="input-hint">Total $rebelinux tokens in circulation</div>
            </div>
            <div class="explanation-item">
              <strong>γ:</strong> Gamma Scale Factor - adjusts rewards based on participation and fairness
              <div class="input-hint">40% minimum, scales to 100% at 50%+ participation</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Calculator FAQ -->
    <section id="calculator-faq">
      <div class="container">
        <h2><i class="fas fa-question-circle"></i> Calculator FAQ</h2>
        <div class="content-card">
          <div class="faq-grid">
            <!-- FAQ items remain the same as in original -->
          </div>
        </div>
      </div>
    </section>

    <!-- Related Pages -->
    <section id="related-pages">
      <div class="container">
        <h2>Related Pages</h2>
        <div class="related-grid">
          <!-- Related cards remain the same as in original -->
        </div>
      </div>
    </section>
    
  </main>
  
  <!-- Footer will be inserted here by JavaScript -->
  <div id="footer-container"></div>
  
  <!-- JavaScript Includes -->
  <script src="js/includes.js"></script>
  <script src="js/common.js"></script>
  
  <!-- Enhanced Calculator JavaScript -->
  <script>
    // Enhanced Calculator JavaScript - Complete Implementation
    
    // Global variables
    let rewardChart = null;
    const CS = 499242047.00; // Circulating Supply
    const WERP = 3200000.00; // Weekly Epoch Reward Pool
    const K = 0.07; // Age bonus per epoch
    const MAX_AGE = 20; // Maximum age for bonus
    
    // State management
    let calculatorState = {
        autoUpdateParticipation: true,
        totalUserTokens: 0,
        totalUserWS: 0,
        currentParticipatingTokens: 100000000,
        currentTotalWS: 120000000,
        isCalculating: false,
        lastCalculationTime: 0,
        calculationDebounce: 500 // ms
    };
    
    // Initialize calculator on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing Enhanced REBL Calculator...');
        
        // Initialize with one empty row
        setTimeout(function() {
            addTokenBatch();
        }, 100);
        
        // Initialize participation settings
        initParticipationInputs();
        
        // Initialize chart placeholder
        setupChartPlaceholder();
        
        // Setup event listeners
        setupEventListeners();
        
        // Initialize presets
        initPresets();
        
        // Set target participation display
        updateTargetParticipation();
        
        // Show welcome message
        setTimeout(() => {
            showToast('Welcome to the Enhanced REBL Calculator! Try loading an example to get started.', 'info');
        }, 1500);
    });
    
    // ========== INITIALIZATION FUNCTIONS ==========
    
    function initParticipationInputs() {
        updateParticipationDisplay();
        updateWhatIfGamma();
    }
    
    function setupEventListeners() {
        // Setup input listeners with debounce
        setupDebouncedInputListeners();
        
        // Auto-update toggle
        const toggle = document.getElementById('autoUpdateToggle');
        if (toggle) {
            toggle.addEventListener('change', function() {
                calculatorState.autoUpdateParticipation = this.checked;
                updateParticipationUI();
                showToast('Auto-update ' + (this.checked ? 'enabled' : 'disabled'), 'info');
            });
        }
        
        // Add input validation
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('batch-amount') || e.target.classList.contains('batch-age')) {
                validateBatchInput(e.target);
            }
        });
    }
    
    function setupDebouncedInputListeners() {
        // Participating tokens
        const participatingInput = document.getElementById('participatingTokensInput');
        const participatingSlider = document.getElementById('participatingTokens');
        
        if (participatingInput && participatingSlider) {
            participatingInput.addEventListener('input', debounce(function() {
                let value = parseInt(this.value) || 0;
                value = clampValue(value, 1000000, 500000000);
                this.value = value;
                participatingSlider.value = value;
                calculatorState.currentParticipatingTokens = value;
                updateParticipationDisplay();
                scheduleCalculation();
            }, 300));
            
            participatingSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                participatingInput.value = value;
                calculatorState.currentParticipatingTokens = value;
                updateParticipationDisplay();
                scheduleCalculation();
            });
        }
        
        // Total WS
        const totalWSInput = document.getElementById('totalWSInput');
        const totalWSSlider = document.getElementById('totalWS');
        
        if (totalWSInput && totalWSSlider) {
            totalWSInput.addEventListener('input', debounce(function() {
                let value = parseInt(this.value) || 0;
                value = clampValue(value, 1000000, 500000000);
                this.value = value;
                totalWSSlider.value = value;
                calculatorState.currentTotalWS = value;
                updateParticipationDisplay();
                scheduleCalculation();
            }, 300));
            
            totalWSSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                totalWSInput.value = value;
                calculatorState.currentTotalWS = value;
                updateParticipationDisplay();
                scheduleCalculation();
            });
        }
        
        // What-if simulator
        const whatIfParticipatingInput = document.getElementById('whatIfParticipatingInput');
        const whatIfParticipatingSlider = document.getElementById('whatIfParticipating');
        const whatIfTotalWSInput = document.getElementById('whatIfTotalWSInput');
        const whatIfTotalWSSlider = document.getElementById('whatIfTotalWS');
        
        if (whatIfParticipatingInput && whatIfParticipatingSlider) {
            whatIfParticipatingInput.addEventListener('input', debounce(function() {
                let value = parseInt(this.value) || 0;
                value = clampValue(value, 1000000, 500000000);
                this.value = value;
                whatIfParticipatingSlider.value = value;
                updateWhatIfGamma();
            }, 300));
            
            whatIfParticipatingSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                whatIfParticipatingInput.value = value;
                updateWhatIfGamma();
            });
        }
        
        if (whatIfTotalWSInput && whatIfTotalWSSlider) {
            whatIfTotalWSInput.addEventListener('input', debounce(function() {
                let value = parseInt(this.value) || 0;
                value = clampValue(value, 1000000, 500000000);
                this.value = value;
                whatIfTotalWSSlider.value = value;
                updateWhatIfGamma();
            }, 300));
            
            whatIfTotalWSSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                whatIfTotalWSInput.value = value;
                updateWhatIfGamma();
            });
        }
    }
    
    function initPresets() {
        // Set target participation display
        updateTargetParticipation();
    }
    
    // ========== UTILITY FUNCTIONS ==========
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function clampValue(value, min, max) {
        return Math.max(min, Math.min(max, value));
    }
    
    function validateBatchInput(input) {
        const row = input.closest('tr');
        const amountInput = row.querySelector('.batch-amount');
        const ageInput = row.querySelector('.batch-age');
        
        let amount = parseFloat(amountInput.value) || 0;
        let age = parseFloat(ageInput.value) || 0;
        
        // Clamp values
        amount = clampValue(amount, 0, 1000000000);
        age = clampValue(age, 0, 20);
        
        // Update inputs
        amountInput.value = amount;
        ageInput.value = age;
        
        // Validate age with amount
        if (amount === 0 && age > 0) {
            ageInput.value = 0;
            showToast('Age requires non-zero tokens', 'warning');
        }
        
        // Update calculations
        updateRowCalculations(input);
    }
    
    function scheduleCalculation() {
        if (!calculatorState.isCalculating) {
            calculatorState.isCalculating = true;
            setTimeout(() => {
                calculateRewards();
                calculatorState.isCalculating = false;
            }, calculatorState.calculationDebounce);
        }
    }
    
    // ========== TOKEN BATCH FUNCTIONS ==========
    
    function addTokenBatch(amount = '', age = '') {
        const table = document.querySelector('#token-batches-table tbody');
        if (!table) return;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="number" class="batch-amount enhanced-input" value="${amount}" placeholder="Amount" 
                       min="0" max="1000000000" step="1000">
            </td>
            <td>
                <input type="number" class="batch-age enhanced-input" value="${age}" placeholder="Age" 
                       min="0" max="20" step="1">
            </td>
            <td class="batch-factor">1.00</td>
            <td class="batch-ws">0</td>
            <td>
                <button onclick="removeTokenBatch(this)" class="enhanced-btn secondary small">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        table.appendChild(row);
        
        // Add input listeners
        const amountInput = row.querySelector('.batch-amount');
        const ageInput = row.querySelector('.batch-age');
        
        amountInput.addEventListener('input', function() {
            validateBatchInput(this);
        });
        
        ageInput.addEventListener('input', function() {
            validateBatchInput(this);
        });
        
        if (amount || age) {
            setTimeout(() => updateRowCalculations(amountInput), 10);
        }
        
        // Animate in
        animateElementIn(row);
        
        // Update user totals
        updateUserTotals();
    }
    
    function removeTokenBatch(button) {
        const row = button.closest('tr');
        if (row) {
            animateElementOut(row, () => {
                row.remove();
                updateUserTotals();
                scheduleCalculation();
                
                // Add empty row if all are removed
                const table = document.querySelector('#token-batches-table tbody');
                if (table && table.children.length === 0) {
                    addTokenBatch();
                }
            });
        }
    }
    
    function clearTokenBatches() {
        const table = document.querySelector('#token-batches-table tbody');
        const rows = table.querySelectorAll('tr');
        
        if (rows.length === 0) return;
        
        if (!confirm('Are you sure you want to clear all token batches?')) {
            return;
        }
        
        // Animate removal
        rows.forEach((row, index) => {
            setTimeout(() => {
                animateElementOut(row, () => row.remove());
            }, index * 50);
        });
        
        // Add empty row after animation
        setTimeout(() => {
            addTokenBatch();
            calculatorState.totalUserTokens = 0;
            calculatorState.totalUserWS = 0;
            updateParticipationUI();
            
            const resultElement = document.getElementById('reward-result');
            if (resultElement) {
                resultElement.style.display = 'none';
            }
            hideChart();
            showToast('All token batches cleared', 'info');
        }, rows.length * 50 + 300);
    }
    
    function updateRowCalculations(input) {
        const row = input.closest('tr');
        if (!row) return;
        
        const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
        const age = parseFloat(row.querySelector('.batch-age').value) || 0;
        
        // Calculate weight factor
        const weightFactor = 1 + (K * Math.min(age, MAX_AGE));
        
        // Calculate weighted share
        const weightedShare = amount * weightFactor;
        
        // Update display
        const factorCell = row.querySelector('.batch-factor');
        const wsCell = row.querySelector('.batch-ws');
        
        if (factorCell) {
            factorCell.textContent = weightFactor.toFixed(2);
            factorCell.style.color = weightFactor > 1 ? 'var(--rebel-gold)' : '#ffffff';
            factorCell.style.fontWeight = weightFactor > 1 ? 'bold' : 'normal';
        }
        
        if (wsCell) {
            wsCell.textContent = formatNumber(weightedShare, true);
            wsCell.style.color = 'var(--rebel-red)';
            wsCell.style.fontWeight = 'bold';
        }
        
        // Update user totals
        updateUserTotals();
        
        // Schedule calculation
        scheduleCalculation();
    }
    
    function updateUserTotals() {
        const rows = document.querySelectorAll('#token-batches-table tbody tr');
        let totalTokens = 0;
        let totalWS = 0;
        
        rows.forEach(row => {
            const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
            const ws = parseFloat(row.querySelector('.batch-ws').textContent.replace(/,/g, '')) || 0;
            
            totalTokens += amount;
            totalWS += ws;
        });
        
        calculatorState.totalUserTokens = totalTokens;
        calculatorState.totalUserWS = totalWS;
        
        // Update UI if auto-update is enabled
        if (calculatorState.autoUpdateParticipation) {
            updateParticipationUI();
        }
        
        // Update user stats display
        updateUserStatsDisplay(totalTokens, totalWS);
        
        // Update WS estimation
        estimateTotalWS();
    }
    
    function updateUserStatsDisplay(totalTokens, totalWS) {
        const yourTokens = document.getElementById('yourTokens');
        const yourWS = document.getElementById('yourWS');
        const avgBonus = document.getElementById('avgBonus');
        
        if (yourTokens) yourTokens.textContent = formatNumber(totalTokens);
        if (yourWS) yourWS.textContent = formatNumber(totalWS, true);
        
        if (avgBonus) {
            const bonus = totalTokens > 0 ? (totalWS / totalTokens).toFixed(2) : '1.00';
            avgBonus.textContent = `${bonus}x`;
            
            // Color code
            if (bonus >= 2.0) {
                avgBonus.style.color = '#4CAF50';
            } else if (bonus >= 1.5) {
                avgBonus.style.color = '#FFC107';
            } else {
                avgBonus.style.color = '#ffffff';
            }
        }
    }
    
    // ========== WS ESTIMATION FUNCTIONS ==========
    
    function estimateTotalWS() {
        if (!calculatorState.autoUpdateParticipation) return;
        
        const userTokens = calculatorState.totalUserTokens;
        const userWS = calculatorState.totalUserWS;
        
        if (userTokens === 0) {
            // Default values when no tokens
            calculatorState.currentParticipatingTokens = 100000000;
            calculatorState.currentTotalWS = 120000000;
        } else {
            // Calculate user's average bonus
            const userAvgBonus = userTokens > 0 ? (userWS / userTokens) : 1;
            
            // Estimate WS multiplier based on user's age bonus
            let wsMultiplier;
            if (userAvgBonus >= 2.0) {
                wsMultiplier = 2.0;
            } else if (userAvgBonus >= 1.5) {
                wsMultiplier = 1.7;
            } else if (userAvgBonus >= 1.2) {
                wsMultiplier = 1.4;
            } else {
                wsMultiplier = 1.2;
            }
            
            // Estimate total WS
            const estimatedTotalWS = Math.max(userWS * 1.2, calculatorState.currentParticipatingTokens * wsMultiplier);
            
            // Update state
            calculatorState.currentTotalWS = Math.min(500000000, estimatedTotalWS);
            
            // Update estimated multiplier display
            const estimatedMultiplier = document.getElementById('estimatedMultiplier');
            if (estimatedMultiplier) {
                estimatedMultiplier.textContent = `${wsMultiplier.toFixed(1)}x`;
            }
        }
        
        // Update UI
        updateParticipationDisplay();
    }
    
    // ========== PARTICIPATION FUNCTIONS ==========
    
    function calculateGammaScale(P, totalWS) {
        // γ = MAX(0.4, MIN(1, P/(0.5 × CS), CS/∑WS))
        
        const participationTerm = P / (0.5 * CS);
        const inflationCap = CS / totalWS;
        const minTerm = Math.min(1, participationTerm, inflationCap);
        const gamma = Math.max(0.4, minTerm);
        
        return {
            gamma: gamma,
            participationTerm: participationTerm,
            inflationCap: inflationCap,
            minTerm: minTerm
        };
    }
    
    function updateParticipationUI() {
        const participatingSlider = document.getElementById('participatingTokens');
        const totalWSSlider = document.getElementById('totalWS');
        const participatingInput = document.getElementById('participatingTokensInput');
        const totalWSInput = document.getElementById('totalWSInput');
        
        if (!participatingSlider || !totalWSSlider || !participatingInput || !totalWSInput) return;
        
        const isAuto = calculatorState.autoUpdateParticipation;
        
        // Update input states
        participatingSlider.disabled = isAuto;
        totalWSSlider.disabled = isAuto;
        participatingInput.disabled = isAuto;
        totalWSInput.disabled = isAuto;
        
        // Update slider values based on user's tokens
        if (isAuto) {
            const userTokens = calculatorState.totalUserTokens;
            
            if (userTokens === 0) {
                // Default values
                calculatorState.currentParticipatingTokens = 100000000;
            } else {
                // Estimate other participants
                const userShare = userTokens / CS;
                let otherMultiplier;
                
                if (userShare >= 0.01) {
                    otherMultiplier = 3;
                } else if (userShare >= 0.001) {
                    otherMultiplier = 10;
                } else {
                    otherMultiplier = 50;
                }
                
                const estimatedOtherTokens = Math.min(CS - userTokens, userTokens * otherMultiplier);
                calculatorState.currentParticipatingTokens = Math.min(
                    CS,
                    Math.max(userTokens * 2, userTokens + estimatedOtherTokens, 10000000)
                );
            }
            
            // Estimate total WS
            estimateTotalWS();
            
            // Update UI
            participatingSlider.value = calculatorState.currentParticipatingTokens;
            participatingInput.value = calculatorState.currentParticipatingTokens;
            totalWSSlider.value = calculatorState.currentTotalWS;
            totalWSInput.value = calculatorState.currentTotalWS;
        }
        
        // Update displays
        updateParticipationDisplay();
    }
    
    function updateParticipationDisplay() {
        // Update value displays
        updateValueDisplay('participatingTokensValue', calculatorState.currentParticipatingTokens);
        updateValueDisplay('totalWSValue', calculatorState.currentTotalWS);
        
        // Update slider stats
        updateSliderStats();
        
        // Calculate and update gamma
        const gammaData = calculateGammaScale(calculatorState.currentParticipatingTokens, calculatorState.currentTotalWS);
        updateGammaDisplay(gammaData);
    }
    
    function updateValueDisplay(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = formatNumber(value);
        }
    }
    
    function updateSliderStats() {
        const yourTokenShare = document.getElementById('yourTokenShare');
        const yourWSShare = document.getElementById('yourWSShare');
        const wsMultiplierCurrent = document.getElementById('wsMultiplierCurrent');
        
        if (yourTokenShare && calculatorState.currentParticipatingTokens > 0) {
            const share = (calculatorState.totalUserTokens / calculatorState.currentParticipatingTokens * 100).toFixed(1);
            yourTokenShare.textContent = `${share}%`;
        }
        
        if (yourWSShare && calculatorState.currentTotalWS > 0) {
            const share = (calculatorState.totalUserWS / calculatorState.currentTotalWS * 100).toFixed(1);
            yourWSShare.textContent = `${share}%`;
        }
        
        if (wsMultiplierCurrent && calculatorState.currentParticipatingTokens > 0) {
            const multiplier = (calculatorState.currentTotalWS / calculatorState.currentParticipatingTokens).toFixed(2);
            wsMultiplierCurrent.textContent = `${multiplier}x`;
        }
    }
    
    function updateGammaDisplay(gammaData) {
        const gamma = gammaData.gamma;
        
        // Update gamma value displays
        const gammaValue = document.getElementById('gammaValue');
        const gammaValueDisplay = document.getElementById('gammaValueDisplay');
        
        if (gammaValue) gammaValue.textContent = gamma.toFixed(2);
        if (gammaValueDisplay) gammaValueDisplay.textContent = gamma.toFixed(2);
        
        // Color code
        const gammaColor = getGammaColor(gamma);
        if (gammaValue) gammaValue.style.color = gammaColor;
        if (gammaValueDisplay) gammaValueDisplay.style.color = gammaColor;
        
        // Update marker position
        updateGammaMarker(gamma);
        
        // Update insight
        updateGammaInsight(gamma);
    }
    
    function updateGammaMarker(gamma) {
        const marker = document.getElementById('gammaMarker');
        if (marker) {
            // Convert gamma (0.4 to 1.0) to percentage (40% to 100%)
            const position = 40 + (gamma - 0.4) * (100 / 0.6);
            marker.style.left = `${Math.min(100, Math.max(0, position))}%`;
        }
    }
    
    function updateGammaInsight(gamma) {
        const insightElement = document.getElementById('gammaInsight');
        if (!insightElement) return;
        
        let insightText = '';
        let insightClass = '';
        
        if (gamma >= 1) {
            insightText = 'Gamma Scale is at maximum! 100% of weekly pool is being distributed.';
            insightClass = 'success';
        } else if (gamma >= 0.8) {
            insightText = 'Excellent participation! Close to unlocking maximum rewards.';
            insightClass = 'success';
        } else if (gamma >= 0.6) {
            insightText = 'Good participation level. Rewards are scaling up with community activity.';
            insightClass = 'info';
        } else if (gamma > 0.4) {
            insightText = 'Low participation. Increase participating tokens to unlock higher rewards.';
            insightClass = 'warning';
        } else {
            insightText = 'Minimum gamma scale (40%). Significant room for improvement in participation.';
            insightClass = 'error';
        }
        
        insightElement.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>${insightText}</span>
        `;
        insightElement.className = `gamma-insight ${insightClass}`;
    }
    
    function updateTargetParticipation() {
        const targetElement = document.getElementById('targetParticipating');
        if (targetElement) {
            const target = (0.5 * CS);
            targetElement.textContent = formatNumber(target);
        }
    }
    
    // ========== REWARD CALCULATION ==========
    
    function calculateRewards() {
        // Prevent rapid calculations
        if (calculatorState.isCalculating) {
            return;
        }
        
        calculatorState.isCalculating = true;
        
        // Show loading state
        const calculateButton = document.getElementById('calculateButton');
        if (calculateButton) {
            calculateButton.classList.add('loading');
            calculateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CALCULATING...';
        }
        
        setTimeout(() => {
            try {
                // Get user's token batches
                const rows = document.querySelectorAll('#token-batches-table tbody tr');
                let userWS = 0;
                let totalAmount = 0;
                const batchData = [];
                
                rows.forEach(row => {
                    const amount = parseFloat(row.querySelector('.batch-amount').value) || 0;
                    const ws = parseFloat(row.querySelector('.batch-ws').textContent.replace(/,/g, '')) || 0;
                    
                    userWS += ws;
                    totalAmount += amount;
                    
                    if (amount > 0) {
                        batchData.push({
                            amount: amount,
                            ws: ws
                        });
                    }
                });
                
                // Get participation data
                const participatingTokens = calculatorState.currentParticipatingTokens;
                const totalWS = calculatorState.currentTotalWS;
                
                // Validate data
                if (userWS <= 0 || batchData.length === 0) {
                    showNoDataMessage();
                    calculatorState.isCalculating = false;
                    return;
                }
                
                // Calculate gamma
                const gammaData = calculateGammaScale(participatingTokens, totalWS);
                const gamma = gammaData.gamma;
                
                // Calculate rewards
                const userShare = totalWS > 0 ? (userWS / totalWS) : 0;
                const userReward = userShare * WERP * gamma;
                const effectivePool = WERP * gamma;
                
                // Calculate breakdown
                const baseReward = userShare * WERP; // Without gamma
                const gammaEffect = userReward - baseReward;
                const gammaImpact = ((userReward / baseReward - 1) * 100).toFixed(1);
                
                // Age bonus contribution
                const ageBonusContribution = calculatorState.totalUserTokens > 0 ? 
                    ((userWS / calculatorState.totalUserTokens - 1) * 100).toFixed(1) : '0.0';
                
                // Display results
                displayEnhancedResults({
                    userReward: userReward,
                    userWS: userWS,
                    totalWS: totalWS,
                    userShare: userShare,
                    gamma: gamma,
                    effectivePool: effectivePool,
                    baseReward: baseReward,
                    gammaEffect: gammaEffect,
                    gammaImpact: gammaImpact,
                    ageBonusContribution: ageBonusContribution,
                    participatingTokens: participatingTokens,
                    batchData: batchData
                });
                
                // Update chart
                updateChart(batchData, userWS);
                
                // Show success toast
                showToast('Rewards calculated successfully!', 'success');
                
            } catch (error) {
                console.error('Calculation error:', error);
                showToast('Error calculating rewards. Please check your inputs.', 'error');
            } finally {
                // Restore button
                if (calculateButton) {
                    calculateButton.classList.remove('loading');
                    calculateButton.innerHTML = '<i class="fas fa-calculator"></i> CALCULATE SUSTAINABLE REWARDS';
                }
                
                calculatorState.isCalculating = false;
            }
        }, 800); // Simulate calculation delay
    }
    
    function showNoDataMessage() {
        const resultElement = document.getElementById('reward-result');
        if (resultElement) {
            resultElement.style.display = 'block';
            resultElement.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-calculator" style="font-size: 48px; color: var(--color-text-muted); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--rebel-gold); margin-bottom: 10px;">No Token Data</h3>
                    <p style="color: var(--color-text-secondary); margin-bottom: 20px;">
                        Please enter your token batches to calculate rewards.
                    </p>
                    <button onclick="loadExampleCase('starter')" class="enhanced-btn secondary">
                        <i class="fas fa-user-graduate"></i> Load Starter Example
                    </button>
                </div>
            `;
        }
        hideChart();
    }
    
    function displayEnhancedResults(data) {
        const resultElement = document.getElementById('reward-result');
        if (!resultElement) return;
        
        resultElement.style.display = 'block';
        resultElement.innerHTML = `
            <div class="result-summary">
                <h3><i class="fas fa-award"></i> Your Weekly Reward</h3>
                <div class="main-reward">${formatNumber(data.userReward, true)} $REBL</div>
                
                <div class="breakdown-section">
                    <h4><i class="fas fa-chart-pie"></i> Reward Breakdown</h4>
                    <div class="breakdown-grid">
                        <div class="breakdown-item">
                            <span class="label">Base Share</span>
                            <span class="value">${formatNumber(data.baseReward, true)} $REBL</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="label">Age Bonus</span>
                            <span class="value positive">+${data.ageBonusContribution}%</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="label">Gamma Effect</span>
                            <span class="value ${data.gammaEffect > 0 ? 'positive' : 'negative'}">
                                ${data.gammaEffect > 0 ? '+' : ''}${formatNumber(data.gammaEffect, true)} $REBL
                            </span>
                        </div>
                        <div class="breakdown-item">
                            <span class="label">Gamma Impact</span>
                            <span class="value ${data.gammaImpact > 0 ? 'positive' : 'negative'}">
                                ${data.gammaImpact > 0 ? '+' : ''}${data.gammaImpact}%
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="details-section">
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Your Weighted Share</div>
                            <div class="detail-value">${formatNumber(data.userWS, true)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Active WS</div>
                            <div class="detail-value">${formatNumber(data.totalWS)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Your Pool Share</div>
                            <div class="detail-value">${(data.userShare * 100).toFixed(4)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gamma Scale (γ)</div>
                            <div class="detail-value" style="color: ${getGammaColor(data.gamma)}">${data.gamma.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="projections-section">
                    <h4><i class="fas fa-calendar-alt"></i> Projections</h4>
                    <div class="projections-grid">
                        <div class="projection-item">
                            <div class="projection-label">Monthly (approx.)</div>
                            <div class="projection-value">${formatNumber(data.userReward * 4.33, true)} $REBL</div>
                        </div>
                        <div class="projection-item">
                            <div class="projection-label">Annual (approx.)</div>
                            <div class="projection-value">${formatNumber(data.userReward * 52, true)} $REBL</div>
                        </div>
                    </div>
                    <p class="disclaimer">
                        <i class="fas fa-info-circle"></i> Projections assume consistent participation levels
                    </p>
                </div>
                
                <div class="insights-section">
                    <h4><i class="fas fa-lightbulb"></i> Insights</h4>
                    <div class="insight ${data.gamma >= 1 ? 'success' : data.gamma >= 0.8 ? 'info' : 'warning'}">
                        <i class="fas ${data.gamma >= 1 ? 'fa-check-circle' : data.gamma >= 0.8 ? 'fa-info-circle' : 'fa-exclamation-triangle'}"></i>
                        <span>${getGammaInsightText(data.gamma, data.participatingTokens)}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    function getGammaInsightText(gamma, participatingTokens) {
        const target = 0.5 * CS;
        const currentPercentage = (participatingTokens / CS * 100).toFixed(1);
        
        if (gamma >= 1) {
            return `Perfect participation! You're earning full rewards (${currentPercentage}% of CS participating).`;
        } else if (gamma >= 0.8) {
            const needed = ((target - participatingTokens) / 1000000).toFixed(1);
            return `Great participation! Just ${needed}M more tokens needed for full gamma.`;
        } else if (gamma >= 0.6) {
            const needed = ((target - participatingTokens) / 1000000).toFixed(1);
            return `Good progress! ${needed}M more tokens needed to reach optimal rewards.`;
        } else {
            const needed = ((target - participatingTokens) / 1000000).toFixed(1);
            return `Encourage participation! ${needed}M more tokens needed for optimal rewards.`;
        }
    }
    
    // ========== CHART FUNCTIONS ==========
    
    function setupChartPlaceholder() {
        const chartPlaceholder = document.getElementById('chartPlaceholder');
        const canvas = document.getElementById('rewardChart');
        
        if (chartPlaceholder) chartPlaceholder.style.display = 'flex';
        if (canvas) canvas.style.display = 'none';
    }
    
    function hideChart() {
        const chartPlaceholder = document.getElementById('chartPlaceholder');
        const canvas = document.getElementById('rewardChart');
        
        if (chartPlaceholder) chartPlaceholder.style.display = 'flex';
        if (canvas) canvas.style.display = 'none';
        
        if (rewardChart) {
            rewardChart.destroy();
            rewardChart = null;
        }
    }
    
    function updateChart(batchData, totalUserWS) {
        const ctx = document.getElementById('rewardChart');
        if (!ctx) return;
        
        const chartPlaceholder = document.getElementById('chartPlaceholder');
        const canvas = document.getElementById('rewardChart');
        
        if (chartPlaceholder) chartPlaceholder.style.display = 'none';
        if (canvas) canvas.style.display = 'block';
        
        // Destroy existing chart
        if (rewardChart) rewardChart.destroy();
        
        // Prepare data
        const labels = batchData.map((batch, index) => `Batch ${index + 1}`);
        const data = batchData.map(batch => batch.ws);
        
        // Create gradient
        const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(255, 51, 102, 0.8)');
        gradient.addColorStop(1, 'rgba(212, 167, 106, 0.8)');
        
        // Create chart
        rewardChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(255, 51, 102, 0.8)',
                        'rgba(255, 204, 0, 0.8)',
                        'rgba(0, 170, 255, 0.8)',
                        'rgba(156, 39, 176, 0.8)',
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(255, 152, 0, 0.8)',
                        'rgba(33, 150, 243, 0.8)',
                        'rgba(233, 30, 99, 0.8)'
                    ],
                    borderColor: 'rgba(0, 0, 0, 0.3)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'white',
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: 'var(--rebel-gold)',
                        bodyColor: 'white',
                        callbacks: {
                            label: function(context) {
                                const percentage = ((context.raw / totalUserWS) * 100).toFixed(1);
                                return `${context.label}: ${formatNumber(context.raw, true)} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1000
                },
                cutout: '60%'
            }
        });
    }
    
    // ========== WHAT-IF SIMULATOR ==========
    
    function updateWhatIfGamma() {
        const participating = parseInt(document.getElementById('whatIfParticipating').value) || 100000000;
        const totalWS = parseInt(document.getElementById('whatIfTotalWS').value) || 100000000;
        
        // Update displays
        updateValueDisplay('whatIfParticipatingValue', participating);
        updateValueDisplay('whatIfTotalWSValue', totalWS);
        
        // Calculate gamma
        const gammaData = calculateGammaScale(participating, totalWS);
        const gamma = gammaData.gamma;
        
        // Update gamma result
        const gammaResult = document.getElementById('gammaScaleResult');
        if (gammaResult) {
            gammaResult.textContent = `γ = ${gamma.toFixed(2)}`;
            gammaResult.style.color = getGammaColor(gamma);
        }
        
        // Update effective distribution
        const effectiveDistribution = WERP * gamma;
        const effectiveElement = document.getElementById('effectiveDistribution');
        if (effectiveElement) {
            effectiveElement.textContent = `${formatNumber(effectiveDistribution)} $REBL`;
        }
        
        // Update reward impact
        const rewardImpact = document.getElementById('rewardImpact');
        if (rewardImpact) {
            const impact = ((gamma - 1) * 100).toFixed(0);
            rewardImpact.textContent = `${impact > 0 ? '+' : ''}${impact}%`;
            rewardImpact.style.color = gamma >= 1 ? '#4CAF50' : '#ff3366';
        }
        
        // Update what-if marker
        const marker = document.getElementById('whatIfGammaMarker');
        if (marker) {
            const position = 40 + (gamma - 0.4) * (100 / 0.6);
            marker.style.left = `${Math.min(100, Math.max(0, position))}%`;
        }
    }
    
    // ========== PRESET FUNCTIONS ==========
    
    function loadExampleCase(type) {
        clearTokenBatches();
        
        setTimeout(() => {
            switch(type) {
                case 'starter':
                    addTokenBatch('50000', '3');
                    addTokenBatch('100000', '8');
                    addTokenBatch('25000', '1');
                    break;
                case 'investor':
                    addTokenBatch('500000', '5');
                    addTokenBatch('1000000', '10');
                    addTokenBatch('750000', '15');
                    addTokenBatch('250000', '2');
                    break;
                case 'whale':
                    addTokenBatch('2000000', '8');
                    addTokenBatch('3000000', '12');
                    addTokenBatch('5000000', '18');
                    addTokenBatch('1000000', '20');
                    addTokenBatch('500000', '6');
                    break;
            }
            
            showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} example loaded`, 'success');
            
            // Enable auto-update
            calculatorState.autoUpdateParticipation = true;
            const toggle = document.getElementById('autoUpdateToggle');
            if (toggle) toggle.checked = true;
            updateParticipationUI();
            
            // Calculate after delay
            setTimeout(() => calculateRewards(), 1000);
        }, 300);
    }
    
    function loadPreset(presetName) {
        clearTokenBatches();
        
        setTimeout(() => {
            const presets = {
                'new-investor': [
                    { amount: '500000', age: '0' },
                    { amount: '250000', age: '2' }
                ],
                'active-trader': [
                    { amount: '1000000', age: '5' },
                    { amount: '500000', age: '8' },
                    { amount: '250000', age: '12' }
                ],
                'long-term-holder': [
                    { amount: '2000000', age: '15' },
                    { amount: '1500000', age: '18' },
                    { amount: '500000', age: '20' }
                ],
                'portfolio-diversified': [
                    { amount: '750000', age: '3' },
                    { amount: '750000', age: '7' },
                    { amount: '750000', age: '10' },
                    { amount: '750000', age: '15' }
                ]
            };
            
            if (presets[presetName]) {
                presets[presetName].forEach(batch => {
                    addTokenBatch(batch.amount, batch.age);
                });
                
                showToast(`${presetName.replace('-', ' ')} preset loaded`, 'success');
                
                // Enable auto-update
                calculatorState.autoUpdateParticipation = true;
                const toggle = document.getElementById('autoUpdateToggle');
                if (toggle) toggle.checked = true;
                updateParticipationUI();
                
                // Calculate after delay
                setTimeout(() => calculateRewards(), 1000);
            }
        }, 300);
    }
    
    function setParticipationPreset(type) {
        let participating, totalWS;
        
        switch(type) {
            case 'low':
                participating = 100000000; // 20% CS
                totalWS = participating * 1.3;
                break;
            case 'medium':
                participating = 175000000; // 35% CS
                totalWS = participating * 1.5;
                break;
            case 'high':
                participating = 250000000; // 50% CS
                totalWS = participating * 1.7;
                break;
            case 'optimal':
                participating = 300000000; // 60% CS
                totalWS = participating * 2.0;
                break;
            default:
                return;
        }
        
        // Update state
        calculatorState.currentParticipatingTokens = participating;
        calculatorState.currentTotalWS = totalWS;
        
        // Update UI
        document.getElementById('participatingTokensInput').value = participating;
        document.getElementById('participatingTokens').value = participating;
        document.getElementById('totalWSInput').value = totalWS;
        document.getElementById('totalWS').value = totalWS;
        
        // Update display and calculate
        updateParticipationDisplay();
        scheduleCalculation();
        
        showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} participation preset applied`, 'info');
    }
    
    function setSimulatorPreset(type) {
        let participating, totalWS;
        
        switch(type) {
            case 'current':
                participating = calculatorState.currentParticipatingTokens;
                totalWS = calculatorState.currentTotalWS;
                break;
            case 'optimal':
                participating = 250000000; // 50% CS
                totalWS = participating * 1.7;
                break;
            case 'full':
                participating = 400000000; // High participation
                totalWS = participating * 2.4;
                break;
            case 'worst':
                participating = 50000000; // Low participation
                totalWS = participating * 1.1;
                break;
            default:
                return;
        }
        
        // Update simulator
        document.getElementById('whatIfParticipatingInput').value = participating;
        document.getElementById('whatIfParticipating').value = participating;
        document.getElementById('whatIfTotalWSInput').value = totalWS;
        document.getElementById('whatIfTotalWS').value = totalWS;
        
        // Update display
        updateWhatIfGamma();
        
        showToast(`Simulator: ${type} scenario`, 'info');
    }
    
    // ========== HELPER FUNCTIONS ==========
    
    function formatNumber(num, showDecimals = false) {
        if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return '0';
        
        if (num >= 1000000000) {
            return (num / 1000000000).toFixed(showDecimals ? 2 : 1) + 'B';
        } else if (num >= 1000000) {
            return (num / 1000000).toFixed(showDecimals ? 2 : 1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(showDecimals ? 2 : 1) + 'K';
        }
        
        return num.toLocaleString(undefined, {
            minimumFractionDigits: showDecimals ? 2 : 0,
            maximumFractionDigits: showDecimals ? 2 : 0
        });
    }
    
    function getGammaColor(gamma) {
        if (gamma >= 1) return '#00ff00';
        if (gamma >= 0.8) return '#ffff00';
        if (gamma >= 0.6) return '#ffcc00';
        if (gamma >= 0.4) return '#ff9900';
        return '#ff3366';
    }
    
    function showToast(message, type = 'info') {
        // Remove existing toasts
        document.querySelectorAll('.enhanced-toast').forEach(toast => toast.remove());
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = `enhanced-toast ${type}`;
        
        // Get icon
        let icon;
        switch(type) {
            case 'success': icon = 'check-circle'; break;
            case 'warning': icon = 'exclamation-triangle'; break;
            case 'error': icon = 'times-circle'; break;
            default: icon = 'info-circle';
        }
        
        toast.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function animateElementIn(element) {
        element.style.opacity = '0';
        element.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
            element.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, 10);
    }
    
    function animateElementOut(element, callback) {
        element.style.transform = 'translateX(-100%)';
        element.style.opacity = '0';
        
        setTimeout(() => {
            if (callback) callback();
        }, 300);
    }
    
    function scrollToSection(sectionId) {
        const element = document.getElementById(sectionId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    // ========== PUBLIC FUNCTIONS ==========
    
    // Expose necessary functions to global scope
    window.addTokenBatch = addTokenBatch;
    window.removeTokenBatch = removeTokenBatch;
    window.clearTokenBatches = clearTokenBatches;
    window.updateRowCalculations = updateRowCalculations;
    window.updateParticipation = function() {
        const participatingSlider = document.getElementById('participatingTokens');
        const totalWSSlider = document.getElementById('totalWS');
        
        if (participatingSlider && totalWSSlider) {
            calculatorState.currentParticipatingTokens = parseInt(participatingSlider.value) || 100000000;
            calculatorState.currentTotalWS = parseInt(totalWSSlider.value) || 100000000;
            
            const participatingInput = document.getElementById('participatingTokensInput');
            const totalWSInput = document.getElementById('totalWSInput');
            
            if (participatingInput) participatingInput.value = calculatorState.currentParticipatingTokens;
            if (totalWSInput) totalWSInput.value = calculatorState.currentTotalWS;
            
            updateParticipationDisplay();
            scheduleCalculation();
        }
    };
    window.calculateRewards = calculateRewards;
    window.updateWhatIfGamma = updateWhatIfGamma;
    window.loadExampleCase = loadExampleCase;
    window.loadPreset = loadPreset;
    window.setParticipationPreset = setParticipationPreset;
    window.setSimulatorPreset = setSimulatorPreset;
    window.estimateTotalWS = estimateTotalWS;
    window.scrollToSection = scrollToSection;
  </script>
</body>
</html>
